<!DOCTYPE html>
<html lang="zh-Hans">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="胡博靖" />


    
    


<meta name="description" content="计算机|软件|开发|研发|通信工程|互联网|编程|程序员|代码|C++|Java|Android">
<meta property="og:type" content="website">
<meta property="og:title" content="胡博靖的技术博客">
<meta property="og:url" content="http://hubojing.github.io/index.html">
<meta property="og:site_name" content="胡博靖的技术博客">
<meta property="og:description" content="计算机|软件|开发|研发|通信工程|互联网|编程|程序员|代码|C++|Java|Android">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="胡博靖的技术博客">
<meta name="twitter:description" content="计算机|软件|开发|研发|通信工程|互联网|编程|程序员|代码|C++|Java|Android">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="胡博靖的技术博客" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.png">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">





    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/green/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">


    <style> .article { opacity: 0;} </style>


<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>胡博靖的技术博客</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: false,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: true
    }
</script>


    <script>
        yiliaConfig.jquery_ui = [true, "//cdn.bootcss.com/jqueryui/1.10.4/jquery-ui.min.js", "//cdn.bootcss.com/jqueryui/1.10.4/css/jquery-ui.min.css"];
    </script>



    <script> yiliaConfig.rootUrl = "\/";</script>





<link rel="stylesheet" href="http://disqus.hubojing.me/iDisqus.min.css">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1498247776150&amp;di=a1fdc0869f65da377118893dfe708f5e&amp;imgtype=0&amp;src=http%3A%2F%2Fimg5.duitang.com%2Fuploads%2Fitem%2F201508%2F24%2F20150824132210_HjBJC.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">胡博靖</a></h1>
        </hgroup>

        
        <p class="header-subtitle">小清新IT旅程|为中华崛起读书</p>
        <p class="post-count">已写85.3k字</p>
        

        
            <form id="search-form">
            <input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload="false" />
            <i class="fa fa-times" onclick="resetSearch()"></i>
            </form>
            <div id="local-search-result"></div>
            <p class='no-result'>No results found <i class='fa fa-spinner fa-pulse'></i></p>
        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/categories/互联网">互联网</a></li>
                        
                            <li><a href="/categories/通信工程">通信工程</a></li>
                        
                            <li><a href="/categories/杂谈">杂谈</a></li>
                        
                            <li><a href="/about/">关于</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:hubojing@outlook.com" title="Email"></a>
                            
                                <a class="fa GitHub" href="https://github.com/hubojing" title="GitHub"></a>
                            
                                <a class="fa RSS" href="/atom.xml" title="RSS"></a>
                            
                                <a class="fa CSDN" href="http://blog.csdn.net/hubojing/" title="CSDN"></a>
                            
                                <a class="fa 网易云音乐" href="http://music.163.com/#/user/home?id=92203594" title="网易云音乐"></a>
                            
                                <a class="fa QQ" href="http://wpa.qq.com/msgrd?v=3&uin=417797456&site=qq&menu=yes" title="QQ"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/1602/">1602</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DigitalOcean/">DigitalOcean</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flash/">Flash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Github/">Github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HOOPS-3D/">HOOPS 3D</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ListControl/">ListControl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MFC/">MFC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MFC-多线程/">MFC 多线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PPT动画/">PPT动画</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TreeControl/">TreeControl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/XML/">XML</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/">android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/blog/">blog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/eclipse/">eclipse</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/idea/">idea</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/markdown/">markdown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/matlab/">matlab</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/photoshop/">photoshop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/socket/">socket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/主题/">主题</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/优化/">优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/函数/">函数</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/创意/">创意</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/动画/">动画</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/单片机/">单片机</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/域名/">域名</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/多说/">多说</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/密码锁/">密码锁</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/嵌入式系统/">嵌入式系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/思维/">思维</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/教程/">教程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数字信号处理/">数字信号处理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据结构/">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/显示技术/">显示技术</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/服务器/">服务器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/杂谈/">杂谈</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/树/">树</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/爬虫/">爬虫</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/病毒/">病毒</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/矩阵键盘/">矩阵键盘</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/竞赛/">竞赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/说明/">说明</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/问题/">问题</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="http://moxfive.xyz/">MOxFIVE</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://blog.iiwo.vip/">小忆</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://blog.iwangyu.cn/">WangYu</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://ursb.me/">Airing</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://txiner.top/">Hundred</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://www.ersaijun.cn/">二赛君</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://blog.yeqianfeng.me/">太阳尚远</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://blog.qiujinfeng.com/">邱锦锋</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://www.ibertinelym.com/">李玉明</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://blog.waydrow.com/">Waydrow</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://qqdie.com/">Jrotty</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://blog.just666.cn/">Shawn</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://theask.cn/">该问</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://www.sfantree.com/">水番林</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://hsmouc.com/">空白</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://www.61mon.com/">刘毅</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://www.pokerboy.cn/">柚子鬼</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://zcheng.ren/">ZeeCoder</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://www.zcmol.cn/">早茶月光</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://rebootcat.com/">Linux之路</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://www.townwang.com/">王振镇</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://shawnzeng.com/">Shawnzeng</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://blog.52itstyle.com/">小柒博客</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://frankchen.xyz/">不正经数据科学家</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://nolongerwait.com/">秦简</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://xiaowiba.com/">小尾巴</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://sopuy.com/">sopuy</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://itruke.com/">技术宅男子</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">人生如编程，自顶向下，逐步求精。</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">胡博靖</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1498247776150&amp;di=a1fdc0869f65da377118893dfe708f5e&amp;imgtype=0&amp;src=http%3A%2F%2Fimg5.duitang.com%2Fuploads%2Fitem%2F201508%2F24%2F20150824132210_HjBJC.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">胡博靖</a></h1>
            </hgroup>
            
            <p class="header-subtitle">小清新IT旅程|为中华崛起读书</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/categories/互联网">互联网</a></li>
                
                    <li><a href="/categories/通信工程">通信工程</a></li>
                
                    <li><a href="/categories/杂谈">杂谈</a></li>
                
                    <li><a href="/about/">关于</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:hubojing@outlook.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/hubojing" title="GitHub"></a>
                            
                                <a class="fa RSS" target="_blank" href="/atom.xml" title="RSS"></a>
                            
                                <a class="fa CSDN" target="_blank" href="http://blog.csdn.net/hubojing/" title="CSDN"></a>
                            
                                <a class="fa 网易云音乐" target="_blank" href="http://music.163.com/#/user/home?id=92203594" title="网易云音乐"></a>
                            
                                <a class="fa QQ" target="_blank" href="http://wpa.qq.com/msgrd?v=3&uin=417797456&site=qq&menu=yes" title="QQ"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap">
  
    <article id="post-MFC网页分析程序" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/06/14/MFC网页分析程序/" class="article-date">
      <time datetime="2017-06-14T14:45:38.000Z" itemprop="datePublished">2017-06-14</time>
</a>

 
    <a href="/2017/06/14/MFC网页分析程序/#comments" title="查看评论">
        <i class="fa fa-comments-o" aria-hidden="true"></i>
        <span class="count-comment"></span>
        
        
            <span class="disqus-comment-count" data-disqus-identifier="2017/06/14/MFC网页分析程序/"></span>
        
    </a>

    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/14/MFC网页分析程序/">MFC网页分析程序</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>&lt;div align=&quot;left&quot;&gt;
&lt;img src=&quot;http://img.blog.csdn.net/20170802003740628?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast&quot; width=&quot;300&quot; height=&quot;180&quot; style=&quot;float:right;&quot;/&gt;</p>
<p>开发一个网页分析程序，可以抓取特定网页的内容，加以分析之后将结果保存至数据库。</p>
<p>半成品出炉
&lt;/div&gt;</p>
<p>&lt;!--more--&gt;</p>
<p>网页分析程序具体要求描述如下：
1.使用http技术获取一个博客的首页http://blog.csdn.net/jiangsheng
2.分析这个网页的内容，从中找到博客中每一篇文章的链接。
3.通过这些链接，获取文章的正文网页，从内容中提取文章的标题和文章的内容。
4.将文章的标题与内容分别保存至数据库。
5.布局要求：提供一个列表框和一个多行文本框。列表框中显示从数据库中获取的文章标题列表；当点击列表框中的某一篇文章时，在文本框中显示该文章的内容。</p>
<h1 id="获取源码">获取源码</h1>
<p>首先实现获取网页源码的功能：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CGetWebDlg::OnGetweb() </div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add your control notification handler code here</span></div><div class="line">	CInternetSession session;</div><div class="line">	CHttpFile *file = <span class="literal">NULL</span>; </div><div class="line">	CString strURL = <span class="string">"http://blog.csdn.net/jiangsheng"</span>;</div><div class="line">    CString strHtml = <span class="number">_</span>T(<span class="string">""</span>); <span class="comment">//存放网页数据</span></div><div class="line"> <span class="keyword">try</span></div><div class="line"> &#123; </div><div class="line">  </div><div class="line">	file =(CHttpFile*)session.OpenURL(strURL);</div><div class="line"> &#125; </div><div class="line"><span class="keyword">catch</span>(CInternetException *m_pException)</div><div class="line"> &#123; </div><div class="line">	file = <span class="literal">NULL</span>;</div><div class="line">	m_pException-&gt;m_dwError;</div><div class="line">	m_pException-&gt;Delete();</div><div class="line">	session.Close();</div><div class="line">	MessageBox(<span class="string">"网络连接错误"</span>,<span class="string">"提示"</span>);</div><div class="line">	<span class="keyword">return</span>;</div><div class="line"> &#125;</div><div class="line">	CString strLine;</div><div class="line">	<span class="keyword">char</span> sRecived[<span class="number">1024</span>];</div><div class="line">	<span class="keyword">if</span> (file != <span class="literal">NULL</span>) </div><div class="line">	&#123;</div><div class="line">		<span class="keyword">while</span>(file-&gt;ReadString((LPTSTR)sRecived,<span class="number">1024</span>)!=<span class="literal">NULL</span>) </div><div class="line">		&#123;</div><div class="line">			strHtml += sRecived; </div><div class="line">		&#125;</div><div class="line"> &#125;</div><div class="line">	<span class="keyword">else</span></div><div class="line">	&#123; </div><div class="line">		AfxMessageBox(<span class="number">_</span>T(<span class="string">"失败！"</span>));</div><div class="line">	&#125;</div><div class="line">        session.Close();</div><div class="line">		file-&gt;Close();</div><div class="line">		<span class="keyword">delete</span> file; </div><div class="line">		file = <span class="literal">NULL</span>;</div><div class="line"></div><div class="line">		ConvertUtf8ToGBK(strHtml);<span class="comment">//源码转换</span></div><div class="line">		(<span class="keyword">this</span>-&gt;GetDlgItem(IDC_EDITCONTENT))-&gt;SetWindowText(strHtml);</div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="编码问题">编码问题</h2>
<p>注意网页编码问题，因此需要格式转换，编写一个函数：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span>  <span class="title">ConvertUtf8ToGBK</span><span class="params">(CString &amp;strUtf8)</span></span></div><div class="line">&#123;</div><div class="line">          </div><div class="line">    <span class="keyword">int</span> len=MultiByteToWideChar(CP_UTF8, <span class="number">0</span>, (LPCTSTR)strUtf8, <span class="number">-1</span>, <span class="literal">NULL</span>,<span class="number">0</span>);</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> * wszGBK = <span class="keyword">new</span> <span class="keyword">unsigned</span> <span class="keyword">short</span>[len+<span class="number">1</span>];</div><div class="line">	<span class="built_in">memset</span>(wszGBK, <span class="number">0</span>, len * <span class="number">2</span> + <span class="number">2</span>);</div><div class="line">	MultiByteToWideChar(CP_UTF8, <span class="number">0</span>, (LPCTSTR)strUtf8, <span class="number">-1</span>, (LPWSTR)wszGBK, len);</div><div class="line"> </div><div class="line">	len = WideCharToMultiByte(CP_ACP, <span class="number">0</span>, (LPCWSTR)wszGBK, <span class="number">-1</span>, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>); </div><div class="line">	<span class="keyword">char</span> *szGBK=<span class="keyword">new</span> <span class="keyword">char</span>[len + <span class="number">1</span>];</div><div class="line">	<span class="built_in">memset</span>(szGBK, <span class="number">0</span>, len + <span class="number">1</span>);</div><div class="line">	WideCharToMultiByte (CP_ACP, <span class="number">0</span>, (LPCWSTR)wszGBK, <span class="number">-1</span>, szGBK, len, <span class="literal">NULL</span>,<span class="literal">NULL</span>);</div><div class="line"> </div><div class="line">	strUtf8 = szGBK;</div><div class="line">	 <span class="keyword">delete</span>[] szGBK;</div><div class="line">	 <span class="keyword">delete</span>[] wszGBK;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20170614232311302?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="显示源码"></p>
<p>有些类似网页爬虫的感觉。</p>
<p>由于我刚开始是用VC6.0创建项目，现在用VS2013打开，因此，提示报错：
error MSB8031: Building an MFC project for a non-Unicode character set is deprecated. You must change the project property to Unicode or download an additional library. See http://go.microsoft.com/fwlink/p/?LinkId=286820 for more information.</p>
<p>解决：用于多字节字符编码 (MBCS) 的 MFC 库 (DLL) 不再包含于 Visual Studio 中，但是可用作插件，可以在任何装有 Visual Studio Professional、Visual Studio Premium 或 Visual Studio Ultimate 的计算机上下载和安装。下载地址：https://www.microsoft.com/zh-cn/download/details.aspx?id=40770</p>
<h1 id="解析">解析</h1>
<p><s>为了接下来的操作，我去学正则表达式了……</s>
还是学习html解析库 htmlcxx
<a href="http://htmlcxx.sourceforge.net/" target="_blank" rel="external">官方</a>
<a href="http://blog.csdn.net/youfangyuan/article/details/7816518" target="_blank" rel="external">HtmlCxx用户手册</a></p>
<h2 id="htmlcxx">HTMLCXX</h2>
<h3 id="下载htmlcxx库">下载htmlcxx库</h3>
<p>http://sourceforge.net/projects/htmlcxx/
并解压。</p>
<h3 id="编译">编译</h3>
<p>打开htmlcxx.vcproj，右键属性，配置属性-C/C++-代码生成-运行库：多线程调试 DLL (/ MDd)进行编译。编译会报错，将
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> <span class="keyword">char</span> *signature = <span class="string">"﻿"</span>;</div></pre></td></tr></table></figure></p>
<p>改为
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> <span class="keyword">char</span> *signature = <span class="string">"﻿\xEF\xBB\xBF"</span>;</div></pre></td></tr></table></figure></p>
<p>即可编译成功。</p>
<h3 id="导入">导入</h3>
<p>把生成的htmlcxx.lib和html文件夹拷贝到所需的工程中。即：
在所开发项目文件夹中，新建”htmlcxx“文件，里面添加两个子文件夹”lib“和”include“。将编译好的htmlcxx.lib拷贝到lib文件夹，将html文件夹中所有的.h头文件和ParserSax.tcc添加到include文件夹。添加库文件htmlcxx.lib到项目中，具体说来：</p>
<blockquote>
<p>在VS工程中，添加c/c++工程中外部头文件及库的基本步骤：
1、添加工程的头文件目录：工程---属性---配置属性---c/c++---常规---附加包含目录：加上头文件存放目录。
2、添加文件引用的lib静态库路径：工程---属性---配置属性---链接器---常规---附加库目录：加上lib文件存放目录。
然后添加工程引用的lib文件名：工程---属性---配置属性---链接器---输入---附加依赖项：加上lib文件名。
3、添加工程引用的dll动态库：把引用的dll放到工程的可执行文件所在的目录下。
注意：第一步可以不用，直接在工程里加入动态库的头文件，在使用代码处引用这个头文件。</p>
</blockquote>
<p>所开发的项目的头文件中添加以下内容：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"htmlcxx/include/ParserDom.h"</span></span></div><div class="line"> </div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> htmlcxx;</div><div class="line"> </div><div class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib,<span class="meta-string">"htmlcxx.lib"</span>)</span></div></pre></td></tr></table></figure></p>
<h3 id="测试">测试</h3>
<p>官方测试代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;htmlcxx/html/ParserDom.h&gt;</span></span></div><div class="line"> ...</div><div class="line"> </div><div class="line"> <span class="comment">//Parse some html code</span></div><div class="line"> <span class="built_in">string</span> html = <span class="string">"&lt;html&gt;&lt;body&gt;hey&lt;/body&gt;&lt;/html&gt;"</span>;</div><div class="line"> HTML::ParserDom parser;</div><div class="line"> tree&lt;HTML::Node&gt; dom = parser.parseTree(html);</div><div class="line"> </div><div class="line"> <span class="comment">//Print whole DOM tree</span></div><div class="line"> <span class="built_in">cout</span> &lt;&lt; dom &lt;&lt; <span class="built_in">endl</span>;</div><div class="line"> </div><div class="line"> <span class="comment">//Dump all links in the tree</span></div><div class="line"> tree&lt;HTML::Node&gt;::iterator it = dom.begin();</div><div class="line"> tree&lt;HTML::Node&gt;::iterator end = dom.end();</div><div class="line"> <span class="keyword">for</span> (; it != end; ++it)</div><div class="line"> &#123;</div><div class="line"> 	<span class="keyword">if</span> (it-&gt;tagName() == <span class="string">"A"</span>)</div><div class="line"> 	&#123;</div><div class="line"> 		it-&gt;parseAttributes();</div><div class="line"> 		<span class="built_in">cout</span> &lt;&lt; it-&gt;attributes(<span class="string">"href"</span>);</div><div class="line"> 	&#125;</div><div class="line"> &#125;</div><div class="line"> </div><div class="line"> <span class="comment">//Dump all text of the document</span></div><div class="line"> it = dom.begin();</div><div class="line"> end = dom.end();</div><div class="line"> <span class="keyword">for</span> (; it != end; ++it)</div><div class="line"> &#123;</div><div class="line"> 	<span class="keyword">if</span> ((!it-&gt;isTag()) &amp;&amp; (!it-&gt;isComment()))</div><div class="line"> 	&#123;</div><div class="line"> 		<span class="built_in">cout</span> &lt;&lt; it-&gt;text();</div><div class="line"> 	&#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>然而……</p>
<p><img src="http://img.blog.csdn.net/20170709011136986?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="报错1"></p>
<p>加入#include&quot;iostream&quot;头文件即可。</p>
<p><img src="http://img.blog.csdn.net/20170709011240176?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="报错2"></p>
<p>修改为：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (it-&gt;tagName() == <span class="string">"A"</span>)</div><div class="line">			&#123;</div><div class="line">				it-&gt;parseAttributes();</div><div class="line">				<span class="built_in">std</span>::pair&lt;<span class="keyword">bool</span>, <span class="built_in">std</span>::<span class="built_in">string</span>&gt; pa = it-&gt;attribute(<span class="string">"href"</span>);</div><div class="line">				<span class="built_in">cout</span> &lt;&lt; pa.second;</div><div class="line">			&#125;</div></pre></td></tr></table></figure></p>
<p>编译通过。</p>
<p>还有其他的库也可以用，比如<a href="http://blog.csdn.net/lanuage/article/details/72825878" target="_blank" rel="external">使用MSHTML解析HTML页面</a>
比如<a href="http://www.oschina.net/question/565065_67992" target="_blank" rel="external">LIBXML2库使用指南</a>
还可以用正则表达式写库……</p>
<p>突然发现 原来的计划里有COM组件 XML和HTML 数据库访问技术
都没怎么接触过  补补补
在填坑的路上不能止步…</p>
<h3 id="参考">参考</h3>
<p><a href="http://www.cnblogs.com/striver-zhu/p/4451781.html" target="_blank" rel="external">C++ 使用Htmlcxx解析Html内容(VS编译库文件)</a>
<a href="http://blog.csdn.net/farcall/article/details/20378475" target="_blank" rel="external">html与xml解析库htmlcxx使用过程中的若干问题及解决方案</a>
<a href="http://www.cnblogs.com/learning-lzj2014/p/3928346.html" target="_blank" rel="external">c++ hmtlcxx 学习之旅</a></p>
<h1 id="解析原理参考">解析原理参考</h1>
<p><a href="http://blog.csdn.net/xuesong123/article/details/8637159" target="_blank" rel="external">html解析器工作原理</a>
<a href="http://www.cnblogs.com/lhb25/p/how-browsers-work.html" target="_blank" rel="external">深入解析浏览器的幕后工作原理</a></p>
<h2 id="mshtml">MSHTML</h2>
<p>因为最近用过MSXML，就试试MSHTML。学有余力的话，htmlcxx之后还是想玩一下…
https://msdn.microsoft.com/en-us/library/aa741317(v=vs.85).aspx
<a href="http://blog.csdn.net/jiangsheng/article/details/3793" target="_blank" rel="external">蒋晟-关于MSHTML</a>
https://msdn.microsoft.com/zh-cn/library/mshtml(v=vs.110).aspx</p>
<h3 id="mshtml导入">MSHTML导入</h3>
<p>系统中自带了mshtml，和msxml一样，在C盘windows/system32中可找到。</p>
<p><a href="http://blog.csdn.net/mimica247706624/article/details/6128239" target="_blank" rel="external">如何导入</a></p>
<p>先看MSDN……
<a href="https://msdn.microsoft.com/en-us/library/aa741317%28v=vs.85%29.aspx?f=255&amp;MSPPError=-2147217396" target="_blank" rel="external">MSDN-MSHTML</a></p>
<p>再看各种搜集的文章
http://bbs.csdn.net/topics/330214041
http://www.cnblogs.com/speedmancs/archive/2010/08/11/1797442.html
http://blog.csdn.net/jinyaba/article/details/17097323
https://social.msdn.microsoft.com/Search/zh-CN?query=MSHTML&amp;pgArea=header&amp;emptyWatermark=true&amp;ac=4#refinementChanges=117&amp;pageNumber=1&amp;showMore=false
https://wenku.baidu.com/view/d571abc4ec3a87c24028c4bb.html
http://www.codeguru.com/cpp/i-n/ieprogram/article.php/c4385/Lightweight-HTML-Parsing-Using-MSHTML.htm
http://www.yesky.com/403/1938403.shtml?qq-pf-to=pcqq.c2c
http://www.bianceng.cn/Programming/vc/201411/46771.htm
https://wenku.baidu.com/view/299bba4a336c1eb91a375df5.html</p>
<p><s>思路：下载源码和获取链接是两个独立函数，会被多次调用。先获取首页源码，div id=&quot;archive_list&quot; 遍历该div获取各月份归档链接，再使用多线程（48个线程？？？）进入每个归档链接里下载源码，获取源码中h1的每篇文章标题,保存到数据库。</s></p>
<p>虽然有两种方法，一种通过归档获得链接，一种通过翻页获得链接，但根据本html特点，明显通过翻页要简洁方便一些，因为翻页的链接是有规律的，可通过循环搞定。每页5篇直接获得正文链接，比从归档获得少一层。<s>两核4个逻辑处理器，所以是开2个线程好还是4个好呢……</s></p>
<p>获取每篇正文链接，下载源码，解析得正文，保存到数据库。最后从数据库中提取标题和正文显示到对应窗口(使用ADO)。</p>
<h3 id="解析过程">解析过程</h3>
<h4 id="创建">创建</h4>
<p>1.使用CoCreateInstance创建一个接口
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">HRESULT hr = CoCreateInstance(<span class="name">CLSID_HTMLDocument</span>, NULL, CLSCTX_INPROC_SERVER, IID_IHTMLDocument2, (<span class="name">void**</span>)<span class="symbol">&amp;pDoc</span>)<span class="comment">;</span></div></pre></td></tr></table></figure></p>
<p>2.创建一个COM中的数组，将HTML字符串写到数组中</p>
<p>a）SafeArrayCreateVector:函数用来创建一个对应的数组结构。函数有三个参数，第一个参数表示数组中元素类型，一般给VT_VARIANT表示它是一个自动类型，第二个参数数组元素起始位置的下标，对于VC来说，数组元素总是从0开始，所以这个位置一般给0，第三个参数是数组的维数，在这将它作为一个字符数组，所以是一个一维数组。
b）SafeArrayAccessData：允许用户操作这个数组，在需要读写这个数组时都需要调用这个函数，以便获取这个数组的操作权。它有两个参数，第一个参数是数组变量，第二个参数是一个输出参数，当调用这个函数成功，会提供一个缓冲区，操作这个缓冲区就相当于操作了这个数组。
c）SafeArrayUnaccessData：每当操作数组完成时需要调用这个函数，函数与SafeArrayAccessData配套使用，用来回收这个权限，并使对数组的操作生效。</p>
<ol start="3">
<li>调用接口的write方法，将接口与HTML字符串绑定
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">SAFEARRAY* psa = SafeArrayCreateVector(VT_VARIANT, <span class="number">0</span>, <span class="number">1</span>);</div><div class="line">VARIANT *param;</div><div class="line"><span class="keyword">bstr_t</span> bsData = (LPCTSTR)strHtml;</div><div class="line">hr = SafeArrayAccessData(psa, (LPVOID*)&amp;param);</div><div class="line">param-&gt;vt = VT_BSTR;</div><div class="line">param-&gt;bstrVal = (BSTR)bsData;</div><div class="line">hr = pDoc-&gt;write(psa);</div><div class="line">hr = SafeArrayUnaccessData(psa);</div></pre></td></tr></table></figure></li>
</ol>
<p>目标：</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;span <span class="class"><span class="keyword">class</span></span>=<span class="string">"link_title"</span>&gt;<span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/jiangsheng/article/details/9870241"</span>&gt;</span></span></div><div class="line">选择剪贴板格式顺序            </div><div class="line"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">&lt;<span class="regexp">/span&gt;</span></div></pre></td></tr></table></figure></p>
<p>整个 &lt;span&gt;/&lt;/span&gt;  是元素， &lt;span&gt;  是标签，class是属性名，link_title是属性值，“选择剪贴板格式顺序”是文本。</p>
<h4 id="元素遍历">元素遍历</h4>
<p>至少两种方法：
法一：
获取了HTML文档的IID_IHTMLDocument2接口后，开始遍历：
1.get_all方法获取所有标签节点，这个函数通过一个输出参数输出IHTMLElementCollection类型的接口指针
2.用IHTMLElementCollection接口的get_length方法获取标签的总数量，据此写一个循环，在循环进行元素的遍历
3.循环中用IHTMLElementCollection接口的item方法进行迭代，获取各元素对应的IDispatch接口指针
4.调用IDispatch接口指针的QueryInterface方法生成对应的IHTMLElement接口。通过这个接口获取元素的各种信息</p>
<p>以下已能成功获取标题：
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">void CGetWebDlg::EnumElements(IHTMLDocument2* pDoc)</div><div class="line">&#123;</div><div class="line">	CComPtr&lt;IHTMLElementCollection&gt; pCollection<span class="comment">;</span></div><div class="line">	pDoc-&gt;get_all(&amp;pCollection)<span class="comment">;</span></div><div class="line">	if (NULL == pCollection)</div><div class="line">	&#123;</div><div class="line">		return<span class="comment">;</span></div><div class="line">	&#125;</div><div class="line">	VARIANT varName<span class="comment">;</span></div><div class="line">	CString strText<span class="comment">;</span></div><div class="line">	long len = <span class="number">0</span><span class="comment">;</span></div><div class="line">	pCollection-&gt;get_length(&amp;len)<span class="comment">;</span></div><div class="line">	for (int i = <span class="number">0</span><span class="comment">; i &lt; len; i++)</span></div><div class="line">	&#123;</div><div class="line">		varName.vt = VT_I4<span class="comment">;</span></div><div class="line">		varName.lVal = i<span class="comment">;</span></div><div class="line">		CComPtr&lt;IHTMLElement&gt; pElement<span class="comment">;</span></div><div class="line">		CComPtr&lt;IDispatch&gt; pDisp<span class="comment">;</span></div><div class="line">		pCollection-&gt;item(varName, varName, &amp;pDisp)<span class="comment">;</span></div><div class="line">		if (NULL == pDisp)</div><div class="line">		&#123;</div><div class="line">			continue<span class="comment">;</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		pDisp-&gt;QueryInterface(IID_IHTMLElement, (LPVOID*)&amp;pElement)<span class="comment">;</span></div><div class="line">		if (NULL != pElement)</div><div class="line">		&#123;</div><div class="line">			<span class="keyword">BSTR </span><span class="keyword">bstrClass;	</span></div><div class="line">			pElement-&gt;get_className(&amp;<span class="keyword">bstrClass);</span></div><div class="line">			CString strClass = _com_util::ConvertBSTRToString(<span class="keyword">bstrClass);</span></div><div class="line">			if (strClass.Compare(<span class="string">"link_title"</span>) == <span class="number">0</span>)</div><div class="line">			&#123;</div><div class="line">					<span class="keyword">BSTR </span><span class="keyword">bstrText </span>= NULL<span class="comment">;</span></div><div class="line">					pElement-&gt;get_innerText(&amp;<span class="keyword">bstrText);</span></div><div class="line">					strText = <span class="keyword">bstrText;</span></div><div class="line">					m_list.<span class="keyword">InsertItem(i, </span>strText)<span class="comment">;</span></div><div class="line">			&#125;			</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>法二：
利用IHTMLDocument2将字符串形式的HTML转换为DOM对象，利用IHTMLDocument3的getElementByTagName等方法来操作DOM对象。
以下已能成功获取标题：
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">	MSHTML:</span>:IHTMLDocument3Ptr pDoc3<span class="comment">;</span></div><div class="line"><span class="symbol">	 	MSHTML:</span>:IHTMLElementCollectionPtr pCollection<span class="comment">;</span></div><div class="line"><span class="symbol">	 	MSHTML:</span>:IHTMLElementPtr pElement<span class="comment">;</span></div><div class="line"></div><div class="line">pDoc3 = pDoc<span class="comment">;</span></div><div class="line">	pCollection = pDoc3-&gt;getElementsByTagName(L<span class="string">"span"</span>)<span class="comment">;</span></div><div class="line">	for (long i = <span class="number">0</span><span class="comment">; i &lt; pCollection-&gt;length; i++)</span></div><div class="line">	&#123;</div><div class="line">		pElement = pCollection-&gt;item(i, (long)<span class="number">0</span>)<span class="comment">;</span></div><div class="line">		if (pElement != NULL)</div><div class="line">		&#123;</div><div class="line">			<span class="keyword">BSTR </span><span class="keyword">bstrClass;</span></div><div class="line">			pElement-&gt;get_className(&amp;<span class="keyword">bstrClass);</span></div><div class="line">			CString strClass = _com_util::ConvertBSTRToString(<span class="keyword">bstrClass);</span></div><div class="line">			if (strClass.Compare(<span class="string">"link_title"</span>) == <span class="number">0</span>)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">BSTR </span><span class="keyword">bstrText </span>= NULL<span class="comment">;</span></div><div class="line">				pElement-&gt;get_innerText(&amp;<span class="keyword">bstrText);</span></div><div class="line">				CString strText = <span class="keyword">bstrText;</span></div><div class="line">				m_list.<span class="keyword">InsertItem(i, </span>strText)<span class="comment">;</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>其实两种方法大同小异，相较而言可能数据量大的话，法二效率高些吧。因为法一是直接遍历所有的元素寻找class相同的，而法二是先定位span，然后在span中找寻class。（getElementsByTagName只有IHTMLDocument3Ptr）</p>
<p><a href="http://blog.csdn.net/lanuage/article/details/72825878" target="_blank" rel="external">使用MSHTML解析HTML页面</a>
<a href="http://www.2cto.com/kf/201305/214730.html" target="_blank" rel="external">变体VARIANT</a>
MSDN-DOM	https://msdn.microsoft.com/en-us/library/ms766487(v=vs.85).aspx
<a href="http://www.360doc.com/content/12/0427/19/8006573_207099529.shtml" target="_blank" rel="external">使用MSHTML接口获取链接</a></p>
<p>晚上几个小时做完了一半，抵了之前一两个月。
数据库这块没来得及做，没加多线程，很多细节还得调。但比起之前心有余而力不足的感觉还是好多了。  学过msxml后，学习mshtml确实强一点，比一个月前完全不知道怎么下手好很多了。</p>
<p>今晚总算做出来个半成品
<img src="http://img.blog.csdn.net/20170802003740628?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="半成品"></p>
<p>To be continued...</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/互联网/">互联网</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MFC/">MFC</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/爬虫/">爬虫</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
	


  
  
</article>









  
    <article id="post-树状控件与列表控件交互以及XML的解析" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/07/20/树状控件与列表控件交互以及XML的解析/" class="article-date">
      <time datetime="2017-07-20T15:04:43.000Z" itemprop="datePublished">2017-07-20</time>
</a>

 
    <a href="/2017/07/20/树状控件与列表控件交互以及XML的解析/#comments" title="查看评论">
        <i class="fa fa-comments-o" aria-hidden="true"></i>
        <span class="count-comment"></span>
        
        
            <span class="disqus-comment-count" data-disqus-identifier="2017/07/20/树状控件与列表控件交互以及XML的解析/"></span>
        
    </a>

    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/20/树状控件与列表控件交互以及XML的解析/">树状控件与列表控件交互以及XML的解析</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>&lt;div align=&quot;left&quot;&gt;
&lt;img src=&quot;http://s8.51cto.com/wyfs02/M00/5B/67/wKioL1UI1-LRY-VkAADQ3snhmcU770.jpg&quot; width=&quot;300&quot; height=&quot;180&quot; style=&quot;float:right;&quot;/&gt;</p>
<p>300多M即将维持十天工作生活　　
突然多了500M  哪位好心人做事不留名？（真不是运营商续的哇）</p>
<p>&lt;/div&gt;</p>
<p>&lt;!--more--&gt;</p>
<h1 id="msdn参考">MSDN参考</h1>
<h2 id="msxml">MSXML</h2>
<p>MSXML API 历史记录 https://msdn.microsoft.com/zh-cn/library/ms762314(v=vs.85).aspx</p>
<p>有C++示例  感人肺腑</p>
<p>MSXML SDK 概述 https://msdn.microsoft.com/zh-cn/library/ms760399(v=vs.85).aspx</p>
<p><s>机翻水平已经不错了 虽然仔细看还是略扎心</s>
心扎穿了……机翻不如看英文系列</p>
<h2 id="treecontrol控件">TreeControl控件</h2>
<p>使用 CTreeCtrl https://msdn.microsoft.com/zh-cn/library/8ws6dh1y(v=vs.120).aspx</p>
<h2 id="listcontrol控件">ListControl控件</h2>
<p>使用 CListCtrl https://msdn.microsoft.com/zh-cn/library/cc468276(v=vs.71).aspx
创建列表控件 (List Control) https://msdn.microsoft.com/zh-cn/library/cc451545(v=vs.71).aspx</p>
<p>明明都是msdn，网页版就是亲切一些...</p>
<p>现有一个XML文档如下：
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;root&gt;</div><div class="line">	&lt;Node world = "生命"&gt;</div><div class="line">		&lt;Node animal = “动物"&gt;</div><div class="line">			&lt;Node aniname = "熊猫"&gt;</div><div class="line">			&lt;/Node&gt;</div><div class="line">			&lt;Node aniname = "兔子"&gt;</div><div class="line">			&lt;/Node&gt;</div><div class="line">		&lt;/Node&gt;</div><div class="line">		&lt;Node plant = "植物"&gt;</div><div class="line">			&lt;Node planame = "仙人掌"&gt;</div><div class="line">			&lt;/Node&gt;</div><div class="line">			&lt;Node planame = "玫瑰"&gt;</div><div class="line">			&lt;/Node&gt;</div><div class="line">		&lt;/Node&gt;</div><div class="line">	&lt;/Node&gt;</div><div class="line">&lt;/root&gt;</div></pre></td></tr></table></figure></p>
<p>要求在树状控件上显示如下：
--root
----动物
----植物</p>
<p>在树状控件上点击“动物”，在列表控件上出现
1 熊猫
2 兔子</p>
<p>同理，点击“植物”，在列表控件上出现
1 仙人掌
2 玫瑰</p>
<h1 id="思维碰撞">思维碰撞</h1>
<p><s>之前的思路：先SelectedSingleNode(&quot;/Node/Node&quot;)，定位到动物这一层。然后获得该结点的属性即aniname，插入树状控件。接着指向其兄弟结点，将兄弟结点（植物）的属性同样插入树状控件。如果新插入结点，可能需递归（但都是在动物同层面）。</s>
<s>因为并没有将“熊猫”“兔子”插入树状控件，因此无法使用m_tree.GetChildItem(ht)获取。所以我想通过“动物”植物“的aniname和planame来反过来查找对应xml里的结点pNode（这里存在问题how to find it?遍历xml找同样的名字？Item能和node存在对应关系么）。找到后，只需GetChildNode之类获取孩子结点，再插入到列表控件中（也就是和列表控件交互实际是列表控件在和xml直接交互，树控件只起到选择某个item，对应到xml中）。</s>
<s>简单说来：选择树结点-&gt;获得该xml对应结点-&gt;获得每一个孩子结点-&gt;获得孩子结点的文本和其他路径属性-&gt;通过列表插入</s></p>
<p><s>就算是为树状控件和列表控件设置一个类或者一个结构，先要把xml所需的信息全部放入。毕竟投射到树状控件的结点并非全部结点，最重要的是<strong>列表控件所需结点不在树状控件中</strong>。那么添加删除时，对应的类或结构也应相应操作，是否繁琐。但感觉之前用树控件用错了，只是获取了文本，数据并没传入。</s></p>
<p>当连问题都表达不清楚时，说明很多东西压根就没懂。<s>明天好好看MSDN...还得看看DOM树</s></p>
<p>又过了一天。思路变为：为不直接操作XML，应创建一个结构体，利用MSXML解析XML将信息放入结构体中，在后续树状控件和列表控件操作时都调用该结构体而非XML。</p>
<p><s>所以当务之急是如何传数据给结构体，好像会用到std::map映射，</s>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~~<span class="built_in">std</span>::<span class="built_in">map</span>&lt;CString, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;信息&gt;&gt;~~</div></pre></td></tr></table></figure></p>
<p><s>学习下怎么用...</s></p>
<p><s>嗯……就说看起来没那么复杂才对………卡了几天的问题  明天终于可以实现这个demo</s> 还没实现 少立flag多做事...</p>
<p>前面那么多废话，其实说白了就是要<strong>自己生成一棵树</strong>，数据来源是xml，通过MSXML获得每个结点信息，自己生成的树中只包含所需要的xml片段信息，之后树控件根据指针来获得选择结点的孩子结点。
xml解析的最关键之处，就是如何将xml文件内容解析成内存中的可用、易用的程序数据---DOM(Document Object Model)树。DOM其实就是多叉树，每个节点只需知道自己的第一个子节点（first child）和下一个兄弟节点（next sibling），即可实现元素数据的解析。</p>
<p>想给脑袋植入MSDN芯片...</p>
<p>理一理六层结构：
map-&gt;分类节点-&gt;vector-&gt;n个小节点-&gt;结构体-&gt;xml</p>
<p>如果要求分类节点就一层，是完全OK的。但如果要求分类下面还需要小分类，这就很不ok了。换为
两个结构体：1）小节点结构体-&gt;xml
2)分类节点结构体-&gt;vector-&gt;1)
(比map还简单些...)</p>
<p>发现六层结构办不到时，仿佛多米诺骨牌立到最后几块，突然看到最开始的一段里有一块距离放远了……
但换成双结构体其实改动也没太多，又好像把那块出差错的给换了块适合长度的，整个链条还是能补完整的。
思维过山车  跌宕起伏</p>
<h1 id="方法记录">方法记录</h1>
<h2 id="元素遍历">元素遍历</h2>
<p>for循环取出每一个元素进行相应比较。(递归不如遍历)</p>
<h2 id="父对话框给自对话框传值">父对话框给自对话框传值</h2>
<p>父对话框 BookDlg  子对话框TitleDlg
在父对话框中 TitleDlg dlg(this);
在子对话框中 CBookDlg <em>parent = (CBookDlg</em>)GetParent();
然后就可以使用了：
CString text=pParent-&gt;m_sentence;
m_sentence是父对话框类的成员变量</p>
<h2 id="在子对话框显示图片">在子对话框显示图片</h2>
<p>给自对话框添加OnInitDlg()
添加OnPaint()
(记得加WM_ONPAINT消息)
在OnInitDlg中加载图片，在OnPanint()中重绘图片。（在初始化里重绘是不行的）</p>
<h2 id="vector">vector</h2>
<p>添加头文件#include &lt;vector&gt;
vector容器，std::vector&lt;类型*&gt; name;  push_back添加元素。
遍历元素使用迭代器iterator，for循环</p>
<h2 id="map">map</h2>
<p>添加头文件#include &lt;map&gt;
std::map&lt;CString, std::vector&lt;信息&gt;&gt;
一个CString对应一个vector。查询时也是先遍历（迭代器）再比较，it-&gt;first指代返回关键字，it-&gt;second指代数据。</p>
<h2 id="父子循环">父子循环</h2>
<p>父子循环遍历时避免使用相同的变量名。</p>
<h2 id="树控件相关">树控件相关</h2>
<h3 id="插入">插入</h3>
<p>m_tree.InsertItem((_bstr_t)variantValue, 1, 1, ht, TVI_LAST);
依次是：插入的数据，树前图标点击前，树前图标点击后，父节点，插在最后。</p>
<h2 id="列表控件相关">列表控件相关</h2>
<h3 id="在列表最后插入">在列表最后插入</h3>
<p>int iRow = m_list.GetItemCount();
m_list.InsertItem(iRow, text, 0);
text 插入的文本 0表示imagelist中的第一个图片
imagelist是由一幅幅image拼起来的长图列表</p>
<h2 id="xml操作">xml操作</h2>
<h3 id="取属性">取属性</h3>
<p>pNode-&gt;get_attributes(&amp;pAttrMap);
pAttrMap-&gt;get_item(0, &amp;pAttrItem);
pAttrItem-&gt;get_nodeTypedValue(&amp;VariantValue);</p>
<p>To be continued...</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/互联网/">互联网</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ListControl/">ListControl</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MFC/">MFC</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TreeControl/">TreeControl</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/XML/">XML</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
	


  
  
</article>









  
    <article id="post-树" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/07/23/树/" class="article-date">
      <time datetime="2017-07-23T13:16:43.000Z" itemprop="datePublished">2017-07-23</time>
</a>

 
    <a href="/2017/07/23/树/#comments" title="查看评论">
        <i class="fa fa-comments-o" aria-hidden="true"></i>
        <span class="count-comment"></span>
        
        
            <span class="disqus-comment-count" data-disqus-identifier="2017/07/23/树/"></span>
        
    </a>

    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/23/树/">树</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>&lt;div align=&quot;left&quot;&gt;
&lt;img src=&quot;http://images.cnitblog.com/i/609598/201404/072129507785920.jpg&quot; width=&quot;300&quot; height=&quot;180&quot; style=&quot;float:right;&quot;/&gt;</p>
<p>大热天敲代码与看书更配哦</p>
<p>&lt;/div&gt;</p>
<p>&lt;!--more--&gt;</p>
<p>伪代码。</p>
<h1 id="二叉树的链式存储结构">二叉树的链式存储结构</h1>
<p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> BiTNode&#123;</div><div class="line">	ElemType data;<span class="comment">//数据域</span></div><div class="line">	<span class="keyword">struct</span> BiTNode *lchild, *rchild;<span class="comment">//左、右孩子指针</span></div><div class="line">&#125;BiTNode, *BiTree;</div></pre></td></tr></table></figure></p>
<h1 id="二叉树的遍历">二叉树的遍历</h1>
<p>例：1
2      3
4       5
6</p>
<h2 id="先序遍历preorder">先序遍历（PreOrder）</h2>
<p>根-&gt;左-&gt;右
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">PreOrder</span><span class="params">(BiTree T)</span></span>&#123;</div><div class="line">	<span class="keyword">if</span> (T != <span class="literal">NULL</span>)&#123;</div><div class="line">		visit(T);<span class="comment">//访问根节点</span></div><div class="line">		PreOrder(T-&gt;lchild);<span class="comment">//递归遍历左子树</span></div><div class="line">		PreOrder(T-&gt;rchild);<span class="comment">//递归遍历右子树</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>124635</p>
<h2 id="中序遍历inorder">中序遍历（InOrder）</h2>
<p>左-&gt;根-&gt;右
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">InOrder</span><span class="params">(BiTree T)</span></span>&#123;</div><div class="line">	<span class="keyword">if</span> (T != <span class="literal">NULL</span>)&#123;</div><div class="line">		InOrder(T-&gt;lchild);<span class="comment">//递归遍历左子树</span></div><div class="line">		visit(T);<span class="comment">//访问根节点</span></div><div class="line">		InOrder(T-&gt;rchild);<span class="comment">//递归遍历右子树</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>264135</p>
<h2 id="后序遍历postorder">后序遍历（PostOrder）</h2>
<p>左-&gt;右-&gt;根
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">PostOrder</span><span class="params">(BiTree T)</span></span>&#123;</div><div class="line">	<span class="keyword">if</span> (T != <span class="literal">NULL</span>)</div><div class="line">	&#123;</div><div class="line">		PostOrder(T-&gt;lchild);<span class="comment">//递归遍历左子树</span></div><div class="line">		PostOrder(T-&gt;rchild);<span class="comment">//递归遍历右子树</span></div><div class="line">		visit(T);<span class="comment">//访问根节点</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>642531</p>
<p>时间复杂度都是O(n)，空间复杂度为O(n)。</p>
<h1 id="中序遍历的非递归算法">中序遍历的非递归算法</h1>
<p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">InOrder2</span><span class="params">(BiTree T)</span></span>&#123;</div><div class="line">	<span class="comment">//二叉树中序遍历的非递归算法，算法需要借助一个栈</span></div><div class="line">	InitStack(S);</div><div class="line">	BiTree p = T;				<span class="comment">//初始化栈；p是遍历指针</span></div><div class="line">	<span class="keyword">while</span> (p || !IsEmpty(S))&#123;		<span class="comment">//栈不空或p不空时循环</span></div><div class="line">		<span class="keyword">if</span> (p)&#123;						<span class="comment">//根指针进展，遍历左子树</span></div><div class="line">			Push(S, p);					<span class="comment">//每遇到非空二叉树先向左走</span></div><div class="line">			p = p-&gt;lchild;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span>&#123;						<span class="comment">//根指针退栈，访问根节点，遍历右子树</span></div><div class="line">			Pop(S, p); visit(p);		<span class="comment">//退栈，访问根节点</span></div><div class="line">			p = p-&gt;rchild;			<span class="comment">//再向右子树走</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="二叉树的层次遍历">二叉树的层次遍历</h1>
<p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">LevelOrder</span><span class="params">(BiTree T)</span></span>&#123;</div><div class="line">	InitQueue(Q);<span class="comment">//初始化辅助队列</span></div><div class="line">	BiTree p;</div><div class="line">	EnQueue(Q, T);<span class="comment">//将根结点入队</span></div><div class="line">	<span class="keyword">while</span> (!IsEmpty(Q))&#123;<span class="comment">//队列不空循环</span></div><div class="line">		DeQueue(Q, p);<span class="comment">//队头元素出队</span></div><div class="line">		visit(p);<span class="comment">//访问当前p所指向结点</span></div><div class="line">		<span class="keyword">if</span> (p-&gt;lchild != <span class="literal">NULL</span>)</div><div class="line">		&#123;</div><div class="line">			EnQueue(Q, p-&gt;lchild);<span class="comment">//左子树不空，则左子树入队列</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (p-&gt;rchild != <span class="literal">NULL</span>)</div><div class="line">		&#123;</div><div class="line">			EnQueue(Q, p-&gt;rchild);<span class="comment">//右子树不空，则右子树入队列</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="树的存储结构">树的存储结构</h1>
<h2 id="双亲表示法">双亲表示法</h2>
<p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_TREE_SIZE 100	<span class="comment">//树中最多结点数</span></span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span>&#123;		<span class="comment">//树的结点定义</span></div><div class="line">	ElemType data;	<span class="comment">//数据元素</span></div><div class="line">	<span class="keyword">int</span> parent;	<span class="comment">//双亲位置域</span></div><div class="line">&#125;PTNode;</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span>&#123;		<span class="comment">//树的类型定义</span></div><div class="line">	PTNode nodes[MAX_TREE_SIZE];	<span class="comment">//双亲表示</span></div><div class="line">	<span class="keyword">int</span> n;		<span class="comment">//结点数</span></div><div class="line">&#125;PTree;</div></pre></td></tr></table></figure></p>
<p>求结点的孩子时需遍历整个结构。</p>
<h2 id="孩子表示法">孩子表示法</h2>
<p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> CTNode	<span class="comment">//孩子结点</span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> child;</div><div class="line">	<span class="keyword">struct</span> CTNode *next;</div><div class="line">&#125;*ChildPtr;</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line">&#123;</div><div class="line">	TElemType data;</div><div class="line">	ChildPtr firstchild;<span class="comment">//孩子链表头指针</span></div><div class="line">&#125;CTBox;</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line">&#123;</div><div class="line">	CTBox nodes[MAX_TREE_SIZE];</div><div class="line">	<span class="keyword">int</span> n, r;	<span class="comment">//结点数和根的位置</span></div><div class="line">&#125;CTree;</div></pre></td></tr></table></figure></p>
<p>求结点的双亲时需遍历N个结点中孩子链表指针域所指向的N个孩子链表。</p>
<h2 id="孩子兄弟表示法二叉树表示法">孩子兄弟表示法（二叉树表示法）</h2>
<p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> CSNode</div><div class="line">&#123;</div><div class="line">	ElemType data;	<span class="comment">//数据域</span></div><div class="line">	<span class="keyword">struct</span> CSNode *firstchild, *nextsibling;	<span class="comment">//第一个孩子和右兄弟指针</span></div><div class="line">&#125;CSNode, *CSTree;</div></pre></td></tr></table></figure></p>
<p>易查找结点的孩子，若为每个结点增设一个parent域指向其父节点，则查找结点的父结点也很方便。</p>
<p>树转换为二叉树的规则：每个结点左指针指向它的第一个孩子结点，右指针指向它在树中的相邻兄弟结点，可表示为“左孩子右兄弟”。由于根节点没有兄弟，所以由树转换而得的二叉树没有右子树。</p>
<p>例：
<img src="http://img.blog.csdn.net/20160405115409687" alt="一颗具体的树">
<img src="http://img.blog.csdn.net/20160405121851681" alt="转换后"></p>
<h1 id="c实现">C++实现</h1>
<p>由于博主不允许转载，因此详见参考。
为防止程序一闪而过，在main程序末尾添加system(&quot;pause&quot;);使画面停留。</p>
<h1 id="参考">参考</h1>
<p>数据结构教材
<a href="http://blog.csdn.net/linux_ever/article/details/51063795" target="_blank" rel="external">数据结构与算法——普通树的定义与C++实现</a>
<a href="http://blog.csdn.net/jkay_wong/article/details/6635984" target="_blank" rel="external">C++树（兄弟孩子结构实现）</a>
<a href="http://www.educity.cn/develop/478944.html" target="_blank" rel="external">VC++ 树的孩子兄弟表示法</a>
<a href="http://blog.csdn.net/insistgogo/article/details/6876867" target="_blank" rel="external">使用C++ 和 孩子兄弟表示法实现树</a>
<a href="http://blog.csdn.net/htyurencaotang/article/details/7781920" target="_blank" rel="external">孩子兄弟表示法实现树</a></p>
<hr>
<p>最近更新频繁的原因如下：
上周
<img src="http://img.blog.csdn.net/20170723212235401?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="上周"></p>
<p>未来一周
<img src="http://img.blog.csdn.net/20170723212159371?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="未来一周"></p>
<p>热成熟透的咸鱼  不如宅着做咸鱼</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/互联网/">互联网</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/数据结构/">数据结构</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/树/">树</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
	


  
  
</article>









  
    <article id="post-求购" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/07/18/求购/" class="article-date">
      <time datetime="2017-07-18T14:55:44.000Z" itemprop="datePublished">2017-07-18</time>
</a>

 
    <a href="/2017/07/18/求购/#comments" title="查看评论">
        <i class="fa fa-comments-o" aria-hidden="true"></i>
        <span class="count-comment"></span>
        
        
            <span class="disqus-comment-count" data-disqus-identifier="2017/07/18/求购/"></span>
        
    </a>

    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/18/求购/">≧∇≦</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>&lt;div align=&quot;left&quot;&gt;
&lt;img src=&quot;http://b-ssl.duitang.com/uploads/item/201510/12/20151012094245_twKjA.jpeg&quot; width=&quot;300&quot; height=&quot;180&quot; style=&quot;float:right;&quot;/&gt;</p>
<p>&lt;/div&gt;</p>
<p>这贴适合又不适合卡吧老司机进来
　　
　　
　　
&lt;!--more--&gt;</p>
<p><strong>不是组装电脑！让你失望了[微笑]</strong></p>
<p>直连光猫
<img src="http://img.blog.csdn.net/20170722004202507?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="直连光猫"></p>
<p>连接路由器
<img src="http://img.blog.csdn.net/20170722004135465?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="路由器"></p>
<p>这还是最快的信道  100M的钱  10M的同等感受</p>
<p>1.求推路由器
100M光纤 家用 连Wifi设备还比较多 需跨墙
要求：性能好 性能好 性能好 性价比高</p>
<p>2.求推电视音响
要求：音质好 音质好 音质好 重低音强（低音炮！）
价格……当然性价比越高越好……价位……高中低各给一款参考？</p>
<p>能直接给京东链接最好了……</p>
<p>。。。。。。</p>
<p>之所以不去卡吧等土豪吧发帖，当然是  因为  穷</p>
<p>默默想起几年前的一首诗
三千预算进卡吧 加钱加到九万八 八核 E5 装上去 四路Titan抱回家
4K 屏幕组三屏 万元水冷温度压 固态硬盘装三块 硬盘内存使劲加 　
键鼠必花几千元 耳机手柄三千八 还有机箱六千元 红星炸弹劈劈啪</p>
<p>---华丽的分界线---</p>
<p>一天不能同时留2个Flag是真的
总有一个会打脸<br>
比如上一篇写的 今天说好写MSHTML例子的  结果今天先被MSXML弄昏了
昨晚去云村留Flag说早睡  总要做到一个吧
真的！我要早点睡觉！不过12点！！！</p>
<p>附上两张公司厕所励志图…………………………
<img src="http://img.blog.csdn.net/20170718232530408?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="1"></p>
<p><img src="http://img.blog.csdn.net/20170718232554242?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="2"></p>
<p>各位看到的大神们晚安~
我要做一只美丽的小菜鸟
⁄(⁄ ⁄•⁄ω⁄•⁄ ⁄)⁄</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/杂谈/">杂谈</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/杂谈/">杂谈</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
	


  
  
</article>









  
    <article id="post-一个MFC利用MSXML解析XML的最简例子" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/07/13/一个MFC利用MSXML解析XML的最简例子/" class="article-date">
      <time datetime="2017-07-13T13:14:26.000Z" itemprop="datePublished">2017-07-13</time>
</a>

 
    <a href="/2017/07/13/一个MFC利用MSXML解析XML的最简例子/#comments" title="查看评论">
        <i class="fa fa-comments-o" aria-hidden="true"></i>
        <span class="count-comment"></span>
        
        
            <span class="disqus-comment-count" data-disqus-identifier="2017/07/13/一个MFC利用MSXML解析XML的最简例子/"></span>
        
    </a>

    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/13/一个MFC利用MSXML解析XML的最简例子/">一个MFC利用MSXML解析XML的最简例子</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>&lt;div align=&quot;left&quot;&gt;
&lt;img src=&quot;http://p7.qhimg.com/t01ca7ccf3b4a3ffe38.png&quot; width=&quot;300&quot; height=&quot;180&quot; style=&quot;float:right;&quot;/&gt;</p>
<p>&lt;/div&gt;
　　
　　
　　
如题。
　　
　
　　　
&lt;!--more--&gt;</p>
<h1 id="代码">代码</h1>
<p>系统自带MSXML6.dll，在C盘system32下。先要导入文件，定义使用空间。</p>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">&lt;msxml6.dll&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> MSXML2;</div></pre></td></tr></table></figure></p>
<p>为三个编辑框分别添加变量m_strId,m_strAuthor,m_strTitle。</p>
<p>主要代码：</p>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CXMLDlg::OnBnClickedBtncreate()</div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span>  在此添加控件通知处理程序代码</span></div><div class="line">	UpdateData();</div><div class="line"></div><div class="line">	MSXML2::IXMLDOMDocumentPtr pDoc;</div><div class="line">	MSXML2::IXMLDOMElementPtr xmlRoot;</div><div class="line"></div><div class="line">	<span class="comment">//创建DOMDocument对象</span></div><div class="line">	HRESULT hr = pDoc.CreateInstance(<span class="number">__u</span>uidof(MSXML2::DOMDocument60));</div><div class="line"></div><div class="line">	<span class="comment">//根节点的名称为Book</span></div><div class="line">	<span class="comment">//创建元素并添加到文档中</span></div><div class="line">	xmlRoot = pDoc-&gt;createElement((<span class="keyword">_bstr_t</span>)<span class="string">"Book"</span>);</div><div class="line"></div><div class="line">	<span class="comment">//设置属性</span></div><div class="line">	xmlRoot-&gt;setAttribute(<span class="string">"id"</span>, (<span class="keyword">_variant_t</span>)m_strId);</div><div class="line">	pDoc-&gt;appendChild(xmlRoot);</div><div class="line">	MSXML2::IXMLDOMElementPtr pNode;</div><div class="line">	<span class="comment">//添加“author”元素</span></div><div class="line">	pNode = pDoc-&gt;createElement((<span class="keyword">_bstr_t</span>)<span class="string">"Author"</span>);</div><div class="line">	pNode-&gt;Puttext((<span class="keyword">_bstr_t</span>)m_strAuthor);</div><div class="line">	xmlRoot-&gt;appendChild(pNode);</div><div class="line"></div><div class="line">	<span class="comment">//添加“Title”元素</span></div><div class="line">	pNode = pDoc-&gt;createElement(<span class="string">"Title"</span>);</div><div class="line">	pNode-&gt;Puttext((<span class="keyword">_bstr_t</span>)m_strTitle);</div><div class="line">	xmlRoot-&gt;appendChild(pNode);</div><div class="line"></div><div class="line">	<span class="comment">//如果不存在就建立,存在就覆盖</span></div><div class="line">	pDoc-&gt;save(<span class="string">"text.xml"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> CXMLDlg::OnBnClickedBtnload()</div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span>  在此添加控件通知处理程序代码</span></div><div class="line">	MSXML2::IXMLDOMDocumentPtr pDoc;</div><div class="line">	HRESULT hr = pDoc.CreateInstance(<span class="number">__u</span>uidof(MSXML2::DOMDocument60));</div><div class="line"></div><div class="line">	<span class="comment">//加载文件</span></div><div class="line">	pDoc-&gt;load(<span class="string">"text.xml"</span>);</div><div class="line"></div><div class="line">	MSXML2::IXMLDOMNodePtr pNode;</div><div class="line">	<span class="comment">//在树中查找名为Book的节点,"//"表示在任意一层查找</span></div><div class="line">	pNode = pDoc-&gt;selectSingleNode(<span class="string">"//Book"</span>);</div><div class="line">	MSXML2::DOMNodeType nodeType;</div><div class="line">	<span class="comment">//得到节点类型</span></div><div class="line">	pNode-&gt;get_nodeType(&amp;nodeType);</div><div class="line">	<span class="comment">//节点名称</span></div><div class="line">	CString strName;</div><div class="line">	strName = (<span class="keyword">char</span> *)pNode-&gt;GetnodeName();</div><div class="line">	<span class="comment">//节点属性,放在链表中</span></div><div class="line">	MSXML2::IXMLDOMNamedNodeMapPtr pAttrMap = <span class="literal">NULL</span>;</div><div class="line">	MSXML2::IXMLDOMNodePtr   pAttrItem;</div><div class="line">	<span class="keyword">_variant_t</span> variantValue;</div><div class="line">	pNode-&gt;get_attributes(&amp;pAttrMap);</div><div class="line">	<span class="keyword">long</span> count;</div><div class="line">	count = pAttrMap-&gt;get_length(&amp;count);</div><div class="line">	pAttrMap-&gt;get_item(<span class="number">0</span>, &amp;pAttrItem);</div><div class="line">	<span class="comment">//取得节点的值</span></div><div class="line">	pAttrItem-&gt;get_nodeTypedValue(&amp;variantValue);</div><div class="line">	m_strId = (<span class="keyword">char</span> *)(<span class="keyword">_bstr_t</span>)variantValue;</div><div class="line">	UpdateData(FALSE);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">void</span> CXMLDlg::OnBnClickedBtnclear()</div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span>  在此添加控件通知处理程序代码</span></div><div class="line">	m_temp = <span class="string">""</span>;</div><div class="line">	SetDlgItemText(IDC_EDIT1, m_temp);</div><div class="line">	SetDlgItemText(IDC_EDIT2, m_temp);</div><div class="line">	SetDlgItemText(IDC_EDIT3, m_temp);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="效果">效果</h1>
<p>生成的XML:</p>
<p><img src="http://img.blog.csdn.net/20170713215940972?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="XML"></p>
<p>界面：</p>
<p><img src="http://img.blog.csdn.net/20170713220135411?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="界面"></p>
<h1 id="报错">报错</h1>
<ol>
<li></li>
</ol>
<p><img src="http://img.blog.csdn.net/20170713214333758?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="报错">
之前也遇到过类似情况。</p>
<p>解决：
<a href="http://cs.cuc.edu.cn/huangwei/wiki/teaching_c_ds_fileio_unicode.html" target="_blank" rel="external">Unicode in the Windows API</a>
<a href="https://msdn.microsoft.com/en-us/library/windows/desktop/dd317766%28v=vs.85%29.aspx" target="_blank" rel="external">Conventions for Function Prototypes</a></p>
<p>简单说来，是因为随着版本更替，老规则渐渐不使用，现在的字符多是Unicode字符集，为了各版本的兼容，最好的方法是使用TEXT宏。即将程序改为：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (!SUCCEEDED(hr))</div><div class="line"></div><div class="line">	&#123;</div><div class="line"></div><div class="line">		MessageBox(<span class="number">_</span>T(<span class="string">"无法创建DOMDocument对象，请检查是否安装了MS XML Parser 运行库!"</span>));</div><div class="line"></div><div class="line">		<span class="keyword">return</span>;</div><div class="line"></div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>即能编译通过。</p>
<ol start="2">
<li></li>
</ol>
<p><img src="http://img.blog.csdn.net/20170713214741223?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="报错2">
这个DOMDocument40是什么？同样的程序，WIN7电脑就可以编译通过，WIN10就报错？要换成DOMDocument60才行。</p>
<p>答：MSXML SDK版本不同造成的差异。</p>
<h1 id="参考">参考</h1>
<p><a href="http://m.blog.csdn.net/John_ToStr/article/details/50970443" target="_blank" rel="external">MFC中利用MSXML解析XML文档</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/互联网/">互联网</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MFC/">MFC</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/XML/">XML</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
	


  
  
</article>









  
    <article id="post-MFC傻瓜式教程" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/04/13/MFC傻瓜式教程/" class="article-date">
      <time datetime="2017-04-13T14:26:01.000Z" itemprop="datePublished">2017-04-13</time>
</a>

 
    <a href="/2017/04/13/MFC傻瓜式教程/#comments" title="查看评论">
        <i class="fa fa-comments-o" aria-hidden="true"></i>
        <span class="count-comment"></span>
        
        
            <span class="disqus-comment-count" data-disqus-identifier="2017/04/13/MFC傻瓜式教程/"></span>
        
    </a>

    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/13/MFC傻瓜式教程/">MFC傻瓜式教程</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>&lt;div align=&quot;left&quot;&gt;
&lt;img src=&quot;http://img.blog.csdn.net/20170413231922633?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast&quot; width=&quot;300&quot; height=&quot;180&quot; style=&quot;float:right;&quot;/&gt;</p>
<p>&lt;/div&gt;</p>
<blockquote>
<p>2017.7.9已更新新章节</p>
</blockquote>
<p>本教程重操作，轻理论，为操作减负。需了解详细原理的朋友可以自行看各种书籍。
　　直接上菜。</p>
<p>&lt;!--more--&gt;
MFC：Microsoft Foundation Class ，微软基础类库。</p>
<h1 id="对话框">对话框</h1>
<h2 id="对话框的创建和显示">对话框的创建和显示</h2>
<ol>
<li>
<p>新建MFC AppWizard(exe)工程，单文档类型。工程名：Mybole。编译运行。
<img src="http://img.blog.csdn.net/20170413231922633?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="新建"></p>
</li>
<li>
<p>点击帮助-关于Mybole。这是MFC自动创建的。
<img src="http://img.blog.csdn.net/20170413231954758?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="关于"></p>
</li>
<li>
<p>创建自己的对话框。点击Insert-Resource。选择Dialog，点击New。VC++自动将其标识设置为IDD_DIALOG1，并自动添加到ResourceView-Dialog项中。Dialog项下还有一个对话框资源标识：IDD_ABOUTBOX，即上一步中的“关于”对话框。
<img src="http://img.blog.csdn.net/20170413232035196?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="Insert Resource对话框"></p>
</li>
</ol>
<p><img src="http://img.blog.csdn.net/20170413232222055?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="新建的对话框资源"></p>
<ol start="4">
<li>选中对话框本身，右键点击属性。将Caption设置为“测试”。</li>
<li>选择View-ClassWizard，点击create a new class，OK。出现下图，并输入下图选项。
<img src="http://img.blog.csdn.net/20170413232907845?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="New Class"></li>
<li>在随后出现的MFC ClassWizard对话框上点击OK。
<img src="http://img.blog.csdn.net/20170413233804513?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="列表">
<strong>注意</strong>：看看左侧类列表中是否添加好了CTestDlg，否则会影响后续操作。</li>
</ol>
<p>接下来，我们希望在程序中显示这个对话窗口。</p>
<ol start="7">
<li>
<p>点击右侧菜单Menu，选中IDR_MAINFRAME。点击帮助旁边的虚线框。
<img src="http://img.blog.csdn.net/20170413233914861?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="Menu"></p>
</li>
<li>
<p>对虚线框右键属性，修改为下图。
<img src="http://img.blog.csdn.net/20170413234011986?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="属性"></p>
</li>
<li>
<p>关闭属性。点击View-ClassWizard（中文是建立类向导），选择CMyboleView，用COMMAND命令消息响应函数。如图。
<img src="http://img.blog.csdn.net/20170414000004060?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="COMMAND"></p>
</li>
</ol>
<h3 id="模态对话框的创建">模态对话框的创建</h3>
<p>需要调用CDialog类的成员函数：DoModal，它能创建并显示一个模态对话框，其返回值将作为CDialog类的另一个成员函数：EndDialog的参数，后者功能是关闭模态对话框。</p>
<p>在FileView中选择MyboleView.cpp，编写程序。
　　记得在开头添加头文件 #include “testdlg.h” （头文件大小写问题，linux区分，windows不区分）
<img src="http://img.blog.csdn.net/20170414000303079?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="编程">
　　显示模态对话框的具体实现代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CMyboleView::OnDialog() </div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add your command handler code here</span></div><div class="line">	CTestDlg dlg;</div><div class="line">	dlg.DoModal();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>编译运行，点击对话框。会发现若不确认该窗口，将无法点击其他窗口。
<img src="http://img.blog.csdn.net/20170414000500779?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="模态对话框1"></p>
<p><img src="http://img.blog.csdn.net/20170414000612202?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="模态对话框2"></p>
<h3 id="非模态对话框的创建">非模态对话框的创建</h3>
<p>将上面的模态对话框代码注释掉。</p>
<p>改为：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CMyboleView::OnDialog() </div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add your command handler code here</span></div><div class="line">	<span class="comment">//CTestDlg dlg;</span></div><div class="line">	<span class="comment">//dlg.DoModal();</span></div><div class="line"></div><div class="line">	CTestDlg *pDlg = <span class="keyword">new</span> CTestDlg;</div><div class="line">	pDlg-&gt;Create(IDD_DIALOG1,<span class="keyword">this</span>);</div><div class="line">	pDlg-&gt;ShowWindow(SW_SHOW);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>注意</strong>：需要把之前运行的对话框关掉才能编译成功。</p>
<p>然而，当它生命周期结束时，所保存的内存地址就丢失了，那么程序中也就无法再引用到它所指向的那块内存。于是，我们这样解决该问题。
<img src="http://img.blog.csdn.net/20170414000901869?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="MFC ClassWizard"></p>
<p><strong>注意</strong>：Message里双击添加函数或者点击add Class…</p>
<p>void CTestDlg::PostNcDestroy()
{
	// TODO: Add your specialized code here and/or call the base class
	delete this;
	CDialog::PostNcDestroy();
}</p>
<p><strong>区别</strong>：点击确定，对话框都会消失。但是，模态对话框窗口对象被销毁了。对非模态对话框来说，只是隐藏起来了，并未被销毁。
因此，若要销毁对话框，若有一个ID为IDOK的按钮，就必须重写基类的OnOK这个虚函数，并在重写的函数中调用DestroyWindow函数，完成销毁。并不要再调用基类的OnOK函数。
同样地，若有一个ID为IDCANCEL的按钮，也必须重写基类的OnCancel虚函数，并在重写的函数中调用DestroyWindow函数，完成销毁。并不要再调用基类的OnCancel函数。</p>
<h1 id="动态创建按钮">动态创建按钮</h1>
<p>注释掉非模态对话框代码，还原模态对话框代码。</p>
<p>点击ResourceView-IDD_DIALOG1，打开资源，用鼠标拖出控件面板上的Button按钮控件，对按钮右键，选择属性，设置如下。
<img src="http://img.blog.csdn.net/20170414001008658?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="按钮"></p>
<p>接下来，我们实现当单击Add按钮时，在对话框中动态创建一个按钮这一功能。</p>
<ol>
<li>为CTestDlg类添加一个私有的CButton成员变量。
　　点击ClassView标签页右键，如图点击。
<img src="http://img.blog.csdn.net/20170414001252061?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="ClassView"></li>
</ol>
<p>填入信息。
<img src="http://img.blog.csdn.net/20170414001335972?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="添加成员变量"></p>
<ol start="2">
<li>添加Add按钮单击消息的响应函数。
　　按钮点右键，选ClassWizard（建立类向导），如图。
<img src="http://img.blog.csdn.net/20170414001137294?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="建立类向导"></li>
</ol>
<p>单击Edit Code，即可定位到该函数定义处。
　　添加一下代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CTestDlg::OnBtnAdd() </div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add your control notification handler code here</span></div><div class="line">	m_btn.Create(<span class="string">"New"</span>,BS_DEFPUSHBUTTON | WS_VISIBLE | WS_CHILD,</div><div class="line">				 CRect(<span class="number">0</span>,<span class="number">0</span>,<span class="number">100</span>,<span class="number">100</span>),<span class="keyword">this</span>,<span class="number">123</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>为避免多次点击Add出现非法操作，我们需要进行如下步骤。</p>
<ol start="3">
<li>
<p>为CTestDlg类增加一个私有的BOOL类型成员变量。
变量类型：BOOL
变量名称：m_bIsCreated
Access: private</p>
</li>
<li>
<p>在TestDlg.cpp中找到构造函数，将m_bIsCreated初始为FALSE。如图所示。
<img src="http://img.blog.csdn.net/20170415152155489?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
</li>
</ol>
<p>或者改为如下亦可。
Static BOOL bIsCreated = FALSE;</p>
<ol start="5">
<li>回到Add，双击它，进入代码部分，改之。
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CTestDlg::OnBtnAdd() </div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add your control notification handler code here</span></div><div class="line">	<span class="keyword">if</span>(m_bIsCreated==FALSE)</div><div class="line">	&#123;</div><div class="line">	m_btn.Create(<span class="string">"New"</span>,BS_DEFPUSHBUTTON | WS_VISIBLE | WS_CHILD,</div><div class="line">				CRect(<span class="number">0</span>,<span class="number">0</span>,<span class="number">100</span>,<span class="number">100</span>),<span class="keyword">this</span>,<span class="number">123</span>);</div><div class="line">	m_bIsCreated = TRUE;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span></div><div class="line">	&#123;</div><div class="line">		m_btn.DestroyWindow();</div><div class="line">		m_bIsCreated = FALSE;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></li>
</ol>
<p>或者以下亦能实现。
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CTestDlg::OnBtnAdd() </div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add your control notification handler code here</span></div><div class="line">	<span class="keyword">if</span>(!m_btn.m_hWnd)</div><div class="line">	&#123;</div><div class="line">	m_btn.Create(<span class="string">"New"</span>,BS_DEFPUSHBUTTON | WS_VISIBLE | WS_CHILD,</div><div class="line">				CRect(<span class="number">0</span>,<span class="number">0</span>,<span class="number">100</span>,<span class="number">100</span>),<span class="keyword">this</span>,<span class="number">123</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span></div><div class="line">	&#123;</div><div class="line">		m_btn.DestroyWindow();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>效果：
　　<img src="http://img.blog.csdn.net/20170415152224880?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>点击Add出现New窗口，再点击就销毁。</p>
<h2 id="控件的访问">控件的访问</h2>
<h3 id="控件的调整">控件的调整</h3>
<p>用Layout-Align，Layout-Make Same Size，Layout-Space Evenly里的选项进行调整。
<img src="http://img.blog.csdn.net/20170415152247131?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h3 id="静态文本控件">静态文本控件</h3>
<p>查看三个静态文本框，它们ID相同。我们可以更改第一个静态文本框ID为IDC_NUMBER1，再打开ClassWizard，可以在ObjectIDs看到新ID。
<img src="http://img.blog.csdn.net/20170415152324147?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述">
　　对BN_CLICKED进行Add Function，并Edit Code:</p>
<p>此时运行程序点击第一个静态文本框并没有反应。这是因为：<strong>静态文本控件在默认状态下是不发送通告消息的</strong>。</p>
<p>为了该控件能向父窗口发送鼠标事件，我们对该文本框右键-属性，切换到styles选项卡，勾上Notify。
<img src="http://img.blog.csdn.net/20170415152341882?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>现在可以显示了：
　　点击就改变。
<img src="http://img.blog.csdn.net/20170415152354773?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p><strong>总结：为了使一个静态文本控件能够响应鼠标单击消息，那么需要进行两个特殊的步骤：第一步，改变它的ID；第二步，在它的属性对话框中选中Notify选项。</strong></p>
<h3 id="编辑框控件">编辑框控件</h3>
<p>利用上面的对话框实现这样的功能：在前两个编辑框中分别输入一个数字，然后单击Add按钮，对前两个编辑框中的数字求和，并将结果显示在第三个编辑框中。</p>
<h4 id="第一种方式">第一种方式</h4>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CTestDlg::OnBtnAdd() </div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> num1, num2, num3; </div><div class="line">	<span class="keyword">char</span> ch1[<span class="number">10</span>], ch2[<span class="number">10</span>], ch3[<span class="number">10</span>]; </div><div class="line">	GetDlgItem(IDC_EDIT1)-&gt;GetWindowText(ch1,<span class="number">10</span>); </div><div class="line">	GetDlgItem(IDC_EDIT2)-&gt;GetWindowText(ch2,<span class="number">10</span>);</div><div class="line"></div><div class="line">	num1 = atoi(ch1); </div><div class="line">	num2 = atoi(ch2); </div><div class="line">	num3 = num1 + num2; </div><div class="line"></div><div class="line">	itoa(num3,ch3,<span class="number">10</span>);</div><div class="line">	GetDlgItem(IDC_EDIT3)-&gt;SetWindowText(ch3);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>C语言转换函数：atoi 将一个由数字组成的字符串转换为相应的数值
itoa 数值转换为文本
itoa函数的第三个参数表示转换的进制，数字10表示十进制。</p>
<p>效果：
<img src="http://img.blog.csdn.net/20170415152409742?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h4 id="第二种方式">第二种方式</h4>
<p>代码如下：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CTestDlg::OnBtnAdd() </div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> num1, num2, num3; </div><div class="line">	<span class="keyword">char</span> ch1[<span class="number">10</span>], ch2[<span class="number">10</span>], ch3[<span class="number">10</span>]; </div><div class="line">	<span class="comment">//GetDlgItem(IDC_EDIT1)-&gt;GetWindowText(ch1,10); </span></div><div class="line">	<span class="comment">//GetDlgItem(IDC_EDIT2)-&gt;GetWindowText(ch2,10);</span></div><div class="line">	</div><div class="line">	GetDlgItemText(IDC_EDIT1,ch1,<span class="number">10</span>);</div><div class="line">	GetDlgItemText(IDC_EDIT2,ch2,<span class="number">10</span>);</div><div class="line"></div><div class="line">	num1 = atoi(ch1); </div><div class="line">	num2 = atoi(ch2); </div><div class="line">	num3 = num1 + num2; </div><div class="line"></div><div class="line">	itoa(num3,ch3,<span class="number">10</span>);</div><div class="line">	<span class="comment">//GetDlgItem(IDC_EDIT3)-&gt;SetWindowText(ch3);</span></div><div class="line">	SetDlgItemText(IDC_EDIT3,ch3);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>GetDlgItemText 将返回对话框中指定ID的控件上的文本，相当于将上面的GetDlgItem和GetWindowText这两个函数功能组合起来了。
与之对应的是SetDlgItemText，用来设置对话框中指定ID的控件上的文本。</p>
<h4 id="第三种方式">第三种方式</h4>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CTestDlg::OnBtnAdd() </div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> num1, num2, num3; </div><div class="line">	<span class="comment">//char ch1[10], ch2[10], ch3[10]; </span></div><div class="line">	<span class="comment">//GetDlgItem(IDC_EDIT1)-&gt;GetWindowText(ch1,10); </span></div><div class="line">	<span class="comment">//GetDlgItem(IDC_EDIT2)-&gt;GetWindowText(ch2,10);</span></div><div class="line">	</div><div class="line">	<span class="comment">//GetDlgItemText(IDC_EDIT1,ch1,10);</span></div><div class="line">	<span class="comment">//GetDlgItemText(IDC_EDIT2,ch2,10);</span></div><div class="line"></div><div class="line">	num1 = GetDlgItemInt(IDC_EDIT1);</div><div class="line">	num2 = GetDlgItemInt(IDC_EDIT2);</div><div class="line"></div><div class="line">	<span class="comment">//num1 = atoi(ch1); </span></div><div class="line">	<span class="comment">//num2 = atoi(ch2); </span></div><div class="line">	num3 = num1 + num2; </div><div class="line"></div><div class="line">	<span class="comment">//itoa(num3,ch3,10);</span></div><div class="line">	<span class="comment">//GetDlgItem(IDC_EDIT3)-&gt;SetWindowText(ch3);</span></div><div class="line">	<span class="comment">//SetDlgItemText(IDC_EDIT3,ch3);</span></div><div class="line">	SetDlgItemInt(IDC_EDIT3,num3);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="第四种方式">第四种方式</h4>
<p>将这三个编辑框分别与对话框类的三个成员变量相关联，然后通过这些成员变量来检索和设置编辑框的文本，这是最简单的访问控件的方式。
打开ClassWizard对话框，切换到Member Variables选项卡，如图。
<img src="http://img.blog.csdn.net/20170415152431039?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述">
　　首先为IDC_EDIT1编辑框添加一个关联的成员变量，方法是在Control IDs列表中选中IDC_EDIT1，再单击Add Variable按钮，如图。
<img src="http://img.blog.csdn.net/20170415152451118?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述">
<img src="http://img.blog.csdn.net/20170415152505259?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>同样地，为IDC_EDIT2和IDC_EDIT3分别添加好成员变量。
　　接着修改代码：</p>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CTestDlg::OnBtnAdd() </div><div class="line">&#123;</div><div class="line">	UpdateData();</div><div class="line">	m_num3 = m_num1 + m_num2;</div><div class="line">	UpdateData(FALSE);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>对编辑框控件中输入的数值设定一个范围：
　　打开ClassWizard-Member Variable，选中IDC_EDIT1，下方输入0和100。同样为IDC_EDIT2也设置好。
<img src="http://img.blog.csdn.net/20170415152522025?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h4 id="第五种方式">第五种方式</h4>
<p>将编辑框控件再与一个变量相关联，代表控件本身。为IDC_EDIT1增加一个控件类型的变量：m_edit1，类别为Control。同样地，也为IDC_EDIT2和IDC_EDIT3添加。
<img src="http://img.blog.csdn.net/20170415152547447?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>修改代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CTestDlg::OnBtnAdd() </div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> num1, num2, num3; </div><div class="line">	<span class="keyword">char</span> ch1[<span class="number">10</span>], ch2[<span class="number">10</span>], ch3[<span class="number">10</span>]; </div><div class="line">	</div><div class="line">	m_edit1.GetWindowText(ch1,<span class="number">10</span>);</div><div class="line">	m_edit2.GetWindowText(ch2,<span class="number">10</span>);</div><div class="line"></div><div class="line">	<span class="comment">//num1 = GetDlgItemInt(IDC_EDIT1);</span></div><div class="line">	<span class="comment">//num2 = GetDlgItemInt(IDC_EDIT2);</span></div><div class="line"></div><div class="line">	num1 = atoi(ch1); </div><div class="line">	num2 = atoi(ch2); </div><div class="line">	num3 = num1 + num2; </div><div class="line"></div><div class="line">	itoa(num3,ch3,<span class="number">10</span>);</div><div class="line">	m_edit3.SetWindowText(ch3);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="第六种方式">第六种方式</h4>
<p>修改代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CTestDlg::OnBtnAdd() </div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> num1, num2, num3; </div><div class="line">	<span class="keyword">char</span> ch1[<span class="number">10</span>], ch2[<span class="number">10</span>], ch3[<span class="number">10</span>]; </div><div class="line"></div><div class="line">	::SendMessage(GetDlgItem(IDC_EDIT1)-&gt;m_hWnd, WM_GETTEXT, <span class="number">10</span>, (LPARAM)ch1);</div><div class="line">	::SendMessage(m_edit2.m_hWnd, WM_GETTEXT, <span class="number">10</span>, (LPARAM)ch2);</div><div class="line"></div><div class="line">	num1 = atoi(ch1); </div><div class="line">	num2 = atoi(ch2); </div><div class="line">	num3 = num1 + num2; </div><div class="line"></div><div class="line">	itoa(num3,ch3,<span class="number">10</span>);</div><div class="line">	m_edit3.SendMessage(WM_SETTEXT, <span class="number">0</span>, (LPARAM)ch3);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="第七种方式">第七种方式</h4>
<p>修改代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CTestDlg::OnBtnAdd() </div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> num1, num2, num3; </div><div class="line">	<span class="keyword">char</span> ch1[<span class="number">10</span>], ch2[<span class="number">10</span>], ch3[<span class="number">10</span>]; </div><div class="line">	</div><div class="line">	SendDlgItemMessage(IDC_EDIT1, WM_GETTEXT, <span class="number">10</span>, (LPARAM)ch1);</div><div class="line">	SendDlgItemMessage(IDC_EDIT2, WM_GETTEXT, <span class="number">10</span>, (LPARAM)ch2);</div><div class="line">	</div><div class="line">num1 = atoi(ch1); </div><div class="line">	num2 = atoi(ch2); </div><div class="line">	num3 = num1 + num2; </div><div class="line"></div><div class="line">	itoa(num3,ch3,<span class="number">10</span>);</div><div class="line">	SendDlgItemMessage(IDC_EDIT3, WM_SETTEXT, <span class="number">0</span>, (LPARAM)ch3);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>获得编辑框复选的内容：
　　在上述代码最后添加：
	SendDlgItemMessage(IDC_EDIT3, EM_SETSEL, 0, -1); //0,-1表示全选若1,3表示选中1-3位复选
	m_edit3.SetFocus();</p>
<p>效果：
<img src="http://img.blog.csdn.net/20170415152614010?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h4 id="总结">总结</h4>
<p>1	GetDlgItem()-&gt;Get(Set)WindowTest()
2	GetDlgItemText()/SetDlgItemText()
3	GetDlgItemInt()/SetDlgItemInt()
4	将控件和整型变量相关联
5	将控件和控件变量相关联
6	SendMessage()
7	SendDlgItemMessage()
　　最常用是1、4、5。在利用MFC编程时，6、7用得少。</p>
<h2 id="对话框伸缩功能的实现">对话框伸缩功能的实现</h2>
<p>对话框上再添加一个按钮，Caption设置为“收缩&lt;&lt;”点击ClassWizard，添加一个命令相应函数（BN_CLICKED）。具体实现代码为：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CTestDlg::OnButton1() </div><div class="line">&#123;</div><div class="line">	CString str; </div><div class="line">	<span class="keyword">if</span>(GetDlgItemText(IDC_BUTTON1,str), str == <span class="string">"收缩&lt;&lt;"</span>)</div><div class="line">	&#123;</div><div class="line">		SetDlgItemText(IDC_BUTTON1, <span class="string">"拓展&gt;&gt;"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span></div><div class="line">	&#123;</div><div class="line">		SetDlgItemText(IDC_BUTTON1, <span class="string">"收缩&lt;&lt;"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>拖动一个图像控件来划分对话框中要动态切除的部分。
<img src="http://img.blog.csdn.net/20170415152648992?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>修改该控件ID为IDC_SEPATATOR，styles选项卡勾上Sunken选项。
　　修改代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CTestDlg::OnButton1() </div><div class="line">&#123;</div><div class="line">	CString str; </div><div class="line">	<span class="keyword">if</span>(GetDlgItemText(IDC_BUTTON1,str), str == <span class="string">"收缩&lt;&lt;"</span>)</div><div class="line">	&#123;</div><div class="line">		SetDlgItemText(IDC_BUTTON1, <span class="string">"拓展&gt;&gt;"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span></div><div class="line">	&#123;</div><div class="line">		SetDlgItemText(IDC_BUTTON1, <span class="string">"收缩&lt;&lt;"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">static</span> CRect rectLarge;</div><div class="line">	<span class="keyword">static</span> CRect rectSmall;</div><div class="line"></div><div class="line">	<span class="function">CRect <span class="title">rect1</span><span class="params">(<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span>)</span></span>;</div><div class="line">	<span class="function">CRect <span class="title">rect2</span><span class="params">(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span></span>;</div><div class="line"></div><div class="line">	<span class="keyword">if</span>(rectLarge.IsRectNull())</div><div class="line">	&#123;</div><div class="line">		CRect rectSeparator;</div><div class="line">		GetWindowRect(&amp;rectLarge);</div><div class="line">		GetDlgItem(IDC_SEPARATOR)-&gt;GetWindowRect(&amp;rectSeparator);</div><div class="line"></div><div class="line">		rectSmall.left=rectLarge.left;</div><div class="line">		rectSmall.top=rectLarge.top;</div><div class="line">		rectSmall.right=rectLarge.right;</div><div class="line">		rectSmall.bottom=rectSeparator.bottom;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span>(str == <span class="string">"收缩&lt;&lt;"</span>)</div><div class="line">	&#123;</div><div class="line">		SetWindowPos(<span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>, rectSmall.Width(), rectSmall.Height(), SWP_NOMOVE | SWP_NOZORDER);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span></div><div class="line">	&#123;</div><div class="line">		SetWindowPos(<span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>, rectLarge.Width(), rectLarge.Height(), SWP_NOMOVE | SWP_NOZORDER);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>效果：
<img src="http://img.blog.csdn.net/20170415152705855?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>点击“收缩&lt;&lt;”：
<img src="http://img.blog.csdn.net/20170415152725793?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>若希望隐藏分隔条，则设置属性去掉“Visible”前的勾。</p>
<h2 id="输入焦点的传递">输入焦点的传递</h2>
<p>为了屏蔽掉默认的回车键关闭对话框这一功能，应该在对话框子类（此处是CTestDlg类）中重写OK按钮的消息响应函数。
　　首先点击OK按钮，添加鼠标单击消息响应函数。注释掉原有函数。</p>
<h3 id="法一">法一</h3>
<p>在ClassView选项卡的CTestDlg类添加WM_INITDIALOG消息的响应函数。对类右键，选择Add Windows Message Handler，在弹出的框左侧选择WM_INITDIALOG，直接单击Add and Edit，跳转。
　　修改代码为：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CTestDlg::OnOK() </div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add extra validation here</span></div><div class="line">	</div><div class="line">	<span class="comment">//CDialog::OnOK();</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">WNDPROC prevProc;</div><div class="line">	<span class="function">LRESULT CALLBACK <span class="title">NewEditProc</span><span class="params">(</span></span></div><div class="line">		HWND hwnd,</div><div class="line">		UINT uMsg,</div><div class="line">		WPARAM wParam,</div><div class="line">		LPARAM lParam</div><div class="line">		)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">if</span>(uMsg == WM_CHAR &amp;&amp; wParam == <span class="number">0x0d</span>)</div><div class="line">		&#123;</div><div class="line">			::SetFocus(GetNextWindow(hwnd,GW_HWNDNEXT));</div><div class="line">			<span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span></div><div class="line">		&#123;</div><div class="line">			<span class="keyword">return</span> prevProc(hwnd,uMsg,wParam,lParam);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">BOOL CTestDlg::OnInitDialog() </div><div class="line">&#123;</div><div class="line">	CDialog::OnInitDialog();</div><div class="line">	prevProc=(WNDPROC)SetWindowLong(GetDlgItem(IDC_EDIT1)-&gt;m_hWnd,</div><div class="line">		GWL_WNDPROC, (LONG)NewEditProc);</div><div class="line">	<span class="keyword">return</span> TRUE;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>查看第一个编辑框的属性，打开styles选项卡，勾上MultiLine（多行）。即可实现焦点的传递。</p>
<h3 id="法二">法二</h3>
<p>只需要改变一行代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">WNDPROC prevProc;</div><div class="line">	<span class="function">LRESULT CALLBACK <span class="title">NewEditProc</span><span class="params">(</span></span></div><div class="line">		HWND hwnd,</div><div class="line">		UINT uMsg,</div><div class="line">		WPARAM wParam,</div><div class="line">		LPARAM lParam</div><div class="line">		)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">if</span>(uMsg == WM_CHAR &amp;&amp; wParam == <span class="number">0x0d</span>)</div><div class="line">		&#123;</div><div class="line">			<span class="comment">//::SetFocus(GetNextWindow(hwnd,GW_HWNDNEXT));</span></div><div class="line">			SetFocus(::GetWindow(hwnd,GW_HWNDNEXT));</div><div class="line">			<span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span></div><div class="line">		&#123;</div><div class="line">			<span class="keyword">return</span> prevProc(hwnd,uMsg,wParam,lParam);</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<h3 id="法三">法三</h3>
<p>编辑框属性有一个WS_TABSTOP，如果勾选了，则在对话框中按下Tab键后，输入焦点可以转移到此控件上。</p>
<p>修改一行代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">WNDPROC prevProc;</div><div class="line">	<span class="function">LRESULT CALLBACK <span class="title">NewEditProc</span><span class="params">(</span></span></div><div class="line">		HWND hwnd,</div><div class="line">		UINT uMsg,</div><div class="line">		WPARAM wParam,</div><div class="line">		LPARAM lParam</div><div class="line">		)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">if</span>(uMsg == WM_CHAR &amp;&amp; wParam == <span class="number">0x0d</span>)</div><div class="line">		&#123;</div><div class="line">			SetFocus(::GetNextDlgTabItem(::GetParent(hwnd),hwnd,FALSE));</div><div class="line">			<span class="comment">//::SetFocus(GetNextWindow(hwnd,GW_HWNDNEXT));</span></div><div class="line">			<span class="comment">//SetFocus(::GetWindow(hwnd,GW_HWNDNEXT));</span></div><div class="line">			<span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span></div><div class="line">		&#123;</div><div class="line">			<span class="keyword">return</span> prevProc(hwnd,uMsg,wParam,lParam);</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>三种方法的缺点：只修改了第一个编辑框的窗口过程，因此从第二到第三个编辑框的焦点转移无法实现，除非继续修改第二个编辑窗口。</p>
<p>再介绍一种方法解决这个问题。</p>
<h3 id="法四">法四</h3>
<p>在MFC中，默认情况下，当在对话框窗口中按下回车键时，会调用对话框的默认按钮的响应函数，我们可以在此默认按钮的响应函数中把焦点依次向下传递。</p>
<p>首先取消第一个编辑框的MultiLine。
　　接着修改OnOK函数为：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CTestDlg::OnOK() </div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add extra validation here</span></div><div class="line">	<span class="comment">//GetDlgItem(IDC_EDIT1)-&gt;GetNextWindow()-&gt;SetFocus();</span></div><div class="line">	<span class="comment">//GetFocus()-&gt;GetNextWindow()-&gt;SetFocus();</span></div><div class="line">	<span class="comment">//GetFocus()-&gt;GetWindow(GW_HWNDNEXT)-&gt;SetFocus();</span></div><div class="line">	GetNextDlgTabItem(GetFocus())-&gt;SetFocus();</div><div class="line">	<span class="comment">//CDialog::OnOK();</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>注释掉的部分是各种失败的尝试，各有各的bug。现在程序是正常的。</p>
<pre><code>**注意：然而该屏蔽回车键的方法并非是常规做法，应该在PreTranslateMessage中进行拦截。（return TRUE即拦截）**
</code></pre>
<p>具体做法：
　　现在Testdlg.h中添加：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">class</span> CTestDlg : <span class="keyword">public</span> CDialog</div><div class="line">&#123;</div><div class="line"></div><div class="line"><span class="keyword">protected</span>:</div><div class="line">	<span class="function"><span class="keyword">virtual</span> BOOL <span class="title">PreTranslateMessage</span><span class="params">(MSG* pMsg)</span></span>;</div><div class="line"></div><div class="line"><span class="keyword">public</span>:</div><div class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnOK</span><span class="params">()</span></span>;</div><div class="line">……</div></pre></td></tr></table></figure></p>
<p>接着：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">CTestDlg::PreTranslateMessage(MSG* pMsg)</div><div class="line">&#123;</div><div class="line">	<span class="comment">//屏蔽ESC关闭窗体</span></div><div class="line">	<span class="keyword">if</span> (pMsg-&gt;message == WM_KEYDOWN &amp;&amp; pMsg-&gt;wParam == VK_ESCAPE)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span> TRUE;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//屏蔽回车关闭窗体，但会导致回车在窗体上失效.</span></div><div class="line">	<span class="comment">/*</span></div><div class="line">	if (pMsg-&gt;message == WM_KEYDOWN &amp;&amp; pMsg-&gt;wParam == VK_RETURN &amp;&amp; pMsg-&gt;wParam)</div><div class="line">	&#123;</div><div class="line">		return TRUE;</div><div class="line">	&#125;</div><div class="line">	*/</div><div class="line">	<span class="keyword">else</span> </div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span> CDialog::PreTranslateMessage(pMsg);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> CTestDlg::OnOK() </div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add extra validation here</span></div><div class="line">	</div><div class="line">	<span class="comment">//CDialog::OnOK();</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>点击Layout-Tab order，这些序号就是各控件的Tab顺序。顺序可改变，依次点击希望的顺序控件即可。</p>
<p>调用顺序：当用户按下回车键时，Windows将查看对话框中是否存在指定的默认按钮，如果有，就调用该默认按钮单击消息的响应函数。如果没有，就会调用虚拟的OnOK函数，即使对话框没有包含默认的OK按钮（这个默认OK按钮的ID是IDOK）。</p>
<h1 id="文件和注册表操作">文件和注册表操作</h1>
<h2 id="c语言对文件操作的支持">C语言对文件操作的支持</h2>
<p>新建单文档类型的MFC应用程序，工程名为File，并为主菜单添加一个子菜单，名称为“文件操作”，然后为其添加两个菜单项，并分别为它们添加相应的命令响应函数（通过COMMAND），让CFileView类接收这些菜单项的命令响应。
<img src="http://img.blog.csdn.net/20170420224900928?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述">
<img src="http://img.blog.csdn.net/20170420224921428?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h3 id="文件的打开和写入">文件的打开和写入</h3>
<p>代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CFileView::OnFileWrite() </div><div class="line">&#123;</div><div class="line">	FILE *pFile = fopen(<span class="string">"1.txt"</span>,<span class="string">"w"</span>);</div><div class="line">	fwrite(<span class="string">"http://www.sunxin.org"</span>, <span class="number">1</span>, <span class="built_in">strlen</span>(<span class="string">"http://www.sunxin.org"</span>), pFile); </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>编译后可看到文件夹中生成了1.txt，打开有一行网址。</p>
<h3 id="文件的关闭">文件的关闭</h3>
<p>增加一行代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CFileView::OnFileWrite() </div><div class="line">&#123;</div><div class="line">	FILE *pFile = fopen(<span class="string">"1.txt"</span>,<span class="string">"w"</span>);</div><div class="line">	fwrite(<span class="string">"http://www.sunxin.org"</span>, <span class="number">1</span>, <span class="built_in">strlen</span>(<span class="string">"http://www.sunxin.org"</span>), pFile); </div><div class="line">	fclose(pFile);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="文件指针定位">文件指针定位</h3>
<p>代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CFileView::OnFileWrite() </div><div class="line">&#123;</div><div class="line">	FILE *pFile = fopen(<span class="string">"1.txt"</span>,<span class="string">"w"</span>);</div><div class="line">	fwrite(<span class="string">"http://www.sunxin.org"</span>, <span class="number">1</span>, <span class="built_in">strlen</span>(<span class="string">"http://www.sunxin.org"</span>), pFile); </div><div class="line">	fwrite(<span class="string">"欢迎访问"</span>, <span class="number">1</span>, <span class="built_in">strlen</span>(<span class="string">"欢迎访问"</span>), pFile);</div><div class="line">	fclose(pFile);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>显示：http://www.sunxin.org欢迎访问</p>
<p>将文件指针移动到文件的开始位置处：
　　代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CFileView::OnFileWrite() </div><div class="line">&#123;</div><div class="line">	FILE *pFile = fopen(<span class="string">"1.txt"</span>,<span class="string">"w"</span>);</div><div class="line">	fwrite(<span class="string">"http://www.sunxin.org"</span>, <span class="number">1</span>, <span class="built_in">strlen</span>(<span class="string">"http://www.sunxin.org"</span>), pFile); </div><div class="line">	fseek(pFile, <span class="number">0</span>, SEEK_SET);</div><div class="line">	fwrite(<span class="string">"ftp:"</span>, <span class="number">1</span>, <span class="built_in">strlen</span>(<span class="string">"ftp:"</span>),pFile);</div><div class="line">	<span class="comment">//fwrite("欢迎访问", 1, strlen("欢迎访问"), pFile);</span></div><div class="line">	fclose(pFile);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>显示：ftp:://www.sunxin.org</p>
<h3 id="文件的读取">文件的读取</h3>
<p>在OnFileRead函数中写入代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CFileView::OnFileRead() </div><div class="line">&#123;</div><div class="line">	FILE *pFile = fopen(<span class="string">"1.txt"</span>,<span class="string">"r"</span>);</div><div class="line">	<span class="keyword">char</span> ch[<span class="number">100</span>];</div><div class="line">	fread(ch, <span class="number">1</span>, <span class="number">100</span>, pFile);</div><div class="line">	fclose(pFile);</div><div class="line">	MessageBox(ch);</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>编译运行：
　　
<img src="http://img.blog.csdn.net/20170420224951225?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>原因：C语言以“\0”结束。</p>
<p>解决方法：
　　法一：
　　修改代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CFileView::OnFileWrite() </div><div class="line">&#123;</div><div class="line">	FILE *pFile = fopen(<span class="string">"1.txt"</span>,<span class="string">"w"</span>);</div><div class="line">	<span class="keyword">char</span> buf[<span class="number">22</span>] = <span class="string">"http://www.sunxin.org"</span>;</div><div class="line">	buf[<span class="number">21</span>] = <span class="string">'\0'</span>;</div><div class="line">	fwrite(buf, <span class="number">1</span>, <span class="number">22</span>, pFile);</div><div class="line">	fclose(pFile);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>先点击写入文件，再点击读取文件，就可以看到正确的内容。
　　缺点：增加了文件大小。</p>
<p>法二：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CFileView::OnFileRead() </div><div class="line">&#123;</div><div class="line">	FILE *pFile = fopen(<span class="string">"1.txt"</span>,<span class="string">"r"</span>);</div><div class="line">	<span class="keyword">char</span> ch[<span class="number">100</span>];</div><div class="line">	<span class="built_in">memset</span>(ch, <span class="number">0</span>, <span class="number">100</span>);</div><div class="line">	fread(ch, <span class="number">1</span>, <span class="number">100</span>, pFile);</div><div class="line">	fclose(pFile);</div><div class="line">	MessageBox(ch);</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>法三：
　　读取文件时，不知道文件大小时的做法。
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CFileView::OnFileRead() </div><div class="line">&#123;</div><div class="line">	FILE *pFile = fopen(<span class="string">"1.txt"</span>,<span class="string">"r"</span>);</div><div class="line">	<span class="keyword">char</span> *pBuf;</div><div class="line">	fseek(pFile, <span class="number">0</span>, SEEK_END);</div><div class="line">	<span class="keyword">int</span> len=ftell(pFile);</div><div class="line">	pBuf = <span class="keyword">new</span> <span class="keyword">char</span>[len+<span class="number">1</span>];</div><div class="line">	rewind(pFile);</div><div class="line">	fread(pBuf, <span class="number">1</span>, len, pFile);</div><div class="line">	pBuf[len] = <span class="number">0</span>;</div><div class="line">	fclose(pFile);</div><div class="line">	MessageBox(pBuf);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="二进制文件和文本文件">二进制文件和文本文件</h3>
<p>代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CFileView::OnFileWrite() </div><div class="line">&#123;</div><div class="line">	FILE *pFile = fopen(<span class="string">"2.txt"</span>, <span class="string">"w"</span>);</div><div class="line">	<span class="keyword">char</span> ch[<span class="number">3</span>];</div><div class="line">	ch[<span class="number">0</span>] = <span class="string">'a'</span>;</div><div class="line">	ch[<span class="number">1</span>] = <span class="number">10</span>;</div><div class="line">	ch[<span class="number">2</span>] = <span class="string">'b'</span>;</div><div class="line">	fwrite(ch, <span class="number">1</span>, <span class="number">3</span>, pFile);</div><div class="line">	fclose(pFile);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> CFileView::OnFileRead() </div><div class="line">&#123;</div><div class="line">	FILE *pFile = fopen(<span class="string">"2.txt"</span>,<span class="string">"r"</span>);</div><div class="line">	<span class="keyword">char</span> ch[<span class="number">100</span>];</div><div class="line">	fread(ch, <span class="number">1</span>, <span class="number">3</span>, pFile);</div><div class="line">	ch[<span class="number">3</span>] = <span class="number">0</span>;</div><div class="line">	fclose(pFile);</div><div class="line">	MessageBox(ch);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>效果：
　　
<img src="http://img.blog.csdn.net/20170420225018961?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>文本方式：10实际上是换行符的ASCII码。</p>
<p>以文本方式和二进制方式读取文件是有明显的区别的。</p>
<h3 id="文本方式和二进制方式">文本方式和二进制方式</h3>
<p>二进制方式：换行是由两个字符组成的，即ASCII码10（回车符）和13（换行符）。
　　写入和读取文件时要保持一致。如果采用文本方式写入，应采用文本方式读取；如果采用二进制方式写入数据，在读取时也应采用二进制方式。</p>
<p>面试题：给你一个整数，如：98341，将这个整数保存到文件中，要求在以记事本程序打开该文件时，显示的是：98341。
　　法一：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CFileView::OnFileWrite() </div><div class="line">&#123;</div><div class="line">	FILE *pFile = fopen(<span class="string">"3.txt"</span>, <span class="string">"w"</span>);</div><div class="line">	<span class="keyword">char</span> ch[<span class="number">5</span>];</div><div class="line">	ch[<span class="number">0</span>] = <span class="number">9</span> + <span class="number">48</span>;</div><div class="line">	ch[<span class="number">1</span>] = <span class="number">8</span> + <span class="number">48</span>;</div><div class="line">	ch[<span class="number">2</span>] = <span class="number">3</span> + <span class="number">48</span>;</div><div class="line">	ch[<span class="number">3</span>] = <span class="number">4</span> + <span class="number">48</span>;</div><div class="line">	ch[<span class="number">4</span>] = <span class="number">1</span> + <span class="number">48</span>;</div><div class="line"></div><div class="line">	fwrite(ch, <span class="number">1</span>, <span class="number">5</span>, pFile);</div><div class="line">	fclose(pFile);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>或</p>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CFileView::OnFileWrite() </div><div class="line">&#123;</div><div class="line">	FILE *pFile = fopen(<span class="string">"3.txt"</span>, <span class="string">"w"</span>);</div><div class="line">	<span class="keyword">int</span> i = <span class="number">98341</span>;</div><div class="line">	<span class="keyword">char</span> ch[<span class="number">5</span>];</div><div class="line">	itoa(i, ch, <span class="number">10</span>);</div><div class="line"></div><div class="line">	fwrite(ch, <span class="number">1</span>, <span class="number">5</span>, pFile);</div><div class="line">	fclose(pFile);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>面试题：给定一个字符串，其中既有数字字符，又有26个英文字母中的几个字符，让你判断一下哪些是数字字符。</p>
<p>对这种问题，实际上就是判断各字符的ASCII码，对于数字字符来说，它们的ASCII码大于等于48，小于等于57。</p>
<h2 id="c对文件操作的支持">C++对文件操作的支持</h2>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CFileView::OnFileWrite() </div><div class="line">&#123;</div><div class="line">	<span class="function">ofstream <span class="title">ofs</span><span class="params">(<span class="string">"4.txt"</span>)</span></span>;</div><div class="line">	ofs.write(<span class="string">"http://www.sunxin.org"</span>,<span class="built_in">strlen</span>(<span class="string">"http://www.sunxin.org"</span>));</div><div class="line">	ofs.close;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> CFileView::OnFileRead() </div><div class="line">&#123;</div><div class="line">	<span class="function">ifstream <span class="title">ifs</span><span class="params">(<span class="string">"4.txt"</span>)</span></span>;</div><div class="line">	<span class="keyword">char</span> ch[<span class="number">100</span>];</div><div class="line">	<span class="built_in">memset</span>(ch, <span class="number">0</span>, <span class="number">100</span>);</div><div class="line">	ifs.read(ch,<span class="number">100</span>);</div><div class="line">	ifs.close();</div><div class="line">	MessageBox(ch);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="win32-api-对文件操作的支持">Win32 API 对文件操作的支持</h2>
<h3 id="文件的创建-打开和写入">文件的创建、打开和写入</h3>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CFileView::OnFileWrite() </div><div class="line">&#123;</div><div class="line">	<span class="comment">//定义一个句柄变量</span></div><div class="line">	HANDLE hFile;</div><div class="line">	<span class="comment">//创建文件</span></div><div class="line">	hFile = CreateFile(<span class="string">"5.txt"</span>, GENERIC_WRITE, <span class="number">0</span>, <span class="literal">NULL</span>, CREATE_NEW, </div><div class="line">		FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</div><div class="line">	<span class="comment">//接收实际写入的字节数</span></div><div class="line">	DWORD dwWrites;</div><div class="line">	<span class="comment">//写入数据</span></div><div class="line">	WriteFile(hFile,<span class="string">"http://www.sunxin.org"</span>,<span class="built_in">strlen</span>(<span class="string">"http://www.sunxin.org"</span>),</div><div class="line">		&amp;dwWrites, <span class="literal">NULL</span>);</div><div class="line">	<span class="comment">//关闭文件句柄</span></div><div class="line">	CloseHandle(hFile);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="文件的读取">文件的读取</h3>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CFileView::OnFileRead() </div><div class="line">&#123;</div><div class="line">	HANDLE hFile;</div><div class="line">	<span class="comment">//打开文件</span></div><div class="line">	hFile = CreateFile(<span class="string">"5.txt"</span>, GENERIC_READ, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</div><div class="line">	<span class="comment">//接收实际收到的数据</span></div><div class="line">	<span class="keyword">char</span> ch[<span class="number">100</span>];</div><div class="line">	<span class="comment">//接收实际读取到的字节数</span></div><div class="line">	DWORD dwReads;</div><div class="line">	<span class="comment">//读取数据</span></div><div class="line">	ReadFile(hFile, ch, <span class="number">100</span>, &amp;dwReads, <span class="literal">NULL</span>);</div><div class="line">	<span class="comment">//设置字符串结束字符</span></div><div class="line">	ch[dwReads] = <span class="number">0</span>;</div><div class="line">	<span class="comment">//关闭打开的文件对象的句柄</span></div><div class="line">	CloseHandle(hFile);</div><div class="line">	<span class="comment">//显示读取到的数据</span></div><div class="line">	MessageBox(ch);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="菜单">菜单</h1>
<h2 id="菜单命令响应函数">菜单命令响应函数</h2>
<p>新建一个单文档的MFC AppWizard(exe)工程，工程名为Menu。Build运行。</p>
<p><img src="http://img.blog.csdn.net/20170420225058617?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述">
　　左上角点击按钮，可以让属性框始终显示，不会因为点击对话框以外的地方就消失。
　　去掉Pop-up弹出前的勾，将ID改为ID_TEST。给Test添加响应函数在CMainFrame中，在函数中加入	MessageBox(&quot;MainFrame Clicked&quot;);
　　效果：
<img src="http://img.blog.csdn.net/20170420225116851?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h2 id="菜单命令的路由">菜单命令的路由</h2>
<h3 id="程序类对菜单命令的响应顺序">程序类对菜单命令的响应顺序</h3>
<p>响应Test
　　菜单项命令的顺序依次是：视类、文档类、框架类，最后才是应用程序类。</p>
<h3 id="windows消息的分类">Windows消息的分类</h3>
<p>凡是从CWnd派生的类，它们既可以接收标准消息，也可以接收命令消息和通告消息。而对于那些从CCmdTarget派生的类，则只能接收命令消息和通告消息，不能接收标准消息。
本例中的文档类（CMenuDoc）和应用程序类（CWinApp），因为它们都派生于CCmdTarget类，所以它们可以接收菜单命令消息。但它们不是从CWnd类派生的，所以不能接收标准消息。</p>
<h3 id="菜单命令的路由">菜单命令的路由</h3>
<p>菜单命令消息路由的具体过程：当点击某个菜单项时，最先接收到这个菜单命令消息的是框架类。框架类将把接收到的这个消息交给它的子窗口，即视类，由视类首先进行处理。视类首先根据命令消息映射机制查找自身是否对此消息进行了响应，如果响应了，就调用相应响应函数对这个消息进行处理，消息路由过程结束；如果视类没有对此命令消息做出响应，就交由文档类，文档类同样查找自身是否对这个菜单命令进行了响应，如果响应了，就由文档类的命令消息响应函数进行处理，路由过程结束。如果文档类也未做出响应，就把这个命令消息交还给视类，后者又把该消息交还给框架类。框架类查看自己是否对这个命令消息进行了响应，如果它也没有做出响应，就把这个菜单命令消息交给应用程序类，由后者来进行处理。</p>
<h2 id="基本菜单操作">基本菜单操作</h2>
<h3 id="标记菜单">标记菜单</h3>
<p>运行刚才创建的Menu程序，点击查看，前面都有一个对号，这种类型就是标记菜单。
在CMainFrame类的OnCreate的return语句之前添加这句代码	GetMenu()-&gt;GetSubMenu(0)-&gt;CheckMenuItem(0, MF_BYPOSITION | MF_CHECKED);  或者GetMenu()-&gt;GetSubMenu(0)-&gt;CheckMenuItem(ID_FILE_NEW, MF_BYCOMMAND | MF_CHECKED);<br>
　　Build并运行，可发现新建左边已添加一个复选标记。</p>
<h3 id="默认菜单项">默认菜单项</h3>
<p>在刚才的代码下，添加	GetMenu()-&gt;GetSubMenu(0)-&gt;SetDefaultItem(1, TRUE); 或者GetMenu()-&gt;GetSubMenu(0)-&gt;SetDefaultItem(ID_FILE_OPEN,  FALSE);  编译运行，会发现“打开”变成了粗体。</p>
<p><strong>注意：“打印”的索引是5，不是4。计算菜单项索引时，一定要把分割栏菜单项计算在内。并且，一个子菜单只能有一个默认菜单项。</strong></p>
<h3 id="图形标记菜单">图形标记菜单</h3>
<p>Insert-Resource-Bitmap，创建一个位图资源。如图。
<img src="http://img.blog.csdn.net/20170420225150945?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述">
　　为CMainFrame类添加一个CBitmap类型的成员变量：m_bitmap。</p>
<p>接着添加代码：
	CString str;
	str.Format(&quot;x=%d&quot;,y=%d&quot;, GetSystemMetrics(SM_CXMENUCHECK),GetSystemMetrics(SM_CYMENUCHECK));
	MessageBox(str);
	m_bitmap.LoadBitmap(IDB_BITMAP1);
	GetMenu()-&gt;GetSubMenu(0)-&gt;SetMenuItemBitmaps(0, MF_BYPOSITION, &amp;m_bitmap, &amp;m_bitmap);</p>
<h3 id="禁用菜单项">禁用菜单项</h3>
<p>通常把MF_GRAYED和MF_DISABLED这两个标志放在一起使用。不过这么做并不是必需的。
　　删除之前的代码，写入	GetMenu()-&gt;GetSubMenu(0)-&gt;EnableMenuItem(1, MF_BYPOSITION | MF_DISABLED | MF_GRAYED);
　　打开“文件”子菜单，发现“打开”菜单栏变灰，点击不起作用。</p>
<h3 id="移除和装载菜单">移除和装载菜单</h3>
<p>再添加一行代码：	SetMenu(NULL);  此时菜单栏被移除了。
　　再添加几行代码：    	
CMenu menu;
	menu.LoadMenu(IDR_MAINFRAME);
	SetMenu(&amp;menu);
	menu.Detach();
　　此时菜单栏又装载了。
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">CMenu menu;</div><div class="line">menu.CreateMenu();</div><div class="line">GetMenu()-&gt;AppendMenu(MF_POPUP, (UINT)menu.m_hMenu, <span class="string">"Test1"</span>);</div><div class="line">menu.AppendMenu(MF_STRING, <span class="number">111</span>, <span class="string">"Hello"</span>);</div><div class="line">menu.AppendMenu(MF_STRING, <span class="number">112</span>, <span class="string">"Bye"</span>);</div><div class="line">menu.AppendMenu(MF_STRING, <span class="number">113</span>, <span class="string">"Mybole"</span>);</div><div class="line"></div><div class="line"></div><div class="line">menu.Detach();</div><div class="line"></div><div class="line">CMenu menu1;</div><div class="line">menu1.CreateMenu();</div><div class="line">GetMenu()-&gt;InsertMenu(<span class="number">2</span>, MF_POPUP | MF_BYPOSITION, (UINT)menu1. m_hMenu,<span class="string">"Test"</span>);</div><div class="line"></div><div class="line"></div><div class="line">menu1.Detach();</div><div class="line"></div><div class="line">GetMenu()-&gt;GetSubMenu(<span class="number">2</span>)-&gt;AppendMenu(MF_STRING, <span class="number">118</span>, <span class="string">"Welcome"</span>);</div><div class="line">GetMenu()-&gt;GetSubMenu(<span class="number">0</span>)-&gt;AppendMenu(MF_STRING, <span class="number">114</span>, <span class="string">"Welcome"</span>);</div><div class="line">GetMenu()-&gt;GetSubMenu(<span class="number">0</span>)-&gt;InsertMenu(ID_FILE_OPEN, MF_BYCOMMAND | MF_STRING, <span class="number">115</span>, <span class="string">"VC编程"</span>);</div></pre></td></tr></table></figure></p>
<h3 id="mfc菜单命令更新机制">MFC菜单命令更新机制</h3>
<p><img src="http://img.blog.csdn.net/20170420225218087?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>MFC命令更新机制：当要显示菜单时，操作系统发出WM_INITMENUPOPOP消息，然后由程序窗口的基类如CFrameWnd接管，它会创建一个CCmdUI对象，并与程序的第一个菜单项相关联，调用该对象的一个成员函数DoUpdate()。这个函数发出CN_UPDATE_COMMAND_UI消息，这条消息带有一个指向CCmdUI对象的指针。这时，系统会判断是否存在一个ON_UPDATE_COMMAND_UI宏去捕获这个菜单项消息。如果找到这样一个宏，就调用相应的消息响应函数进行处理，在这个函数中，可以利用传递过来的CCmdUI对象去调用相应的函数，使该菜单项可以使用，或禁用该菜单项。当更新完第一个菜单项后，同一个CCmdUI对象就设置为与第二个菜单项相关联，依此顺序进行，直到完成所有菜单项的处理。</p>
<p>添加代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CMainFrame::OnUpdateEditCut(CCmdUI* pCmdUI) </div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add your command update UI handler code here</span></div><div class="line">	pCmdUI-&gt;Enable();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>编辑-剪切 可用了。
　　如果要把工具栏上的一个工具按钮与菜单栏中的某个菜单项相关联，只要将它们的ID设置为同一个标识就可以了。</p>
<p>如果希望禁用文件-新建，为ID_FILE_NEW添加UPDATE_COMMAND_UI消息响应函数。
　　代码如下：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">void</span> CMainFrame::OnUpdateFileNew(CCmdUI* pCmdUI) </div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add your command update UI handler code here</span></div><div class="line">	pCmdUI-&gt;Enable(FALSE);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>或者
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CMainFrame::OnUpdateFileNew(CCmdUI* pCmdUI) </div><div class="line">&#123;</div><div class="line">	<span class="keyword">if</span> (<span class="number">2</span> == pCmdUI-&gt;m_nIndex)</div><div class="line">	pCmdUI-&gt;Enable();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="快捷菜单">快捷菜单</h3>
<p>1. 新增一个新的菜单资源。点开，顶级菜单设置任意的文本，如abc。添加两个菜单项：
　　显示 IDM_SHOW
　　退出 IDM_EXIT
　　2. 给CMenuView类添加WM_RBUTTONDOWN消息响应函数。
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CMenu2View::OnRButtonDown(UINT nFlags, CPoint point) </div><div class="line">&#123;</div><div class="line">	CMenu menu;</div><div class="line">	menu.LoadMenu(IDR_MENU1);</div><div class="line">	CMenu* pPopup = menu.GetSubMenu(<span class="number">0</span>);</div><div class="line">	ClientToScreen(&amp;point);</div><div class="line">	pPopup-&gt;TrackPopupMenu(TPM_LEFTALIGN | TPM_RIGHTBUTTON, point.x, point.y, <span class="keyword">this</span>);</div><div class="line"></div><div class="line">	CView::OnRButtonDown(nFlags, point);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>效果：
　　
<img src="http://img.blog.csdn.net/20170420225352728?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt=""></p>
<p>3.对“显示”右键ClassWizard，可以取消创建新类的询问。分别为CMainFrame类和CMenuView类添加一个响应。
　　代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CMenu2View::OnShow() </div><div class="line">&#123;</div><div class="line">	MessageBox(<span class="string">"View show"</span>);	</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CMainFrame::OnShow() </div><div class="line">&#123;</div><div class="line">	MessageBox(<span class="string">"Main show"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果是显示“View show”。说明只有视类才能对快捷菜单项命令做出响应。若想让CMainView类对此快捷菜单项进行响应的话，修改代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CMenu2View::OnRButtonDown(UINT nFlags, CPoint point) </div><div class="line">&#123;</div><div class="line">	CMenu menu;</div><div class="line">	menu.LoadMenu(IDR_MENU1);</div><div class="line">	CMenu* pPopup = menu.GetSubMenu(<span class="number">0</span>);</div><div class="line">	ClientToScreen(&amp;point);</div><div class="line">	<span class="comment">//pPopup-&gt;TrackPopupMenu(TPM_LEFTALIGN | TPM_RIGHTBUTTON, point.x, point.y, this);</span></div><div class="line">	pPopup-&gt;TrackPopupMenu(TPM_LEFTALIGN | TPM_RIGHTBUTTON, point.x, point.y, GetParent());</div><div class="line"></div><div class="line">	CView::OnRButtonDown(nFlags, point);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>同时删去视类的显示。</p>
<h2 id="动态菜单操作">动态菜单操作</h2>
<h3 id="添加菜单项目">添加菜单项目</h3>
<p>在CMainFrame类的OnCreate函数中添加代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">CMenu menu;</div><div class="line">menu.CreateMenu();</div><div class="line">GetMenu()-&gt;AppendMenu(MF_POPUP, (UINT)menu.m_hMenu, <span class="string">"Test"</span>);</div><div class="line">menu.Detach();</div></pre></td></tr></table></figure></p>
<h3 id="插入菜单项目">插入菜单项目</h3>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">CMenu menu;</div><div class="line">menu.CreateMenu();</div><div class="line"><span class="comment">/*GetMenu()-&gt;AppendMenu(MF_POPUP, (UINT)menu.m_hMenu, "Test");</span></div><div class="line">menu.Detach();*/</div><div class="line">GetMenu()-&gt;InsertMenu(<span class="number">2</span>, MF_POPUP | MF_BYPOSITION, (UINT)menu. m_hMenu,<span class="string">"Test"</span>);</div><div class="line">menu.Detach();</div></pre></td></tr></table></figure></p>
<p>如果要在新插入的子菜单中添加菜单项的话，同样可以使用AppendMenu函数来实现。
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">CMenu menu;</div><div class="line">	menu.CreateMenu();</div><div class="line">	<span class="comment">/*GetMenu()-&gt;AppendMenu(MF_POPUP, (UINT)menu.m_hMenu, "Test");</span></div><div class="line">	menu.Detach();*/</div><div class="line">	GetMenu()-&gt;InsertMenu(<span class="number">2</span>, MF_POPUP | MF_BYPOSITION, (UINT)menu. m_hMenu,<span class="string">"Test"</span>);</div><div class="line"></div><div class="line">	menu.AppendMenu(MF_STRING, <span class="number">111</span>, <span class="string">"Hello"</span>);</div><div class="line">	menu.AppendMenu(MF_STRING, <span class="number">112</span>, <span class="string">"Bye"</span>);</div><div class="line">	menu.AppendMenu(MF_STRING, <span class="number">113</span>, <span class="string">"Mybole"</span>);</div><div class="line">	menu.Detach();</div></pre></td></tr></table></figure></p>
<p>111、112、113是随便赋予的ID号。
　　
<img src="http://img.blog.csdn.net/20170420230125731?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>若要在“文件”子菜单下添加一个菜单项Welcome，再添加一行代码：	GetMenu()-&gt;GetSubMenu(0)-&gt;AppendMenu(MF_STRING, 114, &quot;Welcome&quot;);
　　若要在“文件”中的“新建”和“打开”插入一个菜单项VC编程，再添加一行代码：
	GetMenu()-&gt;GetSubMenu(0)-&gt;InsertMenu(ID_FILE_OPEN, MF_BYCOMMAND | MF_STRING, 115， &quot;VC编程&quot;);</p>
<h3 id="删除菜单">删除菜单</h3>
<p>删除“编辑”：在CMainFrame类的OnCreate函数最后（return之前）添加：
　　GetMenu()-&gt;DeleteMenu(1, MF_BYPOSITION);
　　删除“文件”下的“打开”：
　　GetMenu()-&gt;GetSubMenu(0)-&gt;DeleteMenu(2, MF_BYPOSITION);</p>
<h3 id="动态添加的菜单项的命令响应">动态添加的菜单项的命令响应</h3>
<p>Resource.h中添加新ID
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IDM_HELLO	111</span></div><div class="line">将menu.AppendMenu(MF_STRING, <span class="number">111</span>, “Hello”); 改为 menu.AppendMenu(MF_STRING, IDM_HELLO, “Hello”);</div><div class="line"></div><div class="line">　　三部曲：</div><div class="line">　　<span class="number">1.</span>	点开MainFrm.h，增加为</div><div class="line">```C++</div><div class="line"><span class="comment">//&#123;&#123;AFX_MSG(CMainFrame)</span></div><div class="line">	<span class="function">afx_msg <span class="keyword">int</span> <span class="title">OnCreate</span><span class="params">(LPCREATESTRUCT lpCreateStruct)</span></span>;</div><div class="line">	<span class="function">afx_msg <span class="keyword">void</span> <span class="title">OnShow</span><span class="params">()</span></span>;</div><div class="line">	<span class="comment">//&#125;&#125;AFX_MSG</span></div><div class="line">	<span class="function">afx_msg <span class="keyword">void</span> <span class="title">OnHello</span><span class="params">()</span></span>;</div><div class="line">	DECLARE_MESSAGE_MAP()</div></pre></td></tr></table></figure></p>
<p>2. 点开MainFrm.cpp，增加为
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">BEGIN_MESSAGE_MAP(CMainFrame, CFrameWnd)</div><div class="line">	<span class="comment">//&#123;&#123;AFX_MSG_MAP(CMainFrame)</span></div><div class="line">	ON_WM_CREATE()</div><div class="line">	ON_COMMAND(IDM_SHOW, OnShow)</div><div class="line">	ON_COMMAND(IDM_HELLO, OnHello)</div><div class="line">	<span class="comment">//&#125;&#125;AFX_MSG_MAP</span></div><div class="line">END_MESSAGE_MAP()</div></pre></td></tr></table></figure></p>
<p>3. CMainFrame类中添加
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CMainFrame::OnHello()</div><div class="line">&#123;</div><div class="line">	MessageBox(<span class="string">"Hello"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="电话本示例程序">电话本示例程序</h2>
<p>删除之前写入CMainFrame类的OnCreate函数，留下原始函数。</p>
<h3 id="动态添加子菜单的实现">动态添加子菜单的实现</h3>
<p>利用ClassWizard添加WM_CHAR消息。在Menu2View.h中添加：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span>:</div><div class="line">	<span class="keyword">int</span> m_nIndex;</div><div class="line">	CMenu m_menu;</div></pre></td></tr></table></figure></p>
<p>在Menu2View.cpp里，添加：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">CMenu2View::CMenu2View()</div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> add construction code here</span></div><div class="line">	m_nIndex = <span class="number">-1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="显示输入的字符">显示输入的字符</h3>
<h3 id="添加菜单项及其命令响应函数">添加菜单项及其命令响应函数</h3>
<p>在资源编辑器中打开程序的菜单，在“帮助”后添加一个新菜单abc，添加4个菜单项。名称为1，ID为IDM_PHONE1，以此类推。用ClassWizard为CMenu2View类分别加上这四个菜单项的命令响应函数。
　　修改CMenu2View类的头文件，如下：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span>:</div><div class="line">	<span class="comment">//&#123;&#123;AFX_MSG(CMenu2View)</span></div><div class="line">	<span class="function">afx_msg <span class="keyword">void</span> <span class="title">OnRButtonDown</span><span class="params">(UINT nFlags, CPoint point)</span></span>;</div><div class="line">	<span class="function">afx_msg <span class="keyword">void</span> <span class="title">OnChar</span><span class="params">(UINT nChar, UINT nRepCnt, UINT nFlags)</span></span>;</div><div class="line">	<span class="function">afx_msg <span class="keyword">void</span> <span class="title">OnPhone1</span><span class="params">()</span></span>;</div><div class="line">	<span class="function">afx_msg <span class="keyword">void</span> <span class="title">OnPhone2</span><span class="params">()</span></span>;</div><div class="line">	<span class="function">afx_msg <span class="keyword">void</span> <span class="title">OnPhone3</span><span class="params">()</span></span>;</div><div class="line">	<span class="function">afx_msg <span class="keyword">void</span> <span class="title">OnPhone4</span><span class="params">()</span></span>;</div><div class="line">	<span class="comment">//&#125;&#125;AFX_MSG</span></div><div class="line">	DECLARE_MESSAGE_MAP()</div></pre></td></tr></table></figure></p>
<p>CMenu2View.cpp中，
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">	<span class="comment">//&#123;&#123;AFX_MSG_MAP(CMenu2View)</span></div><div class="line">	ON_WM_CHAR()</div><div class="line">	<span class="comment">//&#125;&#125;AFX_MSG_MAP</span></div><div class="line">	ON_COMMAND(IDM_PHONE1, OnPhone1)</div><div class="line">	ON_COMMAND(IDM_PHONE2, OnPhone2)</div><div class="line">	ON_COMMAND(IDM_PHONE3, OnPhone3)</div><div class="line">	ON_COMMAND(IDM_PHONE4, OnPhone4)</div><div class="line">	<span class="comment">// Standard printing commands</span></div><div class="line">	ON_COMMAND(ID_FILE_PRINT, CView::OnFilePrint)</div><div class="line">	ON_COMMAND(ID_FILE_PRINT_DIRECT, CView::OnFilePrint)</div><div class="line">	ON_COMMAND(ID_FILE_PRINT_PREVIEW, CView::OnFilePrintPreview)</div><div class="line">END_MESSAGE_MAP()</div></pre></td></tr></table></figure></p>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CMenu2View::OnPhone1() </div><div class="line">&#123;</div><div class="line">	<span class="function">CClientDC <span class="title">dc</span><span class="params">(<span class="keyword">this</span>)</span></span>;</div><div class="line">	dc.TextOut(<span class="number">0</span>, <span class="number">0</span>, m_strArray.GetAt(<span class="number">0</span>));</div><div class="line">	</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> CMenu2View::OnPhone2() </div><div class="line">&#123;</div><div class="line">	<span class="function">CClientDC <span class="title">dc</span><span class="params">(<span class="keyword">this</span>)</span></span>;</div><div class="line">	dc.TextOut(<span class="number">0</span>, <span class="number">0</span>, m_strArray.GetAt(<span class="number">1</span>));</div><div class="line">	</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> CMenu2View::OnPhone3() </div><div class="line">&#123;</div><div class="line">	<span class="function">CClientDC <span class="title">dc</span><span class="params">(<span class="keyword">this</span>)</span></span>;</div><div class="line">	dc.TextOut(<span class="number">0</span>, <span class="number">0</span>, m_strArray.GetAt(<span class="number">2</span>));</div><div class="line">	</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> CMenu2View::OnPhone4() </div><div class="line">&#123;</div><div class="line">	<span class="function">CClientDC <span class="title">dc</span><span class="params">(<span class="keyword">this</span>)</span></span>;</div><div class="line">	dc.TextOut(<span class="number">0</span>, <span class="number">0</span>, m_strArray.GetAt(<span class="number">3</span>));</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="框架类窗口截获菜单命令消息">框架类窗口截获菜单命令消息</h3>
<p>右键单击CMainFrame，选择Add Virtual Functions-OnCommand，单击Add Handler，再点击Edit Existing。
<img src="http://img.blog.csdn.net/20170420230209594?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述">
　　代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">BOOL CMainFrame::OnCommand(WPARAM wParam, LPARAM lParam) </div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> MenuCmdID = LOWORD(wParam);</div><div class="line">	CMenu2View *pView = (CMenu2View *)GetActiveView();</div><div class="line">	<span class="keyword">if</span> (MenuCmdID &gt;= IDM_PHONE1 &amp;&amp; MenuCmdID &lt; IDM_PHONE1 + pView-&gt;m_strArray.GetSize())</div><div class="line">	&#123;</div><div class="line">	<span class="comment">//MessageBox("Test");</span></div><div class="line">	<span class="function">CClientDC <span class="title">dc</span><span class="params">(pView)</span></span>;</div><div class="line">	dc.TextOut(<span class="number">0</span>, <span class="number">0</span>, pView-&gt;m_strArray.GetAt(MenuCmdID - IDM_PHONE1));</div><div class="line">	<span class="keyword">return</span> TRUE;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> CFrameWnd::OnCommand(wParam, lParam);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>将MainFrm.cpp里添加#include “Menu2View.h” 。
　　将Menu2View.cpp中的#include “Menu2Doc.h”剪切到Menu2View.h文件的前部（#endif // _MSC_VER &gt; 1000下面）。</p>
<p>最终代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">void</span> CMenu2View::OnChar(UINT nChar, UINT nRepCnt, UINT nFlags) </div><div class="line">&#123;</div><div class="line">	<span class="function">CClientDC <span class="title">dc</span><span class="params">(<span class="keyword">this</span>)</span></span>;</div><div class="line">	<span class="keyword">if</span> (<span class="number">0x0d</span> == nChar)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">if</span> (<span class="number">0</span> == ++m_nIndex)</div><div class="line">		&#123;</div><div class="line">			m_menu.CreatePopupMenu();</div><div class="line">			GetParent()-&gt;GetMenu()-&gt;AppendMenu(MF_POPUP, (UINT)m_menu.m_hMenu, <span class="string">"PhoneBook"</span>);</div><div class="line">			GetParent()-&gt;DrawMenuBar();</div><div class="line">		&#125;</div><div class="line">		m_menu.AppendMenu(MF_STRING, IDM_PHONE1 + m_nIndex, m_strLine.Left(m_strLine.Find(<span class="string">' '</span>)));</div><div class="line">		m_strArray.Add(m_strLine);</div><div class="line">		m_strLine.Empty();</div><div class="line">		Invalidate();</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span></div><div class="line">	&#123;</div><div class="line">		m_strLine += nChar;</div><div class="line">		dc.TextOut(<span class="number">0</span>, <span class="number">0</span>, m_strLine);</div><div class="line">	&#125;</div><div class="line">	CView::OnChar(nChar, nRepCnt, nFlags);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>效果：
<img src="http://img.blog.csdn.net/20170420230235013?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h1 id="简单绘图">简单绘图</h1>
<h2 id="mfc消息映射机制">MFC消息映射机制</h2>
<p>与消息有关的三处信息：1.头文件XXXX.h中 2.源文件XXXX.cpp中 3.源文件XXXX.cpp的响应函数中</p>
<h2 id="绘制线条">绘制线条</h2>
<p>对CDrawView右键点击Add Member Variable，变量名称：m_ptOrigin，类型：CPoint，访问权限设置：Private。
　　代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CDrawView::OnLButtonDown(UINT nFlags, CPoint point) </div><div class="line">&#123;</div><div class="line">	m_ptOrigin = point;</div><div class="line">	CView::OnLButtonDown(nFlags, point);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CDrawView::OnLButtonUp(UINT nFlags, CPoint point) </div><div class="line">&#123;</div><div class="line">	<span class="comment">//首先获得窗口的设备描述表</span></div><div class="line">	HDC hdc;</div><div class="line">	hdc = ::GetDC(m_hWnd);</div><div class="line">	<span class="comment">//移动到线条的起点</span></div><div class="line">	MoveToEx(hdc, m_ptOrigin.x, m_ptOrigin.y, <span class="literal">NULL</span>);</div><div class="line">	<span class="comment">//画线</span></div><div class="line">	LineTo(hdc, point.x, point.y);</div><div class="line">	<span class="comment">//释放设备描述表</span></div><div class="line">	::ReleaseDC(m_hWnd, hdc);</div><div class="line"></div><div class="line">	CView::OnLButtonUp(nFlags, point);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20170420230302938?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h3 id="利用mfc的cdc类实现画线功能">利用MFC的CDC类实现画线功能</h3>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CDrawView::OnLButtonUp(UINT nFlags, CPoint point) </div><div class="line">&#123;</div><div class="line">	<span class="comment">/*//首先获得窗口的设备描述表</span></div><div class="line">	HDC hdc;</div><div class="line">	hdc = ::GetDC(m_hWnd);</div><div class="line">	//移动到线条的起点</div><div class="line">	MoveToEx(hdc, m_ptOrigin.x, m_ptOrigin.y, NULL);</div><div class="line">	//画线</div><div class="line">	LineTo(hdc, point.x, point.y);</div><div class="line">	//释放设备描述表</div><div class="line">	::ReleaseDC(m_hWnd, hdc);*/</div><div class="line"></div><div class="line">	CDC* pDC = GetDC();</div><div class="line">	pDC-&gt;MoveTo(m_ptOrigin);</div><div class="line">	pDC-&gt;LineTo(point);</div><div class="line">	ReleaseDC(pDC);</div><div class="line"></div><div class="line">	CView::OnLButtonUp(nFlags, point);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="利用mfc的cwindowdc类实现画线功能">利用MFC的CWindowDC类实现画线功能</h3>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">void CDrawView::OnLButtonUp(UINT nFlags, CPoint point) </div><div class="line">&#123;</div><div class="line">	CWindowDC dc(GetParent());</div><div class="line">	dc.MoveTo(m_ptOrigin);</div><div class="line">	dc.LineTo(point);</div><div class="line"></div><div class="line">	CView::OnLButtonUp(nFlags, point);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20170420230346873?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h3 id="在桌面窗口中画线">在桌面窗口中画线</h3>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">void CDrawView::OnLButtonUp(UINT nFlags, CPoint point) </div><div class="line">&#123;</div><div class="line">	CWindowDC dc(GetDesktopWindow());</div><div class="line">	dc.MoveTo(m_ptOrigin);</div><div class="line">	dc.LineTo(point);</div><div class="line"></div><div class="line">	CView::OnLButtonUp(nFlags, point);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20170420230404138?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p><strong>注意</strong>：在桌面上画图需要权限（一般写代码时需要避免软件以外的操作）。</p>
<h3 id="绘制彩色线条">绘制彩色线条</h3>
<p>在程序中，当构造一个GDI对象后，该对象并不会立即生效，必须选入设备描述表，它才会在以后的绘制操作中生效。
一般情况下，在完成绘图操作之后，都要利用SelectObject函数把之前的GDI对象选入设备描述表，以便使其恢复到先前的状态。
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">void CDrawView::OnLButtonUp(UINT nFlags, CPoint point) </div><div class="line">&#123;</div><div class="line">	CPen pen(PS_SOLID, 1, RGB(255, 0, 0));</div><div class="line">	CClientDC dc(this);</div><div class="line">	CPen* pOldPen = dc.SelectObject(&amp;pen);</div><div class="line">	dc.MoveTo(m_ptOrigin);</div><div class="line">	dc.LineTo(point);</div><div class="line">	dc.SelectObject(pOldPen);</div><div class="line"></div><div class="line">	CView::OnLButtonUp(nFlags, point);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行的效果是红色线条。</p>
<p>改为	CPen pen(PS_DASH, 1, RGB(255, 0, 0));  是虚线。（其中第二个参数需小于等于10）
	CPen pen(PS_DOT, 1, RGB(255, 0, 0)); 是点线。</p>
<h2 id="使用画刷绘图">使用画刷绘图</h2>
<h3 id="简单画刷">简单画刷</h3>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">void CDrawView::OnLButtonUp(UINT nFlags, CPoint point) </div><div class="line">&#123;</div><div class="line">	//创建一个红色画刷</div><div class="line">	CBrush brush(RGB(255, 0, 0));</div><div class="line">	//创建并获得设备描述表</div><div class="line">	CClientDC dc(this);</div><div class="line">	//利用红色画刷填充鼠标拖拽过程中形成的矩形区域</div><div class="line">	dc.FillRect(CRect(m_ptOrigin, point),&amp;brush);</div><div class="line"></div><div class="line">	CView::OnLButtonUp(nFlags, point);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20170420230440190?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h3 id="位图画刷">位图画刷</h3>
<p>Insert-Resource-Bitmap-New，在这里发挥灵魂画手的天赋吧！
　　代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CDrawView::OnLButtonUp(UINT nFlags, CPoint point) </div><div class="line">&#123;</div><div class="line">	<span class="comment">//创建位图对象</span></div><div class="line">	CBitmap bitmap;</div><div class="line">	<span class="comment">//加载位图资源</span></div><div class="line">	bitmap.LoadBitmap(IDB_BITMAP1);</div><div class="line">	<span class="comment">//创建位图画刷</span></div><div class="line">	<span class="function">CBrush <span class="title">brush</span><span class="params">(&amp;bitmap)</span></span>;</div><div class="line">	<span class="comment">//创建并获得设备描述表</span></div><div class="line">	<span class="function">CClientDC <span class="title">dc</span><span class="params">(<span class="keyword">this</span>)</span></span>;</div><div class="line">	<span class="comment">//利用位图画刷填充鼠标拖拽过程中形成的矩形区域</span></div><div class="line">	dc.FillRect(CRect(m_ptOrigin, point),&amp;brush);</div><div class="line"></div><div class="line">	CView::OnLButtonUp(nFlags, point);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20170420230503092?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述">
　　我画的是不是很滑稽（手动滑稽）</p>
<h3 id="透明画刷">透明画刷</h3>
<p>先进行一种尝试：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CDrawView::OnLButtonUp(UINT nFlags, CPoint point) </div><div class="line">&#123;</div><div class="line">	<span class="comment">//创建并获得设备描述表</span></div><div class="line">	<span class="function">CClientDC <span class="title">dc</span><span class="params">(<span class="keyword">this</span>)</span></span>;</div><div class="line">	<span class="comment">//绘制一个矩形</span></div><div class="line">	dc.Rectangle(CRect(m_ptOrigin,point));</div><div class="line"></div><div class="line">	CView::OnLButtonUp(nFlags, point);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20170420230521295?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述">
　　如果希望矩形内部是透明的，能够看到被遮挡的图形，就要创建一个透明画刷。
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CDrawView::OnLButtonUp(UINT nFlags, CPoint point) </div><div class="line">&#123;</div><div class="line">	<span class="comment">//创建并获得设备描述表</span></div><div class="line">	<span class="function">CClientDC <span class="title">dc</span><span class="params">(<span class="keyword">this</span>)</span></span>;</div><div class="line">	<span class="comment">//创建一个空画刷</span></div><div class="line">	CBrush *pBrush = CBrush::FromHandle((HBRUSH)GetStockObject(NULL_BRUSH));</div><div class="line">	<span class="comment">//将空画刷选入设备描述表</span></div><div class="line">	CBrush *pOldBrush = dc.SelectObject(pBrush);</div><div class="line">	<span class="comment">//绘制一个矩形</span></div><div class="line">	dc.Rectangle(CRect(m_ptOrigin, point));</div><div class="line">	<span class="comment">//恢复先前的画刷</span></div><div class="line">	dc.SelectObject(pOldBrush);</div><div class="line"></div><div class="line">	CView::OnLButtonUp(nFlags, point);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20170420230550253?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h2 id="绘制连续线条">绘制连续线条</h2>
<p>首先为视类增加鼠标移动消息（WM_MOUSEMOVE）的响应函数（默认OnMouseMove），并为视类添加一个BOOL型的私有成员变量m_bDraw。
在视类头文件定义：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">　Private:</div><div class="line">　BOOL m_bDraw;</div></pre></td></tr></table></figure></p>
<p>在视类的构造函数中：	
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">m_bDraw = FALSE;</div></pre></td></tr></table></figure></p>
<p>在OnLButtonDown中：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">m_bDraw = TRUE;</div></pre></td></tr></table></figure></p>
<p>在OnLButtonUp中：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">m_bDraw = FALSE;</div></pre></td></tr></table></figure></p>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CDrawView::OnMouseMove(UINT nFlags, CPoint point) </div><div class="line">&#123;</div><div class="line">	<span class="function">CClientDC <span class="title">dc</span><span class="params">(<span class="keyword">this</span>)</span></span>;</div><div class="line">	<span class="keyword">if</span>(m_bDraw == TRUE)</div><div class="line">	&#123;</div><div class="line">		dc.MoveTo(m_ptOrigin);</div><div class="line">		dc.LineTo(point);</div><div class="line">		<span class="comment">//修改线段的起点</span></div><div class="line">		m_ptOrigin = point;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	CView::OnMouseMove(nFlags, point);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20170420230616957?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>给线条换色：
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">void CDrawView::OnMouseMove(UINT nFlags, CPoint point) </div><div class="line">&#123;</div><div class="line">	CClientDC dc(this);</div><div class="line">		//创建一个红色的、宽度为1的实线画笔</div><div class="line">		CPen pen(PS_SOLID, 1, RGB(255, 0, 0));</div><div class="line">		//把创建的画笔选入设备描述表</div><div class="line">		CPen *pOldPen = dc.SelectObject(&amp;pen);</div><div class="line">		if (m_bDraw == TRUE)</div><div class="line">		&#123;</div><div class="line">		dc.MoveTo(m_ptOrigin);</div><div class="line">		dc.LineTo(point);</div><div class="line">		//修改线段的起点</div><div class="line">		m_ptOrigin = point;</div><div class="line">	&#125;</div><div class="line">	//恢复设备描述表</div><div class="line">		dc.SelectObject(pOldPen);</div><div class="line"></div><div class="line">	CView::OnMouseMove(nFlags, point);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="绘制扇形效果的线条">绘制扇形效果的线条</h2>
<p>去掉上述代码中的 	m_ptOrigin = point;</p>
<p>效果：
　　<img src="http://img.blog.csdn.net/20170420230636254?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>绘制一个带边线的扇形：
　　为CDrawView类增加一个CPoint类型的私有成员变量m_ptOld，用来保存鼠标上一个移动点。</p>
<p>在OnLButton中：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">m_ptOld = point;</div></pre></td></tr></table></figure></p>
<p>在OnMouseMove中：
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">void CDrawView::OnMouseMove(UINT nFlags, CPoint point) </div><div class="line">&#123;</div><div class="line">	CClientDC dc(this);</div><div class="line">		//创建一个红色的、宽度为1的实线画笔</div><div class="line">		CPen pen(PS_SOLID, 1, RGB(255, 0, 0));</div><div class="line">		//把创建的画笔选入设备描述表</div><div class="line">		CPen *pOldPen = dc.SelectObject(&amp;pen);</div><div class="line">		if (m_bDraw == TRUE)</div><div class="line">		&#123;</div><div class="line">		dc.MoveTo(m_ptOrigin);</div><div class="line">		dc.LineTo(point);</div><div class="line">		dc.LineTo(m_ptOld);</div><div class="line">		//修改线段的起点</div><div class="line">		//m_ptOrigin = point;</div><div class="line">		m_ptOld = point;</div><div class="line">	&#125;</div><div class="line">	//恢复设备描述表</div><div class="line">		dc.SelectObject(pOldPen);</div><div class="line"></div><div class="line">	CView::OnMouseMove(nFlags, point);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最好将OnLButtonUp里原来写的代码删除或注释之。
　　效果：
<img src="http://img.blog.csdn.net/20170420230656311?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>MFC提供一个设置绘图模式的函数SetROP2，带有一个参数R2_BLACK、R2_WHITE、R2_MERGENOTPEN等。
　　例如，在CClientDC dc(this); 下方添加代码： 	dc.SetROP2(R2_MERGENOTPEN);  编译运行后看不到绘制的线条，这就是设置了R2_MERGENOTPEN这种绘图模式。
使用R2_BLACK，将会发现绘制的线条颜色始终都是黑色的。</p>
<h1 id="文本编程">文本编程</h1>
<h2 id="插入符">插入符</h2>
<h3 id="创建文本插入符">创建文本插入符</h3>
<p>创建一个单文档类型的MFC AppWizard(exe)工程，取名为Text。
为CTextView类添加WM_CREATE消息的响应函数OnCreate，在此函数中创建一个宽度为20、高度为100的插入符。代码如下。
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> CTextView::OnCreate(LPCREATESTRUCT lpCreateStruct) </div><div class="line">&#123;</div><div class="line">	<span class="keyword">if</span> (CView::OnCreate(lpCreateStruct) == <span class="number">-1</span>)</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">	</div><div class="line">	CreateSolidCaret(<span class="number">20</span>,<span class="number">100</span>);</div><div class="line">	ShowCaret();</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20170420230721832?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>让插入符适应于当前字体的大小：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> CTextView::OnCreate(LPCREATESTRUCT lpCreateStruct) </div><div class="line">&#123;</div><div class="line">	<span class="keyword">if</span> (CView::OnCreate(lpCreateStruct) == <span class="number">-1</span>)</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">	</div><div class="line">	<span class="comment">//创建设备描述表</span></div><div class="line">	<span class="function">CClientDC <span class="title">dc</span><span class="params">(<span class="keyword">this</span>)</span></span>;</div><div class="line">	<span class="comment">//定义文本信息结构体变量</span></div><div class="line">	TEXTMETRIC tm;</div><div class="line">	<span class="comment">//获得设备描述表中的文本信息</span></div><div class="line">	dc.GetTextMetrics(&amp;tm);</div><div class="line">	<span class="comment">//根据字体大小，创建何时的插入符（除以8是经验值）</span></div><div class="line">	CreateSolidCaret(tm.tmAveCharWidth/<span class="number">8</span>, tm.tmHeight);</div><div class="line">	<span class="comment">//显示插入符</span></div><div class="line">	ShowCaret();</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行结果就比较符合常规了。</p>
<h3 id="创建图形插入符">创建图形插入符</h3>
<p>新建一个位图资源，画一个图形。
在TextView.h中添加
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span>:</div><div class="line">		CBitmap bitmap;</div></pre></td></tr></table></figure></p>
<p>代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> CTextView::OnCreate(LPCREATESTRUCT lpCreateStruct) </div><div class="line">&#123;</div><div class="line">	<span class="keyword">if</span> (CView::OnCreate(lpCreateStruct) == <span class="number">-1</span>)</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">	</div><div class="line"></div><div class="line">	bitmap.LoadBitmap(IDB_BITMAP1);</div><div class="line">	CreateCaret(&amp;bitmap);</div><div class="line">	ShowCaret();</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20170420230741630?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h2 id="窗口重绘">窗口重绘</h2>
<h3 id="ondraw函数">OnDraw函数</h3>
<p>实现在程序窗口中输出一串文字的功能。
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CTextView::OnDraw(CDC* pDC)</div><div class="line">&#123;</div><div class="line">	CTextDoc* pDoc = GetDocument();</div><div class="line">	ASSERT_VALID(pDoc);</div><div class="line"></div><div class="line">	<span class="function">CString <span class="title">str</span><span class="params">(<span class="string">"VC++ 深入编程"</span>)</span></span>;</div><div class="line">	pDC-&gt;TextOut(<span class="number">50</span>, <span class="number">50</span>, str);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20170420230758895?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h3 id="添加字符串资源">添加字符串资源</h3>
<p>点击Resource View-String Table选项，在此字符串表最底部的空行上双击，即可弹出添加新字符串资源的对话框。ID：IDS_STRINGVC，Caption：“VC++编程 文本编程”。代码如下。
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CTextView::OnDraw(CDC* pDC)</div><div class="line">&#123;</div><div class="line">	CTextDoc* pDoc = GetDocument();</div><div class="line">	ASSERT_VALID(pDoc);</div><div class="line"></div><div class="line">	<span class="comment">//CString str("VC++ 深入编程");</span></div><div class="line">	CString str;</div><div class="line">	str = <span class="string">"VC++ 深入编程"</span>;</div><div class="line">	pDC-&gt;TextOut(<span class="number">50</span>, <span class="number">50</span>, str);</div><div class="line"></div><div class="line">	str.LoadString(IDS_STRINGVC);</div><div class="line">	pDC-&gt;TextOut(<span class="number">0</span>, <span class="number">200</span>, str);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20170420230814077?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h3 id="路径">路径</h3>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">void</span> CTextView::OnDraw(CDC* pDC)</div><div class="line">&#123;</div><div class="line">	CTextDoc* pDoc = GetDocument();</div><div class="line">	ASSERT_VALID(pDoc);</div><div class="line"></div><div class="line">	<span class="comment">//CString str("VC++ 深入编程");</span></div><div class="line">	CString str;</div><div class="line">	str = <span class="string">"VC++ 深入编程"</span>;</div><div class="line">	pDC-&gt;TextOut(<span class="number">50</span>, <span class="number">50</span>, str);</div><div class="line"></div><div class="line">	CSize sz = pDC-&gt;GetTextExtent(str);</div><div class="line"></div><div class="line">	str.LoadString(IDS_STRINGVC);</div><div class="line">	pDC-&gt;TextOut(<span class="number">0</span>, <span class="number">200</span>, str);</div><div class="line"></div><div class="line">	pDC-&gt;BeginPath();</div><div class="line">	pDC-&gt;Rectangle(<span class="number">50</span>, <span class="number">50</span>, <span class="number">50</span>+sz.cx, <span class="number">50</span>+sz.cy);</div><div class="line">	pDC-&gt;EndPath();</div><div class="line"></div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">300</span>; i+=<span class="number">10</span>)</div><div class="line">	&#123;</div><div class="line">		pDC-&gt;MoveTo(<span class="number">0</span>, i);</div><div class="line">		pDC-&gt;LineTo(<span class="number">300</span>, i);</div><div class="line">		pDC-&gt;MoveTo(i,<span class="number">0</span>);</div><div class="line">		pDC-&gt;LineTo(i,<span class="number">300</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line"> ![这里写图片描述](http:<span class="comment">//img.blog.csdn.net/20170420230830380?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)</span></div><div class="line"></div><div class="line">```C++</div><div class="line"><span class="keyword">void</span> CTextView::OnDraw(CDC* pDC)</div><div class="line">&#123;</div><div class="line">	CTextDoc* pDoc = GetDocument();</div><div class="line">	ASSERT_VALID(pDoc);</div><div class="line"></div><div class="line">	<span class="comment">//CString str("VC++ 深入编程");</span></div><div class="line">	CString str;</div><div class="line">	str = <span class="string">"VC++ 深入编程"</span>;</div><div class="line">	pDC-&gt;TextOut(<span class="number">50</span>, <span class="number">50</span>, str);</div><div class="line"></div><div class="line">	CSize sz = pDC-&gt;GetTextExtent(str);</div><div class="line"></div><div class="line">	str.LoadString(IDS_STRINGVC);</div><div class="line">	pDC-&gt;TextOut(<span class="number">0</span>, <span class="number">200</span>, str);</div><div class="line"></div><div class="line">	pDC-&gt;BeginPath();</div><div class="line">	pDC-&gt;Rectangle(<span class="number">50</span>, <span class="number">50</span>, <span class="number">50</span>+sz.cx, <span class="number">50</span>+sz.cy);</div><div class="line">	pDC-&gt;EndPath();</div><div class="line">	pDC-&gt;SelectClipPath(RGN_DIFF);</div><div class="line"></div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">300</span>; i+=<span class="number">10</span>)</div><div class="line">	&#123;</div><div class="line">		pDC-&gt;MoveTo(<span class="number">0</span>, i);</div><div class="line">		pDC-&gt;LineTo(<span class="number">300</span>, i);</div><div class="line">		pDC-&gt;MoveTo(i,<span class="number">0</span>);</div><div class="line">		pDC-&gt;LineTo(i,<span class="number">300</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20170420230849318?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述">
　　这正是RGN_DIFF模式的效果。
　　如果是RGN_AND，效果是新的裁剪区域是当前裁剪区域和当前路径层的交集。</p>
<p>路径层的作用：实现特殊效果。如，希望整幅图形中某一部分与其他部分有所区别，就可以把这部分的图形设置到一个路径层中，然后利用SelectClipPath函数设置一种模式，让路径层和裁剪区域进行互操作以达到一种特殊效果。</p>
<h2 id="字符输入">字符输入</h2>
<p>当用户在键盘上按下某个字符按键后，要把该字符输出到程序窗口上。
首先让CTextView捕获WM_CHAR消息，接着为该类定义一个CString类型的成员变量：m_strLine，并在CTextView类的构造函数中将这个变量初始化：m_strLine = “”;
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CTextView::OnLButtonDown(UINT nFlags, CPoint point) </div><div class="line">&#123;</div><div class="line">	SetCaretPos(point);</div><div class="line"></div><div class="line">	CView::OnLButtonDown(nFlags, point);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20170420230906115?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述">
　　为CTextView类再增加一个CPoint类型的成员变量，取名m_ptOrigin，权限为私有。在CTextView类的构造函数中设置其初值为0。
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CTextView::OnLButtonDown(UINT nFlags, CPoint point) </div><div class="line">&#123;</div><div class="line">	SetCaretPos(point);</div><div class="line">	m_strLine.Empty();</div><div class="line">	m_ptOrigin = point;</div><div class="line"></div><div class="line">	CView::OnLButtonDown(nFlags, point);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>注意：回车字符的ASCII码十六进制是0x0d，退格键的ASCII码十六进制值是0x08。</strong></p>
<p>最终代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CTextView::OnChar(UINT nChar, UINT nRepCnt, UINT nFlags) </div><div class="line">&#123;</div><div class="line">	<span class="function">CClientDC <span class="title">dc</span><span class="params">(<span class="keyword">this</span>)</span></span>;</div><div class="line">	TEXTMETRIC tm;</div><div class="line">	dc.GetTextMetrics(&amp;tm);</div><div class="line">	<span class="keyword">if</span> (<span class="number">0x0d</span> == nChar)</div><div class="line">	&#123;</div><div class="line">	m_strLine.Empty();</div><div class="line">	m_ptOrigin.y += tm.tmHeight;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(<span class="number">0x08</span> == nChar)</div><div class="line">	&#123;</div><div class="line">		COLORREF clr = dc.SetTextColor(dc.GetBkColor());</div><div class="line">		dc.TextOut(m_ptOrigin.x, m_ptOrigin.y, m_strLine);</div><div class="line">		m_strLine = m_strLine.Left(m_strLine.GetLength() - <span class="number">1</span>);</div><div class="line">		dc.SetTextColor(clr);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span></div><div class="line">	&#123;</div><div class="line">		m_strLine += nChar; </div><div class="line">	&#125;</div><div class="line">	CSize sz = dc.GetTextExtent(m_strLine);</div><div class="line">	CPoint pt;</div><div class="line">	pt.x = m_ptOrigin.x + sz.cx;</div><div class="line">	pt.y = m_ptOrigin.y;</div><div class="line">	SetCaretPos(pt);</div><div class="line"></div><div class="line">	dc.TextOut(m_ptOrigin.x, m_ptOrigin.y, m_strLine);</div><div class="line"></div><div class="line">	</div><div class="line">	CView::OnChar(nChar, nRepCnt, nFlags);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20170420230925890?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h3 id="设置字体">设置字体</h3>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CTextView::OnChar(UINT nChar, UINT nRepCnt, UINT nFlags) </div><div class="line">&#123;</div><div class="line">	<span class="function">CClientDC <span class="title">dc</span><span class="params">(<span class="keyword">this</span>)</span></span>;</div><div class="line">	CFont font;</div><div class="line">	font.CreatePointFont(<span class="number">300</span>, <span class="string">"华文行楷"</span>, <span class="literal">NULL</span>);</div><div class="line">	CFont *pOldFont = dc.SelectObject(&amp;font);</div><div class="line">……</div><div class="line">	dc.SelectObject(pOldFont);</div><div class="line">	</div><div class="line">	CView::OnChar(nChar, nRepCnt, nFlags);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20170420230949366?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h3 id="字幕变色功能的实现">字幕变色功能的实现</h3>
<p>在这个Text例子中，我们在视类的OnCreate 函数中设置定时器，设置一个时间间隔为100ms，标识为1的定时器。
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> CTextView::OnCreate(LPCREATESTRUCT lpCreateStruct) </div><div class="line">&#123;</div><div class="line">	……</div><div class="line"></div><div class="line">	SetTimer(<span class="number">1</span>, <span class="number">100</span>, <span class="literal">NULL</span>);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>给CTextView类添加WM_TIMER消息的响应函数。
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CTextView::OnTimer(UINT nIDEvent) </div><div class="line">&#123;</div><div class="line">	m_nWidth += <span class="number">5</span>;</div><div class="line"></div><div class="line">	<span class="function">CClientDC <span class="title">dc</span><span class="params">(<span class="keyword">this</span>)</span></span>;</div><div class="line">	TEXTMETRIC tm;</div><div class="line">	dc.GetTextMetrics(&amp;tm);</div><div class="line">	CRect rect;</div><div class="line">	rect.left =<span class="number">0</span>;</div><div class="line">	rect.top = <span class="number">200</span>;</div><div class="line">	rect.right = m_nWidth;</div><div class="line">	rect.bottom = rect.top + tm.tmHeight;</div><div class="line"></div><div class="line">	dc.SetTextColor(RGB(<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>));</div><div class="line">	CString str;</div><div class="line">	str.LoadString(IDS_STRINGVC);</div><div class="line">	dc.DrawText(str, rect, DT_LEFT);</div><div class="line">	</div><div class="line">	rect.top = <span class="number">150</span>;</div><div class="line">	rect.bottom = rect.top + tm.tmHeight;</div><div class="line">	dc.DrawText(str, rect, DT_RIGHT);</div><div class="line">	</div><div class="line">	CSize sz = dc.GetTextExtent(str);</div><div class="line">	<span class="keyword">if</span> (m_nWidth &gt; sz.cx)</div><div class="line">	&#123;</div><div class="line">		m_nWidth = <span class="number">0</span>;</div><div class="line">		dc.SetTextColor(RGB(<span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>));</div><div class="line">		dc.TextOut(<span class="number">0</span>, <span class="number">200</span>, str);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	CView::OnTimer(nIDEvent);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>红色渐变效果可看到。
<img src="http://img.blog.csdn.net/20170420231009906?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h1 id="绘图控制">绘图控制</h1>
<h2 id="简单绘图">简单绘图</h2>
<p>新建一个单文档类型的MFC AppWizard(exe)工程，取名：Graphic。
　　添加的菜单项：
<img src="http://img.blog.csdn.net/20170420231023694?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述">
　　给CGraphicView类中添加一个私有变量：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">UINT m_nDrawType;</div></pre></td></tr></table></figure></p>
<p>在视类构造函数中将此变量初始化为0。</p>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CGraphicView::OnDot() </div><div class="line">&#123;</div><div class="line">	m_nDrawType = <span class="number">1</span>;</div><div class="line">	</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> CGraphicView::OnLine() </div><div class="line">&#123;</div><div class="line">	m_nDrawType = <span class="number">2</span>;	</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> CGraphicView::OnRectangle() </div><div class="line">&#123;</div><div class="line">	m_nDrawType = <span class="number">3</span>;	</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> CGraphicView::OnEllipse() </div><div class="line">&#123;</div><div class="line">	m_nDrawType = <span class="number">4</span>;	</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>CGraphicView类再增加一个CPoint类型的私有成员变量：m_ptOrigin。在CGraphicView类构造函数中，将该变量的值设置为0。
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">void CGraphicView::OnLButtonDown(UINT nFlags, CPoint point) </div><div class="line">&#123;</div><div class="line">	m_ptOrigin = point;</div><div class="line">	</div><div class="line">	CView::OnLButtonDown(nFlags, point);</div><div class="line">&#125;</div><div class="line"></div><div class="line">void CGraphicView::OnLButtonUp(UINT nFlags, CPoint point) </div><div class="line">&#123;</div><div class="line">	CClientDC dc(this);</div><div class="line">	//为边框设定颜色</div><div class="line">	CPen pen(PS_SOLID, 1, RGB(255, 0, 0));</div><div class="line">	dc.SelectObject(&amp;pen);</div><div class="line">	//能看到图形内部内容(透明)</div><div class="line">	CBrush *pBrush = CBrush::FromHandle((HBRUSH)GetStockObject(NULL_BRUSH));</div><div class="line">	dc.SelectObject(pBrush);</div><div class="line"></div><div class="line">	switch(m_nDrawType)</div><div class="line">	&#123;</div><div class="line">	case 1:</div><div class="line">		dc.SetPixel(point,RGB(255, 0, 0));</div><div class="line">		break;</div><div class="line">	case 2:</div><div class="line">		dc.MoveTo(m_ptOrigin);</div><div class="line">		dc.LineTo(point);</div><div class="line">		break;</div><div class="line">	case 3:</div><div class="line">		dc.Rectangle(CRect(m_ptOrigin,point));</div><div class="line">		break;</div><div class="line">	case 4:</div><div class="line">		dc.Ellipse(CRect(m_ptOrigin, point));</div><div class="line">		break;</div><div class="line">	&#125;</div><div class="line">	CView::OnLButtonUp(nFlags, point);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20170420231045554?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h2 id="设置对话框">设置对话框</h2>
<p>再增加一个对话框资源，ID为IDD_DLG_SETTING，Caption为Setting，Font为宋体。</p>
<h3 id="设置线宽">设置线宽</h3>
<p>添加一个静态文本框，并将Caption设为“线宽”。再添加一个编辑框，ID：IDC_LINE_WIDTH。为此对话框资源创建一个响应的对话框类，类名为CSettingDlg。对编辑框右键，ClassWizard，为它添加一个成员变量：m_nLineWidth，类型为UINT。为绘图菜单下再增加一个菜单项为“设置”，ID为IDM_SETTING。为此菜单项添加一个命令响应，选择视类做出响应。为CGraphicView类添加一个私有成员变量：m_nLineWidth，类型：UINT，并在CGraphicView类的构造函数初始化为0。
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CGraphicView::OnSetting() </div><div class="line">&#123;</div><div class="line">	CSettingDlg dlg;</div><div class="line">	dlg.m_nLineWidth = m_nLineWidth; <span class="comment">//将保存的用户先前设置的线宽再传回给该设置对话框</span></div><div class="line">	<span class="keyword">if</span>(IDOK == dlg.DoModal())<span class="comment">//点击OK才保持线宽值</span></div><div class="line">	&#123;</div><div class="line">		m_nLineWidth = dlg.m_nLineWidth;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在源文件前部添加：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Include “SettingDlg.h”</div></pre></td></tr></table></figure></p>
<p>修改OnLButtonUp函数：
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">void CGraphicView::OnLButtonUp(UINT nFlags, CPoint point) </div><div class="line">&#123;</div><div class="line">	CClientDC dc(this);</div><div class="line">	//为边框设定颜色(m_nLineWidth定义线宽)</div><div class="line">	CPen pen(PS_SOLID, m_nLineWidth, RGB(255, 0, 0));</div><div class="line">……</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="设置线型">设置线型</h3>
<p>为对话框资源添加一个组框，Caption设为线型。ID为IDC_LINE_STYLE。在组框内放三个单选按钮，ID不变，名称分别为：实线、虚线、点线（不要改变顺序）。在第一个单选按钮上右键，属性勾上Group，使三个按钮成为一组。再为CGraphicView类添加一个Int类型的私有成员变量m_nLineStyle，在构造函数中初始化为0。
　　由于WINGDI.h定义了一些符号常量，（可以在PS_SOLID右键，Go To Definition Of PS_SOLID），刚好PS_SOLID（实线）值本身就是0；PS_DASH（虚线）是1；PS_DOT（点线）是2。所以此处的排列是故意为之。
<img src="http://img.blog.csdn.net/20170424215210507?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述">
<img src="http://img.blog.csdn.net/20170424215239306?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p><strong>注意：若要画出虚线和点线，线宽只能为0或1。</strong></p>
<h2 id="颜色对话框">颜色对话框</h2>
<p>在绘图下增加一个子菜单，ID为IDM_COLOR，Caption为颜色。为其在视类增加一个命令响应，代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CGraphicView::OnColor() </div><div class="line">&#123;</div><div class="line">	CColorDialog dlg;</div><div class="line">	dlg.m_cc.Flags |= CC_RGBINIT;</div><div class="line">	dlg.m_cc.rgbResult = m_clr;</div><div class="line">	<span class="keyword">if</span> (IDOK == dlg.DoModal())</div><div class="line">	&#123;</div><div class="line">		m_clr = dlg.m_cc.rgbResult;</div><div class="line">		<span class="comment">//dlg.m_cc.Flags |= CC_RGBINIT | CC_FULLOPEN;//让颜色对话框完全展开</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>为CGraphicView类再增加一个COLORREF类型的私有成员变量：m_clr，并在构造函数中初始化为红色：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">m_clr = RGB(<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line"></div><div class="line">　　修改该函数两处位置：</div><div class="line">```C++</div><div class="line"><span class="keyword">void</span> CGraphicView::OnLButtonUp(UINT nFlags, CPoint point) </div><div class="line">&#123;</div><div class="line">	<span class="function">CClientDC <span class="title">dc</span><span class="params">(<span class="keyword">this</span>)</span></span>;</div><div class="line">	<span class="comment">//为边框设定颜色(m_nLineStyle定义线型，m_nLineWidth定义线宽，m_clr定义颜色)</span></div><div class="line">	<span class="function">CPen <span class="title">pen</span><span class="params">(m_nLineStyle, m_nLineWidth, m_clr)</span></span>;</div><div class="line">	dc.SelectObject(&amp;pen);</div><div class="line">	<span class="comment">//能看到图形内部内容(透明)</span></div><div class="line">	CBrush *pBrush = CBrush::FromHandle((HBRUSH)GetStockObject(NULL_BRUSH));</div><div class="line">	dc.SelectObject(pBrush);</div><div class="line"></div><div class="line">	<span class="keyword">switch</span>(m_nDrawType)</div><div class="line">	&#123;</div><div class="line">	<span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">		dc.SetPixel(point,m_clr);</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">		dc.MoveTo(m_ptOrigin);</div><div class="line">		dc.LineTo(point);</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> <span class="number">3</span>:</div><div class="line">		dc.Rectangle(CRect(m_ptOrigin,point));</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> <span class="number">4</span>:</div><div class="line">		dc.Ellipse(CRect(m_ptOrigin, point));</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	&#125;</div><div class="line">	CView::OnLButtonUp(nFlags, point);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20170424215308947?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>注意：//dlg.m_cc.Flags |= CC_RGBINIT | CC_FULLOPEN;//让颜色对话框完全展开
这句我没能实现展开效果。</p>
<h2 id="字体对话框">字体对话框</h2>
<p>增加一个菜单，ID为IDM_FONT，Caption为字体。在视类增加命令响应，代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CGraphicView::OnFont() </div><div class="line">&#123;</div><div class="line">	CFontDialog dlg;</div><div class="line">	<span class="keyword">if</span> (IDOK == dlg.DoModal())</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">if</span> (m_font.m_hObject) <span class="comment">//m_font对象是否已经与某字体资源相关联</span></div><div class="line">			m_font.DeleteObject();</div><div class="line">		m_font.CreateFontIndirect(dlg.m_cf.lpLogFont);</div><div class="line">		m_strFontName = dlg.m_cf.lpLogFont-&gt;lfFaceName;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">void</span> CGraphicView::OnDraw(CDC* pDC)</div><div class="line">&#123;</div><div class="line">	CGraphicDoc* pDoc = GetDocument();</div><div class="line">	ASSERT_VALID(pDoc);</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> add draw code for native data here</span></div><div class="line">	CFont *pOldFont = pDC-&gt;SelectObject(&amp;m_font);</div><div class="line">	pDC-&gt;TextOut(<span class="number">0</span>, <span class="number">0</span>, m_strFontName);</div><div class="line">	pDC-&gt;SelectObject(pOldFont);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="示例对话框">示例对话框</h2>
<p>在对话框中增加一个组框，Caption:示例，ID：IDC_SAMPLE。为CSettingDlg类添加编辑框控件的EN_CHANCE响应函数，对三个单选按钮都选择BN_CLICKED消息。
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CSettingDlg::OnRadio1() </div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add your control notification handler code here</span></div><div class="line">	Invalidate();	</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> CSettingDlg::OnRadio2() </div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add your control notification handler code here</span></div><div class="line">	Invalidate();	</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> CSettingDlg::OnRadio3() </div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add your control notification handler code here</span></div><div class="line">	Invalidate();	</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CSettingDlg::OnPaint() </div><div class="line">&#123;</div><div class="line">	<span class="function">CPaintDC <span class="title">dc</span><span class="params">(<span class="keyword">this</span>)</span></span>; <span class="comment">// device context for painting</span></div><div class="line">	</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add your message handler code here</span></div><div class="line">	UpdateData();</div><div class="line">	<span class="function">CPen <span class="title">pen</span><span class="params">(m_nLineStyle, m_nLineWidth, m_clr)</span></span>;</div><div class="line">	dc.SelectObject(&amp;pen);</div><div class="line"></div><div class="line">	CRect rect;</div><div class="line">	GetDlgItem(IDC_SAMPLE)-&gt;GetWindowRect(&amp;rect);</div><div class="line">	ScreenToClient(&amp;rect);</div><div class="line"></div><div class="line">	dc.MoveTo(rect.left+<span class="number">20</span>, rect.top+rect.Height()/<span class="number">2</span>);</div><div class="line">	dc.LineTo(rect.right<span class="number">-20</span>, rect.top+rect.Height()/<span class="number">2</span>);</div><div class="line">	<span class="comment">// Do not call CDialog::OnPaint() for painting messages</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20170424215335853?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>现在可以实时修改了。</p>
<h2 id="106-改变对话框和控件的背景及文本颜色">10.6 改变对话框和控件的背景及文本颜色</h2>
<h3 id="改变整个对话框及其子控件的背景色">改变整个对话框及其子控件的背景色</h3>
<p>为CSettingDlg类添加WM_CTLCOLOR消息，并定义一个CBrush类型的私有成员变量：m_brush，并在构造函数中初始化一个蓝色画刷：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">m_brush.CreateSolidBrush (RGB(<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>));</div></pre></td></tr></table></figure></p>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">HBRUSH CSettingDlg::OnCtlColor(CDC* pDC, CWnd* pWnd, UINT nCtlColor) </div><div class="line">&#123;</div><div class="line">	HBRUSH hbr = CDialog::OnCtlColor(pDC, pWnd, nCtlColor);</div><div class="line">	</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Change any attributes of the DC here</span></div><div class="line">	</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Return a different brush if the default is not desired</span></div><div class="line">	<span class="comment">//return hbr;</span></div><div class="line">	<span class="keyword">return</span> m_brush;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20170424215356165?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h3 id="仅改变某个子控件的背景及文本颜色">仅改变某个子控件的背景及文本颜色</h3>
<h1 id="图形的保存和重绘">图形的保存和重绘</h1>
<h2 id="坐标空间和转换">坐标空间和转换</h2>
<h3 id="坐标空间">坐标空间</h3>
<p>Win32应用程序编程接口（API）使用四种坐标空间：世界坐标系空间、页面空间、设备空间和物理设备空间。Win32 API把世界坐标系空间和页面空间称为逻辑空间。</p>
<h3 id="转换">转换</h3>
<p>转换是把对象从一个坐标空间复制到另一个坐标空间时改变（或转变）这一对象的大小、方位和形态。</p>
<h2 id="图形的保存和重绘">图形的保存和重绘</h2>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">HBRUSH CSettingDlg::OnCtlColor(CDC* pDC, CWnd* pWnd, UINT nCtlColor) </div><div class="line">&#123;</div><div class="line">	HBRUSH hbr = CDialog::OnCtlColor(pDC, pWnd, nCtlColor);</div><div class="line">	</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Change any attributes of the DC here</span></div><div class="line">	</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Return a different brush if the default is not desired</span></div><div class="line">	<span class="comment">//return hbr;</span></div><div class="line">	<span class="keyword">if</span> (pWnd -&gt; GetDlgCtrlID() == IDC_LINE_STYLE)</div><div class="line">	&#123;</div><div class="line">		pDC-&gt;SetTextColor(RGB(<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>));</div><div class="line">		<span class="keyword">return</span> m_brush;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> hbr;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20170424215530885?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>上述程序再加一行：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pDC-&gt;SetBkMode(TRANSPARENT);</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20170424215545651?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">HBRUSH CSettingDlg::OnCtlColor(CDC* pDC, CWnd* pWnd, UINT nCtlColor) </div><div class="line">&#123;</div><div class="line">	HBRUSH hbr = CDialog::OnCtlColor(pDC, pWnd, nCtlColor);</div><div class="line">	</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Change any attributes of the DC here</span></div><div class="line">	</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Return a different brush if the default is not desired</span></div><div class="line">	<span class="comment">//return hbr;</span></div><div class="line">	<span class="keyword">if</span> (pWnd -&gt; GetDlgCtrlID() == IDC_LINE_STYLE)</div><div class="line">	&#123;</div><div class="line">		pDC-&gt;SetTextColor(RGB(<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>));</div><div class="line">		pDC-&gt;SetBkMode(TRANSPARENT);</div><div class="line">		<span class="keyword">return</span> m_brush;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (pWnd-&gt;GetDlgCtrlID() == IDC_LINE_WIDTH)</div><div class="line">	&#123;</div><div class="line">		pDC-&gt;SetTextColor(RGB(<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>));</div><div class="line">		<span class="comment">//pDC-&gt;SetBkMode(TRANSPARENT);</span></div><div class="line">		pDC-&gt;SetBkColor(RGB(<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>));</div><div class="line">		<span class="keyword">return</span> m_brush;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> hbr;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20170424215606416?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h3 id="改变控件上的文本字体">改变控件上的文本字体</h3>
<p>为对话框增加一个静态文本控件，ID:IDC_TEXT，Caption:程序员，为CSettingDlg类增加一个CFont类型的私有成员变量：m_font，在构造函数中添加
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">m_font.CreatePointFont(<span class="number">200</span>, <span class="string">"华文行楷"</span>);</div></pre></td></tr></table></figure></p>
<p>在OnCtlColor函数中添加：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (pWnd-&gt;GetDlgCtrlID() == IDC_TEXT)</div><div class="line">&#123;</div><div class="line">	pDC-&gt;SelectObject(&amp;m_font);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20170424215622479?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h3 id="改变按钮控件的背景色及文本颜色">改变按钮控件的背景色及文本颜色</h3>
<p>在CSettingDlg类OnCtlColor函数中添加：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">	<span class="keyword">if</span> (pWnd-&gt;GetDlgCtrlID() == IDOK)</div><div class="line">	&#123;</div><div class="line">		pDC-&gt;SetTextColor(RGB(<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>));</div><div class="line">		<span class="keyword">return</span> m_brush;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> hbr;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>点Insert-New Class，选择MFC Class，新增类名：CTestBtn，基类CButton。
　　为此类添加DrawItem虚函数重写。
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CTestBtn::DrawItem(LPDRAWITEMSTRUCT lpDrawItemStruct) </div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add your code to draw the specified item</span></div><div class="line">	UINT uStyle = DFCS_BUTTONPUSH;</div><div class="line"></div><div class="line">	ASSERT(lpDrawItemStruct-&gt;CtlType == ODT_BUTTON);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (lpDrawItemStruct-&gt;itemState &amp; ODS_SELECTED)</div><div class="line">		uStyle |= DFCS_PUSHED;</div><div class="line"></div><div class="line">	::DrawFrameControl(lpDrawItemStruct-&gt;hDC, &amp;lpDrawItemStruct-&gt;rcItem, DFC_BUTTON, uStyle);</div><div class="line"></div><div class="line">	CString strText;</div><div class="line">	GetWindowText(strText);</div><div class="line"></div><div class="line">	COLORREF crOldColor = ::SetTextColor(lpDrawItemStruct-&gt;hDC, RGB(<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>));</div><div class="line">	::DrawText(lpDrawItemStruct-&gt;hDC, strText, strText.GetLength(),</div><div class="line">		&amp;lpDrawItemStruct-&gt;rcItem, DT_SINGLELINE | DT_VCENTER | DT_CENTER);</div><div class="line">	::SetTextColor(lpDrawItemStruct-&gt;hDC, crOldColor);</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然而，此时我返回双击OK键显示“Cannot add new member”……</p>
<p>按理，接下来应该是：
　　利用ClassWizard打开Add Member Variable对话框，为OK按钮关联一个成员变量，名称为m_btnTest，类型CTestBtn。在SettingDlg.h文件前部添加<code>#include “TestBtn.h”</code>。对OK右键属性，打开Styles，选中Owner draw选项。此时OK文字变红色。</p>
<h2 id="位图的显示">位图的显示</h2>
<h1 id="定制应用程序外观">定制应用程序外观</h1>
<h2 id="修改应用程序窗口的外观">修改应用程序窗口的外观</h2>
<h3 id="在窗口创建之前修改">在窗口创建之前修改</h3>
<p>创建前，打开CMainFrame类的PreCreateWindow成员函数，修改CREATETRUCT结构体中的cx和cy成员。
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">BOOL CMainFrame::PreCreateWindow(CREATESTRUCT&amp; cs)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">if</span>( !CFrameWnd::PreCreateWindow(cs) )</div><div class="line">		<span class="keyword">return</span> FALSE;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Modify the Window class or styles here by modifying</span></div><div class="line">	<span class="comment">//  the CREATESTRUCT cs</span></div><div class="line">	cs.cx = <span class="number">300</span>;</div><div class="line">	cs.cy = <span class="number">200</span>;</div><div class="line">	<span class="keyword">return</span> TRUE;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>创建运行，可看到初始大小为300x200的应用程序窗口。</p>
<p>修改窗口标题：在上述 return TRUE; 前添加：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cs.style &amp;= ~FWS_ADDTOTITLE;</div><div class="line">cs.lpszName = <span class="string">"http://www.sunxin.org"</span>;</div></pre></td></tr></table></figure></p>
<h2 id="在窗口创建之后修改">在窗口创建之后修改</h2>
<p>注释掉之前添加的代码。在OnCreate函数中添加：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> CMainFrame::OnCreate(LPCREATESTRUCT lpCreateStruct)</div><div class="line">&#123;</div><div class="line">	…</div><div class="line"></div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Delete these three lines if you don't want the toolbar to</span></div><div class="line">	<span class="comment">//  be dockable</span></div><div class="line">	m_wndToolBar.EnableDocking(CBRS_ALIGN_ANY);</div><div class="line">	EnableDocking(CBRS_ALIGN_ANY);</div><div class="line">	DockControlBar(&amp;m_wndToolBar);</div><div class="line"></div><div class="line">	SetWindowLong(m_hWnd, GWL_STYLE, WS_OVERLAPPEDWINDOW);</div><div class="line"></div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>创建运行后可看到文档标题去掉了。</p>
<p>去掉窗口最大化框类型：
　　将上述SetWindowLong函数替换为
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SetWindowLong(m_hWnd, GWL_STYLE, GetWindowLong(m_hWnd, GWL_STYLE) &amp; ~WS_MAXIMIZEBOX);</div></pre></td></tr></table></figure></p>
<p>创建运行发现最大化框变灰，不能放大窗口了。</p>
<h2 id="修改窗口的光标-图标和背景">修改窗口的光标、图标和背景</h2>
<h3 id="在窗口创建之前修改">在窗口创建之前修改</h3>
<h1 id="网络编程">网络编程</h1>
<h2 id="计算机网络基本知识">计算机网络基本知识</h2>
<p>ISO/OSI七层参考模型
应用层——处理网络应用
Telnet、FTP、HTTP、DNS、SMTP、POP3</p>
<p>表示层——数据表示
TCP、UDP</p>
<p>会话层——主机间通信
传输层——端到端的连接
网络层——寻址和最短路径
IP、ICMP、IGMP</p>
<p>数据链路层——介质访问（接入）
物理层——二进制传输</p>
<h2 id="基于tcp的网络应用程序的编写">基于TCP的网络应用程序的编写</h2>
<h3 id="服务器端程序">服务器端程序</h3>
<p>关闭先前的工作区，新建一个工程，选择Win32 Console Application类型，名为TCPSrv。选择An empty project选项，创建一个空工程。再新建一个C++源文件：TcpSrv.cpp。
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Winsock2.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">	<span class="comment">//加载套接字库</span></div><div class="line">	WORD wVersionRequested;</div><div class="line">	WSADATA wsaData;</div><div class="line">	<span class="keyword">int</span> err;</div><div class="line"></div><div class="line">	wVersionRequested = MAKEWORD(<span class="number">1</span>, <span class="number">1</span>);</div><div class="line"></div><div class="line">	err = WSAStartup(wVersionRequested, &amp;wsaData);</div><div class="line">	<span class="keyword">if</span> (err != <span class="number">0</span>)&#123;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (LOBYTE(wsaData.wVersion) != <span class="number">1</span> ||</div><div class="line">		HIBYTE(wsaData.wVersion) != <span class="number">1</span>)&#123;</div><div class="line">		WSACleanup();</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//创建用于监听的套接字</span></div><div class="line">	SOCKET sockSrv = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</div><div class="line"></div><div class="line">	SOCKADDR_IN addrSrv;</div><div class="line">	addrSrv.sin_addr.S_un.S_addr = htonl(INADDR_ANY);</div><div class="line">	addrSrv.sin_family = AF_INET;</div><div class="line">	addrSrv.sin_port = htons(<span class="number">7000</span>);</div><div class="line"></div><div class="line">	<span class="comment">//绑定套接字</span></div><div class="line">	bind(sockSrv, (SOCKADDR*)&amp;addrSrv, <span class="keyword">sizeof</span>(SOCKADDR));</div><div class="line">	<span class="comment">//将套接字设为监听模式，准备接收客户请求</span></div><div class="line">	listen(sockSrv, <span class="number">5</span>);</div><div class="line"></div><div class="line">	SOCKADDR_IN addrClient;</div><div class="line">	<span class="keyword">int</span> len = <span class="keyword">sizeof</span>(SOCKADDR);</div><div class="line"></div><div class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="comment">//等待客户请求到来</span></div><div class="line">		SOCKET sockConn = accept(sockSrv, (SOCKADDR*)&amp;addrClient, &amp;len);</div><div class="line">		<span class="keyword">char</span> sendBuf[<span class="number">100</span>];</div><div class="line">		<span class="built_in">sprintf</span>(sendBuf, <span class="string">"Welcome %s to http://www.sunxin.org"</span>, inet_ntoa(addrClient.sin_addr));</div><div class="line">		<span class="comment">//发送数据</span></div><div class="line">		send(sockConn, sendBuf, <span class="built_in">strlen</span>(sendBuf)+<span class="number">1</span>, <span class="number">0</span>);</div><div class="line">		<span class="keyword">char</span> recvBuf[<span class="number">100</span>];</div><div class="line">		<span class="comment">//接收数据</span></div><div class="line">		recv(sockConn, recvBuf, <span class="number">100</span>, <span class="number">0</span>);</div><div class="line">		<span class="comment">//打印接收的数据</span></div><div class="line">		<span class="built_in">printf</span>(<span class="string">"%s\n"</span>, recvBuf);</div><div class="line">		<span class="comment">//关闭套接字</span></div><div class="line">		closesocket(sockConn);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Project-Setting-Link，在Object/library modules编辑框中添加ws2_32.lib文件，注意输入的库文件与前面的库文件之间一定 要有一个空格。
<img src="http://img.blog.csdn.net/20170428102011032?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h3 id="客户端程序">客户端程序</h3>
<p>在工作区名称上单击鼠标右键，选择Add New Project to Workspace，再创建一个Win32 Console Application类型的应用程序，创建一个空工程。为此增加一个C++源文件：TcpClient.cpp。
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Winsock2.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">	<span class="comment">//加载套接字库</span></div><div class="line">	WORD wVersionRequested;</div><div class="line">	WSADATA wsaData;</div><div class="line">	<span class="keyword">int</span> err;</div><div class="line"></div><div class="line">	wVersionRequested = MAKEWORD(<span class="number">1</span>, <span class="number">1</span>);</div><div class="line"></div><div class="line">	err = WSAStartup(wVersionRequested, &amp;wsaData);</div><div class="line">	<span class="keyword">if</span> (err != <span class="number">0</span>)&#123;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (LOBYTE(wsaData.wVersion) != <span class="number">1</span> || </div><div class="line">		HIBYTE(wsaData.wVersion) != <span class="number">1</span>)&#123;</div><div class="line">		WSACleanup();</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//创建套接字</span></div><div class="line">	SOCKET sockClient = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</div><div class="line"></div><div class="line">	SOCKADDR_IN addrSrv;</div><div class="line">	addrSrv.sin_addr.S_un.S_addr = inet_addr(<span class="string">"127.0.0.1"</span>);</div><div class="line">	addrSrv.sin_family = AF_INET;</div><div class="line">	addrSrv.sin_port = htons(<span class="number">7000</span>);</div><div class="line"></div><div class="line">	<span class="comment">//向服务器发出连接请求</span></div><div class="line">	connect(sockClient, (SOCKADDR*)&amp;addrSrv, <span class="keyword">sizeof</span>(SOCKADDR));</div><div class="line"></div><div class="line">	<span class="comment">//接收数据</span></div><div class="line">	<span class="keyword">char</span> recvBuf[<span class="number">100</span>];</div><div class="line">	recv(sockClient, recvBuf, <span class="number">100</span>, <span class="number">0</span>);</div><div class="line">	<span class="built_in">printf</span>(<span class="string">"%s\n"</span>,recvBuf);</div><div class="line">	<span class="comment">//发送数据</span></div><div class="line">	send(sockClient, <span class="string">"This is lisi"</span>, <span class="built_in">strlen</span>(<span class="string">"This is lisi"</span>)+<span class="number">1</span>, <span class="number">0</span>);</div><div class="line">	<span class="comment">//关闭套接字</span></div><div class="line">	closesocket(sockClient);</div><div class="line">	WSACleanup();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>链接库文件：ws2_32.lib。
　　创建运行，首先运行服务器程序，然后再运行客户端程序。</p>
<p><img src="http://img.blog.csdn.net/20170428102101643?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p><strong>注意</strong>：当没有报错，服务器端运行结果为“烫烫……烫”（N个烫）时，尝试换一个端口号，有可能你设置的端口号被其它的应用程序占用了。</p>
<h2 id="基于udp的网络应用程序的编写">基于UDP的网络应用程序的编写</h2>
<h3 id="服务器端程序">服务器端程序</h3>
<p>关闭先前的工作区，新建一个工程，选择Win32 Console Application类型，名为UdpSrv。选择An empty project选项，创建一个空工程。再新建一个C++源文件：UdpSrv.cpp。
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Winsock2.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">	<span class="comment">//加载套接字库</span></div><div class="line">	WORD wVersionRequired;</div><div class="line">	WSADATA wsaData;</div><div class="line">	<span class="keyword">int</span> err;</div><div class="line"></div><div class="line">	wVersionRequired = MAKEWORD(<span class="number">1</span>, <span class="number">1</span>);</div><div class="line"></div><div class="line">	err = WSAStartup(wVersionRequired, &amp;wsaData);</div><div class="line">	<span class="keyword">if</span> (err != <span class="number">0</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (LOBYTE(wsaData.wVersion) != <span class="number">1</span> ||</div><div class="line">		HIBYTE(wsaData.wVersion) !=<span class="number">1</span>)</div><div class="line">	&#123;</div><div class="line">		WSACleanup();</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//创建套接字</span></div><div class="line">	SOCKET sockSrv = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</div><div class="line">	SOCKADDR_IN addrSrv;</div><div class="line">	addrSrv.sin_addr.S_un.S_addr = htonl(INADDR_ANY);</div><div class="line">	addrSrv.sin_family = AF_INET;</div><div class="line">	addrSrv.sin_port = htons(<span class="number">7000</span>);</div><div class="line">	<span class="comment">//绑定套接字</span></div><div class="line">	bind(sockSrv, (SOCKADDR*)&amp;addrSrv, <span class="keyword">sizeof</span>(SOCKADDR));</div><div class="line"></div><div class="line">	<span class="comment">//等待并接收数据</span></div><div class="line">	SOCKADDR_IN addrClient;</div><div class="line">	<span class="keyword">int</span> len = <span class="keyword">sizeof</span>(SOCKADDR);</div><div class="line">	<span class="keyword">char</span> recvBuf[<span class="number">100</span>];</div><div class="line">	recvfrom(sockSrv, recvBuf, <span class="number">100</span>, <span class="number">0</span>, (SOCKADDR*)&amp;addrClient, &amp;len);</div><div class="line">	<span class="built_in">printf</span>(<span class="string">"%s\n"</span>,recvBuf);</div><div class="line">	<span class="comment">//关闭套接字</span></div><div class="line">	closesocket(sockSrv);</div><div class="line">	WSACleanup();</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在工程设置对话框的链接选项卡下添加库文件：Ws2_32.lib的链接。</p>
<h3 id="客户端程序">客户端程序</h3>
<p>在同一个UdpSrv工作区中创建客户端应用程序。创建一个空的Win32 Console Application类型的工程，名为：UdpClient。为该工程添加一个C++源文件：UdpClient.cpp。
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Winsock2.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">	<span class="comment">//加载套接字库</span></div><div class="line">	WORD wVersionRequired;</div><div class="line">	WSADATA wsaData;</div><div class="line">	<span class="keyword">int</span> err;</div><div class="line"></div><div class="line">	wVersionRequired = MAKEWORD(<span class="number">1</span>, <span class="number">1</span>);</div><div class="line"></div><div class="line">	err = WSAStartup(wVersionRequired, &amp;wsaData);</div><div class="line">	<span class="keyword">if</span> (err != <span class="number">0</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (LOBYTE(wsaData.wVersion) != <span class="number">1</span> ||</div><div class="line">		HIBYTE(wsaData.wVersion) !=<span class="number">1</span>)</div><div class="line">	&#123;</div><div class="line">		WSACleanup();</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//创建套接字</span></div><div class="line">	SOCKET sockClient = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</div><div class="line">	SOCKADDR_IN addrSrv;</div><div class="line">	addrSrv.sin_addr.S_un.S_addr = inet_addr(<span class="string">"127.0.0.1"</span>);</div><div class="line">	addrSrv.sin_family = AF_INET;</div><div class="line">	addrSrv.sin_port = htons(<span class="number">7000</span>);</div><div class="line">	<span class="comment">//发送数据</span></div><div class="line">	sendto(sockClient, <span class="string">"Hello"</span>, <span class="built_in">strlen</span>(<span class="string">"Hello"</span>)+<span class="number">1</span>, <span class="number">0</span>, </div><div class="line">		(SOCKADDR*)&amp;addrSrv, <span class="keyword">sizeof</span>(SOCKADDR));</div><div class="line">	<span class="comment">//关闭套接字</span></div><div class="line">	closesocket(sockClient);</div><div class="line">	WSACleanup();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>链接库文件：ws2_32.lib。</p>
<p>创建运行。服务器端程序应先启动，然后启动客户端程序。</p>
<p><img src="http://img.blog.csdn.net/20170428102150065?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p><strong>基于TCP和基于UDP的网络应用程序在发送和接收数据时使用的函数是不一样的：前者使用send和recv，后者使用sendto和recvfrom。</strong></p>
<h2 id="基于udp的简单聊天程序">基于UDP的简单聊天程序</h2>
<p>在新工作区新建一个空的Win32 Console Application类型的应用程序，名为NetSrv。为该工程添加一个C++源文件：NetSrv.cpp。接着为该工程添加对WinSock库的链接，即在工程设置对话框的Link选项卡上添加ws2_32.lib文件的链接。
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Winsock2.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"> <span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line"> &#123;</div><div class="line">	 <span class="comment">//加载套接字库</span></div><div class="line">	 WORD wVersionRequested;</div><div class="line">	 WSADATA wsaData;</div><div class="line">	 <span class="keyword">int</span> err;</div><div class="line"></div><div class="line">	 wVersionRequested = MAKEWORD(<span class="number">1</span>, <span class="number">1</span>);</div><div class="line"></div><div class="line">	 err = WSAStartup(wVersionRequested, &amp;wsaData);</div><div class="line">	 <span class="keyword">if</span> (err != <span class="number">0</span>)</div><div class="line">	 &#123;</div><div class="line">		 <span class="keyword">return</span>;</div><div class="line">	 &#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (LOBYTE(wsaData.wVersion) != <span class="number">1</span> ||</div><div class="line">		HIBYTE(wsaData.wVersion) !=<span class="number">1</span>)</div><div class="line">	&#123;</div><div class="line">		WSACleanup();</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	 <span class="comment">//创建套接字</span></div><div class="line">	 SOCKET sockSrv = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</div><div class="line"></div><div class="line">	 SOCKADDR_IN addrSrv;</div><div class="line">	 addrSrv.sin_addr.S_un.S_addr = htonl(INADDR_ANY);</div><div class="line">	 addrSrv.sin_family = AF_INET;</div><div class="line">	 addrSrv.sin_port = htons(<span class="number">7000</span>);</div><div class="line"></div><div class="line">	 <span class="comment">//绑定套接字</span></div><div class="line">	 bind(sockSrv, (SOCKADDR*)&amp;addrSrv, <span class="keyword">sizeof</span>(SOCKADDR));</div><div class="line"></div><div class="line">	 <span class="keyword">char</span> recvBuf[<span class="number">100</span>];</div><div class="line">	 <span class="keyword">char</span> sendBuf[<span class="number">100</span>];</div><div class="line">	 <span class="keyword">char</span> tempBuf[<span class="number">200</span>];</div><div class="line"></div><div class="line">	 SOCKADDR_IN addrClient;</div><div class="line">	 <span class="keyword">int</span> len = <span class="keyword">sizeof</span>(SOCKADDR);</div><div class="line">	 <span class="keyword">while</span>(<span class="number">1</span>)</div><div class="line">	 &#123;</div><div class="line">		 <span class="comment">//等待并接收数据</span></div><div class="line">		 recvfrom(sockSrv, recvBuf, <span class="number">100</span>, <span class="number">0</span>, (SOCKADDR*)&amp;addrClient, &amp;len);</div><div class="line">		 <span class="keyword">if</span> (<span class="string">'q'</span> == recvBuf[<span class="number">0</span>])</div><div class="line">		 &#123;</div><div class="line">			 sendto(sockSrv, <span class="string">"q"</span>, <span class="built_in">strlen</span>(<span class="string">"q"</span>)+<span class="number">1</span>, <span class="number">0</span>, (SOCKADDR*)&amp;addrClient, len);</div><div class="line">			 <span class="built_in">printf</span>(<span class="string">"Chat end!\n"</span>);</div><div class="line">			 <span class="keyword">break</span>;</div><div class="line">		 &#125;</div><div class="line">		 <span class="built_in">sprintf</span>(tempBuf, <span class="string">"%s say : %s"</span>, inet_ntoa(addrClient.sin_addr), recvBuf);</div><div class="line">		 <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, tempBuf);</div><div class="line">		 <span class="comment">//发送数据</span></div><div class="line">		 <span class="built_in">printf</span>(<span class="string">"Please input data:\n"</span>);</div><div class="line">		 gets(sendBuf);</div><div class="line">		 sendto(sockSrv, sendBuf, <span class="built_in">strlen</span>(sendBuf)+<span class="number">1</span>, <span class="number">0</span>, (SOCKADDR*)&amp;addrClient, len);</div><div class="line">	&#125;</div><div class="line">	 <span class="comment">//关闭套接字</span></div><div class="line">	 closesocket(sockSrv);</div><div class="line">	 WSACleanup();</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<h3 id="客户端程序">客户端程序</h3>
<p>向已有工作区增加一个空的Win32 Console Application类型的工程：NetClient。为此添加一个C++源文件：NetClient.cpp。为该工程添加ws2_32.lib文件的链接。
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Winsock2.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"> <span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line"> &#123;</div><div class="line">	 <span class="comment">//加载套接字库</span></div><div class="line">	 WORD wVersionRequested;</div><div class="line">	 WSADATA wsaData;</div><div class="line">	 <span class="keyword">int</span> err;</div><div class="line"></div><div class="line">	 wVersionRequested = MAKEWORD(<span class="number">1</span>, <span class="number">1</span>);</div><div class="line"></div><div class="line">	 err = WSAStartup(wVersionRequested, &amp;wsaData);</div><div class="line">	 <span class="keyword">if</span> (err != <span class="number">0</span>)</div><div class="line">	 &#123;</div><div class="line">		 <span class="keyword">return</span>;</div><div class="line">	 &#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (LOBYTE(wsaData.wVersion) != <span class="number">1</span> ||</div><div class="line">		HIBYTE(wsaData.wVersion) !=<span class="number">1</span>)</div><div class="line">	&#123;</div><div class="line">		WSACleanup();</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	 <span class="comment">//创建套接字</span></div><div class="line">	 SOCKET sockClient = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</div><div class="line"></div><div class="line">	 SOCKADDR_IN addrSrv;</div><div class="line">	 addrSrv.sin_addr.S_un.S_addr = inet_addr(<span class="string">"127.0.0.1"</span>);</div><div class="line">	 addrSrv.sin_family = AF_INET;</div><div class="line">	 addrSrv.sin_port = htons(<span class="number">7000</span>);</div><div class="line"></div><div class="line">	 <span class="keyword">char</span> recvBuf[<span class="number">100</span>];</div><div class="line">	 <span class="keyword">char</span> sendBuf[<span class="number">100</span>];</div><div class="line">	 <span class="keyword">char</span> tempBuf[<span class="number">200</span>];</div><div class="line"></div><div class="line">	 <span class="keyword">int</span> len = <span class="keyword">sizeof</span>(SOCKADDR);</div><div class="line"></div><div class="line">	 <span class="keyword">while</span>(<span class="number">1</span>)</div><div class="line">	 &#123;</div><div class="line">		 <span class="comment">//发送数据</span></div><div class="line">		 <span class="built_in">printf</span>(<span class="string">"Please input data:\n"</span>);</div><div class="line">		 gets(sendBuf);</div><div class="line">		 sendto(sockClient, sendBuf, <span class="built_in">strlen</span>(sendBuf)+<span class="number">1</span>, <span class="number">0</span>, (SOCKADDR*)&amp;addrSrv, len);</div><div class="line">		 <span class="comment">//等待并接收数据</span></div><div class="line"></div><div class="line">		 recvfrom(sockClient, recvBuf, <span class="number">100</span>, <span class="number">0</span>, (SOCKADDR*)&amp;addrSrv, &amp;len);</div><div class="line">		 <span class="keyword">if</span>(<span class="string">'q'</span> == recvBuf[<span class="number">0</span>])</div><div class="line">		 &#123;</div><div class="line">			 sendto(sockClient, <span class="string">"q"</span>, <span class="built_in">strlen</span>(<span class="string">"q"</span>)+<span class="number">1</span>, <span class="number">0</span>, (SOCKADDR*)&amp;addrSrv, len);</div><div class="line">			 <span class="built_in">printf</span>(<span class="string">"Chat end!\n"</span>);</div><div class="line">			 <span class="keyword">break</span>;</div><div class="line">		 &#125;</div><div class="line">		 <span class="built_in">sprintf</span>(tempBuf, <span class="string">"%s say : %s"</span>, inet_ntoa(addrSrv.sin_addr), recvBuf);</div><div class="line">		 <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, tempBuf);</div><div class="line">	 &#125;</div><div class="line">	 <span class="comment">//关闭套接字</span></div><div class="line">	 closesocket(sockClient);</div><div class="line">	 WSACleanup();</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20170428102229597?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h1 id="多线程">多线程</h1>
<h2 id="进程">进程</h2>
<h3 id="程序和进程">程序和进程</h3>
<h2 id="简单多线程示例">简单多线程示例</h2>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream.h&gt;</span></span></div><div class="line"></div><div class="line">    <span class="function">DWORD WINAPI <span class="title">Fun1Proc</span><span class="params">(</span></span></div><div class="line">	LPVOID lpParameter  <span class="comment">//thread data					 </span></div><div class="line">	);</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		HANDLE hThread1;</div><div class="line">		hThread1 = CreateThread(<span class="literal">NULL</span>, <span class="number">0</span>, Fun1Proc, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</div><div class="line">		CloseHandle(hThread1);</div><div class="line">		<span class="built_in">cout</span>&lt;&lt;<span class="string">"main thread is running"</span>&lt;&lt;<span class="built_in">endl</span>;</div><div class="line">		Sleep(<span class="number">10</span>);<span class="comment">//让主线程暂停运行，进入分线程</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//线程1的入口函数</span></div><div class="line">	<span class="function">DWORD WINAPI <span class="title">Fun1Proc</span><span class="params">(</span></span></div><div class="line">		LPVOID lpParameter  <span class="comment">//thread data</span></div><div class="line">		)</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">cout</span>&lt;&lt;<span class="string">"thread1 is running"</span>&lt;&lt;<span class="built_in">endl</span>;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20170424215653701?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>交替运行：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream.h&gt;</span></span></div><div class="line"></div><div class="line">    <span class="function">DWORD WINAPI <span class="title">Fun1Proc</span><span class="params">(</span></span></div><div class="line">	LPVOID lpParameter  <span class="comment">//thread data					 </span></div><div class="line">	);</div><div class="line">	</div><div class="line">	<span class="keyword">int</span> index = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		HANDLE hThread1;</div><div class="line">		hThread1 = CreateThread(<span class="literal">NULL</span>, <span class="number">0</span>, Fun1Proc, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</div><div class="line">		CloseHandle(hThread1);</div><div class="line">		</div><div class="line">		<span class="keyword">while</span> (index ++&lt; <span class="number">100</span>)</div><div class="line">		&#123;</div><div class="line">			<span class="built_in">cout</span>&lt;&lt;<span class="string">"main thread is running"</span>&lt;&lt;<span class="built_in">endl</span>;</div><div class="line">		&#125;</div><div class="line">			<span class="comment">//Sleep(10);//让主线程暂停运行，进入分线程</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//线程1的入口函数</span></div><div class="line"></div><div class="line">	<span class="function">DWORD WINAPI <span class="title">Fun1Proc</span><span class="params">(</span></span></div><div class="line">			</div><div class="line">		LPVOID lpParameter  <span class="comment">//thread data</span></div><div class="line">		)</div><div class="line"></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">while</span> (index++&lt; <span class="number">100</span>)</div><div class="line">		<span class="built_in">cout</span>&lt;&lt;<span class="string">"thread1 is running"</span>&lt;&lt;<span class="built_in">endl</span>;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20170424215712448?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h2 id="线程同步">线程同步</h2>
<h3 id="火车站售票系统模拟程序">火车站售票系统模拟程序</h3>
<p>由主线程创建的两个线程（1和2）负责销售火车票。
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream.h&gt;</span></span></div><div class="line"></div><div class="line">    <span class="function">DWORD WINAPI <span class="title">Fun1Proc</span><span class="params">(</span></span></div><div class="line">	LPVOID lpParameter  <span class="comment">//thread data					 </span></div><div class="line">	);</div><div class="line">	</div><div class="line">	 <span class="function">DWORD WINAPI <span class="title">Fun2Proc</span><span class="params">(</span></span></div><div class="line">	LPVOID lpParameter  <span class="comment">//thread data					 </span></div><div class="line">	);</div><div class="line"></div><div class="line">	<span class="keyword">int</span> index = <span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> tickets = <span class="number">100</span>;</div><div class="line">	HANDLE hMutex;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		HANDLE hThread1;</div><div class="line">		HANDLE hThread2;</div><div class="line"></div><div class="line">		<span class="comment">//创建互斥对象</span></div><div class="line">		hMutex = CreateMutex(<span class="literal">NULL</span>, FALSE, <span class="literal">NULL</span>);</div><div class="line"></div><div class="line">		<span class="comment">//创建线程</span></div><div class="line">		hThread1 = CreateThread(<span class="literal">NULL</span>, <span class="number">0</span>, Fun1Proc, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</div><div class="line">		hThread2 = CreateThread(<span class="literal">NULL</span>, <span class="number">0</span>, Fun2Proc, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</div><div class="line">		CloseHandle(hThread1);</div><div class="line">		CloseHandle(hThread2);</div><div class="line">		Sleep(<span class="number">4000</span>);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	</div><div class="line"></div><div class="line">	</div><div class="line"></div><div class="line">	<span class="comment">//线程1的入口函数</span></div><div class="line">	<span class="function">DWORD WINAPI <span class="title">Fun1Proc</span><span class="params">(</span></span></div><div class="line">			</div><div class="line">		LPVOID lpParameter  <span class="comment">//thread data</span></div><div class="line">		)</div><div class="line"></div><div class="line">	&#123;</div><div class="line">	<span class="keyword">while</span> (TRUE)</div><div class="line">		&#123;</div><div class="line">			WaitForSingleObject(hMutex, INFINITE);<span class="comment">//实现线程同步</span></div><div class="line">			<span class="keyword">if</span> (tickets &gt; <span class="number">0</span>)</div><div class="line">			&#123;</div><div class="line">				Sleep(<span class="number">1</span>);</div><div class="line">				<span class="built_in">cout</span>&lt;&lt;<span class="string">"thread1 sell ticket:"</span>&lt;&lt;tickets--&lt;&lt;<span class="built_in">endl</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span> </div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			ReleaseMutex(hMutex);<span class="comment">//释放当前线程对互斥对象的所有权</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"></div><div class="line">	&#125;</div><div class="line">	</div><div class="line"></div><div class="line">		<span class="comment">//线程2的入口函数</span></div><div class="line">	<span class="function">DWORD WINAPI <span class="title">Fun2Proc</span><span class="params">(</span></span></div><div class="line">			</div><div class="line">		LPVOID lpParameter  <span class="comment">//thread data</span></div><div class="line">		)</div><div class="line"></div><div class="line"></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">while</span> (TRUE)</div><div class="line">		&#123;</div><div class="line">			WaitForSingleObject(hMutex,INFINITE);</div><div class="line">			<span class="keyword">if</span> (tickets &gt; <span class="number">0</span>)</div><div class="line">			&#123;</div><div class="line">				Sleep(<span class="number">1</span>);</div><div class="line">				<span class="built_in">cout</span>&lt;&lt;<span class="string">"thread2 sell ticket:"</span>&lt;&lt;tickets--&lt;&lt;<span class="built_in">endl</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span> </div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			ReleaseMutex(hMutex);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20170424215734652?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述">
　　这时所销售的票号正常，没有看到销售了号码为0的票。</p>
<p>对互斥对象来说，谁拥有谁释放。</p>
<h2 id="保证应用程序只有一个实例运行">保证应用程序只有一个实例运行</h2>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream.h&gt;</span></span></div><div class="line"></div><div class="line">    <span class="function">DWORD WINAPI <span class="title">Fun1Proc</span><span class="params">(</span></span></div><div class="line">	LPVOID lpParameter  <span class="comment">//thread data					 </span></div><div class="line">	);</div><div class="line">	</div><div class="line">	 <span class="function">DWORD WINAPI <span class="title">Fun2Proc</span><span class="params">(</span></span></div><div class="line">	LPVOID lpParameter  <span class="comment">//thread data					 </span></div><div class="line">	);</div><div class="line"></div><div class="line">	<span class="keyword">int</span> index = <span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> tickets = <span class="number">100</span>;</div><div class="line">	HANDLE hMutex;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		HANDLE hThread1;</div><div class="line">		HANDLE hThread2;</div><div class="line"></div><div class="line">		<span class="comment">//创建互斥对象(注意命名)</span></div><div class="line">		hMutex = CreateMutex(<span class="literal">NULL</span>, FALSE, <span class="string">"1"</span>);</div><div class="line">		<span class="keyword">if</span> (hMutex)</div><div class="line">		&#123;</div><div class="line">			<span class="keyword">if</span> (ERROR_ALREADY_EXISTS == GetLastError())</div><div class="line">			&#123;</div><div class="line">				<span class="built_in">cout</span>&lt;&lt;<span class="string">"only one instance can run!"</span>&lt;&lt;<span class="built_in">endl</span>;</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">//创建线程</span></div><div class="line">		hThread1 = CreateThread(<span class="literal">NULL</span>, <span class="number">0</span>, Fun1Proc, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</div><div class="line">		hThread2 = CreateThread(<span class="literal">NULL</span>, <span class="number">0</span>, Fun2Proc, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</div><div class="line">		CloseHandle(hThread1);</div><div class="line">		CloseHandle(hThread2);</div><div class="line">		WaitForSingleObject(hMutex, INFINITE);</div><div class="line">		ReleaseMutex(hMutex);</div><div class="line">		ReleaseMutex(hMutex);</div><div class="line">		Sleep(<span class="number">4000</span>);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="comment">//线程1的入口函数</span></div><div class="line">	<span class="function">DWORD WINAPI <span class="title">Fun1Proc</span><span class="params">(</span></span></div><div class="line">			</div><div class="line">		LPVOID lpParameter  <span class="comment">//thread data</span></div><div class="line">		)</div><div class="line"></div><div class="line">	&#123;</div><div class="line">	<span class="keyword">while</span> (TRUE)</div><div class="line">		&#123;</div><div class="line">			WaitForSingleObject(hMutex, INFINITE);<span class="comment">//实现线程同步</span></div><div class="line">			<span class="keyword">if</span> (tickets &gt; <span class="number">0</span>)</div><div class="line">			&#123;</div><div class="line">				Sleep(<span class="number">1</span>);</div><div class="line">				<span class="built_in">cout</span>&lt;&lt;<span class="string">"thread1 sell ticket:"</span>&lt;&lt;tickets--&lt;&lt;<span class="built_in">endl</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span> </div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			ReleaseMutex(hMutex);<span class="comment">//释放当前线程对互斥对象的所有权</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"></div><div class="line">	&#125;</div><div class="line">	</div><div class="line"></div><div class="line">		<span class="comment">//线程2的入口函数</span></div><div class="line">	<span class="function">DWORD WINAPI <span class="title">Fun2Proc</span><span class="params">(</span></span></div><div class="line">			</div><div class="line">		LPVOID lpParameter  <span class="comment">//thread data</span></div><div class="line">		)</div><div class="line"></div><div class="line"></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">while</span> (TRUE)</div><div class="line">		&#123;</div><div class="line">			WaitForSingleObject(hMutex,INFINITE);</div><div class="line">			<span class="keyword">if</span> (tickets &gt; <span class="number">0</span>)</div><div class="line">			&#123;</div><div class="line">				Sleep(<span class="number">1</span>);</div><div class="line">				<span class="built_in">cout</span>&lt;&lt;<span class="string">"thread2 sell ticket:"</span>&lt;&lt;tickets--&lt;&lt;<span class="built_in">endl</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span> </div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			ReleaseMutex(hMutex);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="网络聊天室程序的实现">网络聊天室程序的实现</h2>
<p>新建一个基于对话框的工程，名为：Chat。
<img src="http://img.blog.csdn.net/20170428102440017?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述">
<img src="http://img.blog.csdn.net/20170428102449366?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h3 id="加载套接字库">加载套接字库</h3>
<p>在CChatApp类的InitInstance函数开始位置
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">BOOL CChatApp::InitInstance()</div><div class="line">&#123;</div><div class="line">	<span class="keyword">if</span> (!AfxSocketInit())</div><div class="line">	&#123;</div><div class="line">		AfxMessageBox(<span class="string">"加载套接字库失败！"</span>);</div><div class="line">		<span class="keyword">return</span> FALSE;</div><div class="line">	&#125;</div><div class="line">……</div><div class="line">&#125;</div><div class="line">　　在stdafx.h中，添加头文件`<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Afxsock.h&gt;</span>`。</span></div><div class="line"></div><div class="line">### 创建并初始化套接字</div><div class="line">```C++</div><div class="line">BOOL CChatDlg::InitSocket()</div><div class="line">&#123;</div><div class="line">	<span class="comment">//创建套接字</span></div><div class="line">	m_socket = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</div><div class="line">	<span class="keyword">if</span> (INVALID_SOCKET == m_socket)</div><div class="line">	&#123;</div><div class="line">		MessageBox(<span class="string">"套接字创建失败！"</span>);</div><div class="line">		<span class="keyword">return</span> FALSE;</div><div class="line">	&#125;</div><div class="line">	SOCKADDR_IN addrSock;</div><div class="line">	addrSock.sin_family = AF_INET;</div><div class="line">	addrSock.sin_port = htons(<span class="number">7000</span>);</div><div class="line">	addrSock.sin_addr.S_un.S_addr = htonl(INADDR_ANY);</div><div class="line"></div><div class="line">	<span class="keyword">int</span> retval;</div><div class="line">	<span class="comment">//绑定套接字</span></div><div class="line">	retval = bind(m_socket, (SOCKADDR*)&amp;addrSock, <span class="keyword">sizeof</span>(SOCKADDR));</div><div class="line">	<span class="keyword">if</span> (SOCKET_ERROR == retval)</div><div class="line">	&#123;</div><div class="line">		closesocket(m_socket);</div><div class="line">		MessageBox(<span class="string">"绑定失败！"</span>);</div><div class="line">		<span class="keyword">return</span> TRUE;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> TRUE;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">BOOL CChatDlg::OnInitDialog()</div><div class="line">&#123;</div><div class="line">……</div><div class="line">	</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add extra initialization here</span></div><div class="line">	InitSocket();</div><div class="line"></div><div class="line">	<span class="keyword">return</span> TRUE;  <span class="comment">// return TRUE  unless you set the focus to a control</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="实现接收端功能">实现接收端功能</h3>
<p>在CChatDlg类中定义：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/////////////////////////////////////////////////////////////////////////////</span></div><div class="line"><span class="comment">// CChatDlg dialog</span></div><div class="line"></div><div class="line"><span class="keyword">struct</span> RECVPARAM</div><div class="line">&#123;</div><div class="line">	SOCKET sock; <span class="comment">//已创建的套接字</span></div><div class="line">	HWND hwnd; <span class="comment">//对话框句柄</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>在Chatdlg.h中添加：<code>static DWORD WINAPI RecvProc(LPVOID lpParameter);</code>
在OnInitDialog()中添加：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">BOOL CChatDlg::OnInitDialog()</div><div class="line">&#123;</div><div class="line"></div><div class="line">……</div><div class="line"></div><div class="line"><span class="comment">// <span class="doctag">TODO:</span> Add extra initialization here</span></div><div class="line">	InitSocket();</div><div class="line">	RECVPARAM *pRecvParam = <span class="keyword">new</span> RECVPARAM;</div><div class="line">	pRecvParam-&gt;sock = m_socket;</div><div class="line">	pRecvParam-&gt;hwnd = m_hWnd;</div><div class="line">	<span class="comment">//创建接收线程</span></div><div class="line">	HANDLE hThread = CreateThread(<span class="literal">NULL</span>, <span class="number">0</span>, RecvProc, (LPVOID)pRecvParam, <span class="number">0</span>, <span class="literal">NULL</span>);</div><div class="line">	<span class="comment">//关闭该接收程句柄，释放其引用计数</span></div><div class="line">	CloseHandle(hThread);</div><div class="line"></div><div class="line"></div><div class="line">	<span class="keyword">return</span> TRUE;  <span class="comment">// return TRUE  unless you set the focus to a control</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">　　在CChatDlg类中添加：</div><div class="line">```C++</div><div class="line">DWORD WINAPI CChatDlg::RecvProc(LPVOID lpParameter)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>若要求采用完全面向对象的思想来编程，不能使用全局函数和全局变量了，可以采用静态成员函数和静态成员变量的方法来解决。
　　
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">DWORD WINAPI CChatDlg::RecvProc(LPVOID lpParameter)</div><div class="line">&#123;</div><div class="line">	<span class="comment">//获取主线程传递的套接字和窗口句柄</span></div><div class="line">	SOCKET sock = ((RECVPARAM*)lpParameter)-&gt;sock;</div><div class="line">	HWND hwnd = ((RECVPARAM*)lpParameter)-&gt;hwnd;</div><div class="line">	<span class="keyword">delete</span> lpParameter;</div><div class="line"></div><div class="line">	SOCKADDR_IN addrFrom;</div><div class="line">	<span class="keyword">int</span> len = <span class="keyword">sizeof</span>(SOCKADDR);</div><div class="line"></div><div class="line">	<span class="keyword">char</span> recvBuf[<span class="number">200</span>];</div><div class="line">	<span class="keyword">char</span> tempBuf[<span class="number">300</span>];</div><div class="line">	<span class="keyword">int</span> retval;</div><div class="line">	<span class="keyword">while</span>(TRUE)</div><div class="line">	&#123;</div><div class="line">		<span class="comment">//接收数据</span></div><div class="line">		retval = recvfrom(sock, recvBuf, <span class="number">200</span>, <span class="number">0</span>, (SOCKADDR*)&amp;addrFrom, &amp;len);</div><div class="line">		<span class="keyword">if</span> (SOCKET_ERROR == retval)</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="built_in">sprintf</span>(tempBuf, <span class="string">"%s 说： %s"</span>, inet_ntoa(addrFrom.sin_addr), recvBuf);</div><div class="line">		::PostMessage(hwnd, WM_RECVDATA, <span class="number">0</span>, (LPARAM)tempBuf);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在该类添加头文件 <code>#define WM_RECVDATA	WM_USER+1</code></p>
<p>在CChatDlg类头文件中编写该消息响应函数原型的声明：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Generated message map functions</span></div><div class="line"><span class="comment">//&#123;&#123;AFX_MSG(CChatDlg)</span></div><div class="line"><span class="function"><span class="keyword">virtual</span> BOOL <span class="title">OnInitDialog</span><span class="params">()</span></span>;</div><div class="line"><span class="function">afx_msg <span class="keyword">void</span> <span class="title">OnSysCommand</span><span class="params">(UINT nID, LPARAM lParam)</span></span>;</div><div class="line"><span class="function">afx_msg <span class="keyword">void</span> <span class="title">OnPaint</span><span class="params">()</span></span>;</div><div class="line"><span class="function">afx_msg HCURSOR <span class="title">OnQueryDragIcon</span><span class="params">()</span></span>;</div><div class="line"><span class="comment">//&#125;&#125;AFX_MSG</span></div><div class="line"><span class="function">afx_msg <span class="keyword">void</span> <span class="title">OnRecvData</span><span class="params">(WPARAM wParam, LPARAM lParam)</span></span>;</div><div class="line">DECLARE_MESSAGE_MAP()</div></pre></td></tr></table></figure></p>
<p>在CChatDlg类的源文件中添加WM_RECVDATA消息映射。
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">BEGIN_MESSAGE_MAP(CChatDlg, CDialog)</div><div class="line">	<span class="comment">//&#123;&#123;AFX_MSG_MAP(CChatDlg)</span></div><div class="line">	ON_WM_SYSCOMMAND()</div><div class="line">	ON_WM_PAINT()</div><div class="line">	ON_WM_QUERYDRAGICON()</div><div class="line">	<span class="comment">//&#125;&#125;AFX_MSG_MAP</span></div><div class="line">	ON_MESSAGE(WM_RECVDATA, OnRecvData)</div><div class="line">END_MESSAGE_MAP()</div></pre></td></tr></table></figure></p>
<p>在构造函数中
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CChatDlg::OnRecvData(WPARAM wParam, LPARAM lParam)</div><div class="line">&#123;</div><div class="line">	<span class="comment">//取出接收到的数据</span></div><div class="line">	CString str = (<span class="keyword">char</span>*)lParam;</div><div class="line">	CString strTemp;</div><div class="line">	<span class="comment">//获得已有数据</span></div><div class="line">	GetDlgItemText(IDC_EDIT_RECV, strTemp);</div><div class="line">	str += <span class="string">"\r\n"</span>;</div><div class="line">	str += strTemp;</div><div class="line">	<span class="comment">//显示所有接收到的数据</span></div><div class="line">	SetDlgItemText(IDC_EDIT_RECV, str);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="实现发送端功能">实现发送端功能</h3>
<p>双击发送，添加响应函数。
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CChatDlg::OnBtnSend() </div><div class="line">&#123;</div><div class="line">	<span class="comment">//获取对方IP</span></div><div class="line"><span class="comment">// <span class="doctag">TODO:</span> Add your control notification handler code here</span></div><div class="line">	DWORD dwIP;</div><div class="line">	((CIPAddressCtrl*)GetDlgItem(IDC_IPADDRESS1))-&gt;GetAddress(dwIP);</div><div class="line"></div><div class="line">	SOCKADDR_IN addrTo;</div><div class="line">	addrTo.sin_family = AF_INET;</div><div class="line">	addrTo.sin_port = htons(<span class="number">7000</span>);</div><div class="line">	addrTo.sin_addr.S_un.S_addr = htonl(dwIP);</div><div class="line"></div><div class="line">	CString strSend;</div><div class="line">	<span class="comment">//获得待发送数据</span></div><div class="line">	GetDlgItemText(IDC_EDIT_SEND, strSend);</div><div class="line">	<span class="comment">//发送数据</span></div><div class="line">	sendto(m_socket, strSend, strSend.GetLength()+<span class="number">1</span>, <span class="number">0</span>,</div><div class="line">		(SOCKADDR*)&amp;addrTo, <span class="keyword">sizeof</span>(SOCKADDR));</div><div class="line">	<span class="comment">//清空发送编辑框中的内容</span></div><div class="line">	SetDlgItemText(IDC_EDIT_SEND, <span class="string">""</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>为了让编辑框控件接受换行符，必须设置该控件支持多行数据这一属性。
<img src="http://img.blog.csdn.net/20170428102525898?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>将“发送”设置为Default button，还可以选择取消Visible选项。
　　本例在一个程序中同时实现了接收端和发送端的功能，所以只需在聊天双方各自的机器上安装本程序，在聊天时，通过输入对方主机的IP地址，就可以与对方进行通信了。</p>
<h1 id="动态链接库">动态链接库</h1>
<p>动态链接库有两种加载方式：隐式链接和显式加载</p>
<h2 id="win32-dll的创建和使用">Win32 DLL的创建和使用</h2>
<p>新建一个Win32 Dynamic-Link Library类型的工程，取名为Dll1。并在AppWizard的第一步选择“An empty Dll project”，即创建一个空的动态链接库工程。然后添加一个C++源文件：Dll1.cpp。添加代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">return</span> a + b;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">subtract</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">return</span> a - b;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Build生成Dll1程序。在该工程的Debug目录下，可看到一个Dll1.dll文件，这就是生成的动态链接库文件。</p>
<h3 id="dumpbin命令">Dumpbin命令</h3>
<p>应用程序如果想要访问某个DLL中的函数，那么该函数必须是已经被导出的函数。为了查看有哪些导出函数，可以用VS提供的命令行工具：Dumpbin实现。</p>
<h3 id="从dll中导出函数">从DLL中导出函数</h3>
<p>为导出函数，需在每一个将被导出的函数前添加标识符：_declspec(dllexport)。修改上述代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="number">_</span>declspec(dllexport) <span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">return</span> a + b;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="number">_</span>declspec(dllexport) <span class="function"><span class="keyword">int</span> <span class="title">subtract</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">return</span> a - b;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>编译后可看到又生成了两个新文件，Dll1.lib，它保存Dll1.dll中导出的函数和变量的符号名。以及DALL1.EXP文件。</p>
<h2 id="隐式链接方式加载dll">隐式链接方式加载DLL</h2>
<p>编写一个测试程序测试这个动态链接库。新建一个基于对话框的MFC应用程序，取名DllTest，放置两个按钮，ID和Caption分别为：IDC_BTN_ADD，Add，IDC_BTN_SUBTRACT，Subtract。</p>
<h3 id="利用extern声明外部函数">利用extern声明外部函数</h3>
<p>为让编译器知道这两个函数，需作出声明，注意放在OnBtnAdd函数和OnBtnSubtract函数前面。
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>;</div><div class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">subtract</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>;</div><div class="line"></div><div class="line"><span class="keyword">void</span> CDllTestDlg::OnBtnAdd() </div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add your control notification handler code here</span></div><div class="line">	CString str;</div><div class="line">	str.Format(<span class="string">"5 + 3 = %d"</span>, add(<span class="number">5</span>, <span class="number">3</span>));</div><div class="line">	MessageBox(str);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> CDllTestDlg::OnBtnSubtract() </div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add your control notification handler code here</span></div><div class="line">	CString str;</div><div class="line">	str.Format(<span class="string">"5 - 3 = %d"</span>, subtract(<span class="number">5</span>, <span class="number">3</span>));</div><div class="line">	MessageBox(str);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Build后报错：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">--------------------Configuration: DllTest - Win32 Debug--------------------</div><div class="line">Compiling resources...</div><div class="line">Compiling...</div><div class="line">StdAfx.cpp</div><div class="line">Compiling...</div><div class="line">DllTest.cpp</div><div class="line">DllTestDlg.cpp</div><div class="line">Generating Code...</div><div class="line">Linking...</div><div class="line">DllTestDlg.obj : error LNK2001: unresolved external symbol <span class="string">"int __cdecl add(int,int)"</span> (?add@@YAHHH@Z)</div><div class="line">DllTestDlg.obj : error LNK2001: unresolved external symbol <span class="string">"int __cdecl subtract(int,int)"</span> (?subtract@@YAHHH@Z)</div><div class="line">Debug/DllTest.exe : fatal error LNK1120: <span class="number">2</span> unresolved externals</div><div class="line">执行 link.exe 时出错.</div><div class="line"></div><div class="line">DllTest.exe - <span class="number">1</span> error(s), <span class="number">0</span> warning(s)</div></pre></td></tr></table></figure></p>
<p>可看到编译成功，错误发生在链接时。为解决该问题，需利用动态链接库的引入库文件。
在Dll1.dll文件所在目录下，复制Dll1.lib文件，并将其复制到DllTest程序所在目录下，这个文件中就包含了Dll1.dll中导出函数的符号名。
然后在DllTest中，选择Porject\Settings\link，在Object/library modules中输入dll1.lib。
再次编译，成功生成DllTest.exe文件。
（可利用dumpbin -imports dlltest.exe查看输入信息）</p>
<p>运行程序，弹出报错对话框：
<img src="http://img.blog.csdn.net/20170709130424898?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="报错"></p>
<p>将Dll1.dll放置在DllTest工程所在目录下，就好了。</p>
<p>效果如图。
<img src="http://img.blog.csdn.net/20170709130702138?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="效果"></p>
<h3 id="depends工具">Depends工具</h3>
<p>在Microsoft Visual Studio\Common\Tools中有一个DEPENDS.EXE，该工具可以查看可执行程序，还可以查看动态链接库，主要是看它们依赖于哪些动态链接库。
打开该工具，单击File\Open，选择DllText.exe，将会看到：
<img src="http://img.blog.csdn.net/20170709132044018?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="DEPENDS"></p>
<p>DllTest程序需访问Dll1.dll这一动态链接库，但该文件名前有一个问号，说明没有找到Dll1.dll这个动态链接库。这是因为前面将动态链接库文件放在了\DllTest\Debug目录的上一级目录下了。这里，可将Dll1.dll文件再复制到\DllTest\Debug目录下，然后重启Depends工具。这时问号就没有了。（因为Dll1.dll与DllTest.exe位于同一目录，在打开DllTest.exe时，就可找到该动态链接库。）</p>
<p><img src="http://img.blog.csdn.net/20170709132630578?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="成功"></p>
<h3 id="利用_declspecdllimport声明外部函数">利用_declspec(dllimport)声明外部函数</h3>
<p>除了使用extern关键字表明函数是外部定义的之外，还可以使用标识符：_declspec(dllimport)来表明函数是从动态链接库中引入的。将之前的extern声明注释起来。添加：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="number">_</span>declspec(dllimport) <span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>;</div><div class="line"><span class="number">_</span>declspec(dllimport) <span class="function"><span class="keyword">int</span> <span class="title">subtract</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>;</div></pre></td></tr></table></figure></p>
<p>若调用的函数来自于动态链接库，应采用这种方式声明外部函数，编译器可以生成运行效率更高的代码。</p>
<h2 id="完善win32-dll例子">完善Win32 DLL例子</h2>
<p>为知道DLL有哪些导出函数，通常在编写动态链接库时，会提供一个头文件，在此提供DLL导出函数原型的声明，以及函数有关注释文档。</p>
<p>为DLL1工程添加一个头文件：Dll1.h，并添加代码
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="number">_</span>declspec(dllimport) <span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>;</div><div class="line"><span class="number">_</span>declspec(dllimport) <span class="function"><span class="keyword">int</span> <span class="title">subtract</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>;</div></pre></td></tr></table></figure></p>
<p>然后将DllTestDlg.cpp先前添加的声明语句注释起来，并在前部添加下面的语句：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"dll1.h"</span></span></div></pre></td></tr></table></figure></p>
<p>Build并运行，结果和之前一样。</p>
<p>所以在发布Dll1.dll动态链接库时，可将Dll1.h头文件一起提供给使用者。</p>
<p>下面对Dll.h进行改造，使其不仅能为调用动态链接库的客户端程序服务，也能由动态链接库程序自身来使用。修改头文件：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DLL1_API</span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> DLL1_API _declspec(dllimport)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line"><span class="number">_</span>declspec(dllimport) <span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>;</div><div class="line"><span class="number">_</span>declspec(dllimport) <span class="function"><span class="keyword">int</span> <span class="title">subtract</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>;</div></pre></td></tr></table></figure></p>
<p>修改Dll1.cpp
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> DLL1_API _declspec(dllexport)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"Dll1.h"</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">return</span> a + b;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">subtract</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">return</span> a - b;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>将重新生成的文件复制，运行，结果也是正确的。</p>
<h2 id="从dll中导出c类">从DLL中导出C++类</h2>
<p>在一个动态链接库中还可以导出一个C++类。
在Dll1.h中添加如下代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">class</span> DLL1_API Point</div><div class="line">&#123;</div><div class="line"><span class="keyword">public</span>:</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">output</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>在Dll1.cpp中改为：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> DLL1_API _declspec(dllexport)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"Dll1.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">return</span> a + b;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">subtract</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">return</span> a - b;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> Point::output(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</div><div class="line">&#123;</div><div class="line">	<span class="comment">//返回调用者进程当前正在使用的那个窗口的句柄</span></div><div class="line">	HWND hwnd = GetForegroundWindow();</div><div class="line">	<span class="comment">//获取DC</span></div><div class="line">	HDC hdc = GetDC(hwnd);</div><div class="line">	<span class="keyword">char</span> buf[<span class="number">20</span>];</div><div class="line">	<span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">20</span>);</div><div class="line">	<span class="built_in">sprintf</span>(buf, <span class="string">"x = %d, y = %d"</span>, x, y);</div><div class="line">	<span class="comment">//输出坐标</span></div><div class="line">	TextOut(hdc, <span class="number">0</span>, <span class="number">0</span>, buf, <span class="built_in">strlen</span>(buf));</div><div class="line">	<span class="comment">//释放DC</span></div><div class="line">	ReleaseDC(hwnd, hdc);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>将Dll1.dll和Dll1.lib复制到测试工程DllTest所在目录下。为避免麻烦，也可以把动态链接库文件所在目录添加到系统的环境变量Path中。这样就无需复制。</p>
<p>To be continued…
听听那冷雨</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/互联网/">互联网</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/">C++</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MFC/">MFC</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
	


  
  
</article>









  
    <article id="post-多说关闭引发的麻烦" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/04/05/多说关闭引发的麻烦/" class="article-date">
      <time datetime="2017-04-05T08:44:21.000Z" itemprop="datePublished">2017-04-05</time>
</a>

 
    <a href="/2017/04/05/多说关闭引发的麻烦/#comments" title="查看评论">
        <i class="fa fa-comments-o" aria-hidden="true"></i>
        <span class="count-comment"></span>
        
        
            <span class="disqus-comment-count" data-disqus-identifier="2017/04/05/多说关闭引发的麻烦/"></span>
        
    </a>

    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/05/多说关闭引发的麻烦/">多说关闭引发的麻烦</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>&lt;div align=&quot;left&quot;&gt;
&lt;img src=&quot;https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1491392241106&amp;di=d26487a68371b445aa7b604ab2883ce1&amp;imgtype=0&amp;src=http%3A%2F%2Fimage103.360doc.com%2FDownloadImg%2F2017%2F02%2F1715%2F91672979_2.png&quot; width=&quot;300&quot; height=&quot;180&quot; style=&quot;float:right;&quot;/&gt;
&lt;/div&gt;
我以为短期内我不可能再更新这篇文章了。没想到……</p>
<h1 id="201779-网页云跟帖停止服务">2017.7.9 网页云跟帖停止服务</h1>
<p><img src="http://img.blog.csdn.net/20170709154958703?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="跟帖关闭">
此刻我只想说：
哈哈哈哈哈哈哈哈！</p>
<p>跟帖服务跟不上，最终还是被畅言玩死了。幸好早早换了disqus。</p>
<p>同时，为这个商业社会默哀一秒钟。</p>
<p>&lt;!--more--&gt;</p>
<h1 id="201773-disqus不用翻墙即可评论">2017.7.3 disqus不用翻墙即可评论</h1>
<p>不审核，直接显示。并且，可以回访！</p>
<p>这次折腾好后短期内应该不会再弄评论框了  专注工作专注工作</p>
<p>墙内换成网易云跟帖后，评论量就跳水式下降，仿佛被打入冷宫？加上跟帖各种缺陷，还是用disqus吧，刚好听说了可以不翻墙就能用的方法，遂试之。</p>
<p>之前的600条评论又只能暂以json的形式躺在电脑里了。为什么大家的格式都不一样呢？这真的很不和谐，很不！和！谐！！</p>
<h2 id="登录服务器">登录服务器</h2>
<p>我用的xshell，ssh连接服务器。我的服务器是DigitalOcean买的 512M的……(它已经被闲置了三个月了，心疼money)
详见<a href="http://hubojing.me/2017/03/28/DigitalOcean%E8%B4%AD%E4%B9%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%95%99%E7%A8%8B/" target="_blank" rel="external">DigitalOcean购买服务器教程</a></p>
<h2 id="安装面板">安装面板</h2>
<p>在服务器上安装<a href="https://www.bt.cn/bbs/thread-1186-1-1.html" target="_blank" rel="external">宝塔Linux面板</a>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y wget &amp;&amp; wget -O install.sh http://download.bt.cn/install/install.sh &amp;&amp; sh install.sh</div></pre></td></tr></table></figure></p>
<p>然后在浏览器中打开面板。</p>
<h2 id="新建站点">新建站点</h2>
<p>在网站中添加站点，输入一个域名。（可勾选FTP）</p>
<h2 id="配置api">配置API</h2>
<p><a href="https://github.com/fooleap/disqus-php-api" target="_blank" rel="external">利用 PHP cURL 转发 Disqus API 请求</a> ，将文件clone到本地。在config中按要求配置。</p>
<p>将API打包上传到面板，解压。再将dist文件夹下的两个文件上传上去。</p>
<h2 id="域名解析">域名解析</h2>
<p>接着打开解析博客的地址，我用的腾讯云。<a href="https://www.dnspod.cn" target="_blank" rel="external">DNSPOD</a> 添加域名。
主机记录填对应的新建的站点名（不带网站一级域名），记录类型A，记录值为服务器地址。</p>
<h2 id="disqus配置">disqus配置</h2>
<p>disqus后台中勾选允许匿名评论。</p>
<h2 id="修改主题中评论文件">修改主题中评论文件</h2>
<p>完工。</p>
<p>部署时，
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">fatal: Unable <span class="built_in">to</span> <span class="built_in">create</span> <span class="string">'E:/hexo/.deploy_git/.git/index.lock'</span>: File exists.</div><div class="line"></div><div class="line">Another git <span class="built_in">process</span> seems <span class="built_in">to</span> be running <span class="keyword">in</span> this repository, e.g.</div><div class="line"><span class="keyword">an</span> editor opened <span class="keyword">by</span> <span class="string">'git commit'</span>. Please make sure all processes</div><div class="line">are terminated <span class="keyword">then</span> <span class="keyword">try</span> again. If <span class="keyword">it</span> still fails, <span class="keyword">a</span> git <span class="built_in">process</span></div><div class="line">may have crashed <span class="keyword">in</span> this repository earlier:</div><div class="line">remove <span class="keyword">the</span> <span class="built_in">file</span> manually <span class="built_in">to</span> continue.</div><div class="line">FATAL Something<span class="string">'s wrong. Maybe you can find the solution here: http://hexo.io/docs/troubleshooting.html</span></div></pre></td></tr></table></figure></p>
<p>解决：删除对应的index.lock。</p>
<hr>
<blockquote>
<h1 id="2017527-已更换为disqus">2017.5.27 已更换为Disqus</h1>
</blockquote>
<p>由于Disqus被墙，可能需要科学上网后才能看到评论。
若墙内的朋友们需要评论，可以直接点击QQ图标（PC端在左边栏，移动端在页面上方），和我进行在线对话。</p>
<hr>
<blockquote>
<h1 id="2017530-已导入历史评论">2017.5.30 已导入历史评论</h1>
</blockquote>
<p>虽然比不上多说，比网易云跟帖还是好很多了。
目前发现有一篇文章的评论导入失败，Disqus的显示如下：
Missing or invalid message 或 Unable to find parent post
我再看看怎么解决，是否需要手工导入。
参考：<a href="http://urouge.github.io/migrate-to-disqus/" target="_blank" rel="external">多说评论迁移至Disqus</a></p>
<hr>
<p>多说八百年不发邮件通知我有评论，在我换为网易云跟帖后，竟然邮件通知我有评论了！</p>
<p>多说关闭带来的评论区何去何从让我颇为困扰。
现在能用的大概只有这些：畅言（需备案）、网易云跟帖（github.io不支持）、友言（也有倒闭趋势）、来必力（韩国）。</p>
<p>没有一个像多说这样好用的！</p>
<p>虽然多说也有很多问题，但它至少解决了核心问题：
1.评论显示正确的网友名称。
来看看我换上网易云跟帖后的效果：
<img src="http://img.blog.csdn.net/20170405161942419?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="网易云跟帖"></p>
<p>都是有态度网友…… 我压根分不清谁是谁！</p>
<p>2.点击头像可以回访人家的独立博客。
这一点真的很重要，这往往是我们小众的独立博客人交朋友的主要途径啊！</p>
<p>3.可以自定义。
头像旋转、评论框自定义，真的可以很好看。这些跟帖做不到。</p>
<p>4.盖楼模式多样。
而跟帖只能一种，我不太喜欢，重复率太高，我还是喜欢多说的嵌套。</p>
<p>多说名字没起好啊！多说无益必自毙→_→
先换回多说吧，再等一个月看看。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/杂谈/">杂谈</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/多说/">多说</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
	


  
  
</article>









  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2015-2017 胡博靖
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span> | </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit" title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>


    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 19;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>


    

    
        <script id="dsq-count-scr" src="//hubojing.disqus.com/count.js" async></script>
        <script>
            if ($(".left-col").is(":visible")) {
                var $disqusCount = $(".disqus-comment-count");
                $disqusCount.bind("DOMNodeInserted", function(e) {
                    var num = $(this).text().replace(/[^0-9]/ig,"");
                    if (num > 0) {
                        $(this).siblings(".count-comment").text(num);
                    }
                    $(this).remove();
                })
            } else {
                $(".disqus-comment-count").remove();
            }
        </script>
     




<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

    <script>
        var originTitle = document.title;
        var titleTime;
        document.addEventListener("visibilitychange", function() {
            if (document.hidden) {
                document.title = "(つェ⊂) 我藏好了哦~ " + originTitle;
                clearTimeout(titleTime);
            }
            else {
                document.title = "(*´∇｀*) 被你发现啦~ " + originTitle;
                titleTime = setTimeout(function() {
                    document.title = originTitle;
                }, 2000);
            }
        })
    </script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>