<!DOCTYPE html>
<html lang="zh-Hans">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="胡博靖" />


    
    


<meta name="description" content="计算机|软件|开发|研发|通信工程|互联网|编程|程序员|代码|C++|Java|Android">
<meta property="og:type" content="website">
<meta property="og:title" content="胡博靖的技术博客">
<meta property="og:url" content="http://hubojing.github.io/index.html">
<meta property="og:site_name" content="胡博靖的技术博客">
<meta property="og:description" content="计算机|软件|开发|研发|通信工程|互联网|编程|程序员|代码|C++|Java|Android">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="胡博靖的技术博客">
<meta name="twitter:description" content="计算机|软件|开发|研发|通信工程|互联网|编程|程序员|代码|C++|Java|Android">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="胡博靖的技术博客" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.png">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">





    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/green/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">


    <style> .article { opacity: 0;} </style>


<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>胡博靖的技术博客</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: false,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: true
    }
</script>


    <script>
        yiliaConfig.jquery_ui = [true, "//cdn.bootcss.com/jqueryui/1.10.4/jquery-ui.min.js", "//cdn.bootcss.com/jqueryui/1.10.4/css/jquery-ui.min.css"];
    </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1498247776150&amp;di=a1fdc0869f65da377118893dfe708f5e&amp;imgtype=0&amp;src=http%3A%2F%2Fimg5.duitang.com%2Fuploads%2Fitem%2F201508%2F24%2F20150824132210_HjBJC.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">胡博靖</a></h1>
        </hgroup>

        
        <p class="header-subtitle">小清新IT旅程|为中华崛起读书</p>
        <p class="post-count">已写75.6k字</p>
        

        
            <form id="search-form">
            <input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload="false" />
            <i class="fa fa-times" onclick="resetSearch()"></i>
            </form>
            <div id="local-search-result"></div>
            <p class='no-result'>No results found <i class='fa fa-spinner fa-pulse'></i></p>
        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/categories/互联网">互联网</a></li>
                        
                            <li><a href="/categories/通信工程">通信工程</a></li>
                        
                            <li><a href="/categories/杂谈">杂谈</a></li>
                        
                            <li><a href="/about/">关于</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:hubojing@outlook.com" title="Email"></a>
                            
                                <a class="fa GitHub" href="https://github.com/hubojing" title="GitHub"></a>
                            
                                <a class="fa RSS" href="/atom.xml" title="RSS"></a>
                            
                                <a class="fa CSDN" href="http://blog.csdn.net/hubojing/" title="CSDN"></a>
                            
                                <a class="fa 网易云音乐" href="http://music.163.com/#/user/home?id=92203594" title="网易云音乐"></a>
                            
                                <a class="fa QQ" href="http://wpa.qq.com/msgrd?v=3&uin=417797456&site=qq&menu=yes" title="QQ"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/1602/">1602</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DigitalOcean/">DigitalOcean</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flash/">Flash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Github/">Github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HOOPS-3D/">HOOPS 3D</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MFC/">MFC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MFC-多线程/">MFC 多线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MFC-爬虫/">MFC 爬虫</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PPT动画/">PPT动画</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/">android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/blog/">blog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/eclipse/">eclipse</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/idea/">idea</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/markdown/">markdown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/matlab/">matlab</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/photoshop/">photoshop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/socket/">socket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/主题/">主题</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/优化/">优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/函数/">函数</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/创意/">创意</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/动画/">动画</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/单片机/">单片机</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/域名/">域名</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/多说/">多说</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/密码锁/">密码锁</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/嵌入式系统/">嵌入式系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/思维/">思维</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/思考/">思考</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/教程/">教程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数字信号处理/">数字信号处理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/显示技术/">显示技术</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/服务器/">服务器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/杂谈/">杂谈</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/矩阵键盘/">矩阵键盘</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/竞赛/">竞赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/说明/">说明</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/问题/">问题</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="http://moxfive.xyz/">MOxFIVE</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://www.domeyi.com/">小忆</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://blog.iwangyu.cn/">WangYu</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://ursb.me/">Airing</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://txiner.top/">Hundred</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://www.ersaijun.cn/">二赛君</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://blog.yeqianfeng.me/">太阳尚远</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://blog.qiujinfeng.com/">邱锦锋</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://www.ibertinelym.com/">李玉明</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://blog.waydrow.com/">Waydrow</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://qqdie.com/">Jrotty</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://blog.just666.cn/">Shawn</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://theask.cn/">该问</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://www.sfantree.com/">水番林</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://hsmouc.com/">空白</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://www.61mon.com/">刘毅</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://www.pokerboy.cn/">柚子鬼</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://zcheng.ren/">ZeeCoder</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://www.zcmol.cn/">早茶月光</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://rebootcat.com/">Linux之路</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://www.townwang.com/">王振镇</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://shawnzeng.com/">Shawnzeng</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://blog.52itstyle.com/">小柒博客</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://frankchen.xyz/">不正经数据科学家</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://nolongerwait.com/">秦简</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://xiaowiba.com/">小尾巴</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">人生如编程，自顶向下，逐步求精。</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">胡博靖</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1498247776150&amp;di=a1fdc0869f65da377118893dfe708f5e&amp;imgtype=0&amp;src=http%3A%2F%2Fimg5.duitang.com%2Fuploads%2Fitem%2F201508%2F24%2F20150824132210_HjBJC.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">胡博靖</a></h1>
            </hgroup>
            
            <p class="header-subtitle">小清新IT旅程|为中华崛起读书</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/categories/互联网">互联网</a></li>
                
                    <li><a href="/categories/通信工程">通信工程</a></li>
                
                    <li><a href="/categories/杂谈">杂谈</a></li>
                
                    <li><a href="/about/">关于</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:hubojing@outlook.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/hubojing" title="GitHub"></a>
                            
                                <a class="fa RSS" target="_blank" href="/atom.xml" title="RSS"></a>
                            
                                <a class="fa CSDN" target="_blank" href="http://blog.csdn.net/hubojing/" title="CSDN"></a>
                            
                                <a class="fa 网易云音乐" target="_blank" href="http://music.163.com/#/user/home?id=92203594" title="网易云音乐"></a>
                            
                                <a class="fa QQ" target="_blank" href="http://wpa.qq.com/msgrd?v=3&uin=417797456&site=qq&menu=yes" title="QQ"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap">
  
    <article id="post-HOOPS记录" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/06/25/HOOPS记录/" class="article-date">
      <time datetime="2017-06-25T14:54:44.000Z" itemprop="datePublished">2017-06-25</time>
</a>

 
    <a href="/2017/06/25/HOOPS记录/#comments" title="查看评论">
        <i class="fa fa-comments-o" aria-hidden="true"></i>
        <span class="count-comment"></span>
        
        
            <span class="disqus-comment-count" data-disqus-identifier="2017/06/25/HOOPS记录/"></span>
        
    </a>

    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/25/HOOPS记录/">HOOPS记录</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>&lt;div align=&quot;left&quot;&gt;
&lt;img src=&quot;https://ss2.bdstatic.com/70cFvnSh_Q1YnxGkpoWK1HF6hhy/it/u=2467623496,1926622754&amp;fm=15&amp;gp=0.jpg&quot; width=&quot;300&quot; height=&quot;180&quot; style=&quot;float:right;&quot;/&gt;</p>
<p>HOOPS初学概念小记（自用笔记）。</p>
<p>&lt;/div&gt;</p>
<p>&lt;!--more--&gt;</p>
<h1 id="hoops-3d-application-framework-hoops3daf">HOOPS 3D Application Framework (HOOPS/3dAF)</h1>
<p>官网描述
With HOOPS Visualize, you can rapidly produce eye-popping graphics across both mobile and desktop platforms.</p>
<p>At its core, HOOPS Visualize provides a flexible, hierarchical scene management engine capable of handling a range of graphics entities, together with a sophisticated graphics pipeline and high-performance graphics and interaction handling algorithms. It also delivers advanced capabilities to accelerate your application development, including an animation engine, clash detection, multi-plane sectioning, and large model visualization.</p>
<h1 id="hoops-基本图元和属性支持">HOOPS 基本图元和属性支持</h1>
<blockquote>
<p>几 何</p>
</blockquote>
<ul>
<li>Images, Unicode Text, Points, Lines, Polygons, Polylines, Polycylinders, NURBS curves, NURBS surfaces, Arcs, Ellipses, Circles, Tristrips, Trifans, Indexed Facesets, Cutting Planes, Capping Geometry</li>
</ul>
<blockquote>
<p>几何属性
Color, Transparency, Textures, Visibility, Patterns (Facet,edge 和 Line), Color Ramps, Lighting Interpolation, Selectability
渲染属性
Shaded, Analytic Hidden Line, Wireframe,Color Maps, Various Color Ramping Algorithms, Window Background Coloring</p>
</blockquote>
<p>edges包含polygons,shells,meshes.
faces包含shells和meshes.
markers 单独的点.</p>
<p>标记marker</p>
<blockquote>
<p>可作为注释来使用</p>
</blockquote>
<ul>
<li>当放大和缩小时标记的大小是不变的</li>
<li>标记的大小是朝向相机的，它并不旋转</li>
</ul>
<h1 id="hoops-mvo-mvo分别是model-view-operator的缩写">HOOPS MVO  （MVO分别是Model、View、Operator的缩写）</h1>
<blockquote>
<p>段结构</p>
</blockquote>
<ul>
<li>HDB</li>
<li>HBaseModel：处理在包含库下的段</li>
<li>HBaseView：处理在驱动段下的段和实例</li>
<li>HbaseOperator：处理图形用户界面/事件循环
· 相机操作
· 几何对象操作
· 选择</li>
</ul>
<h1 id="3d应用程序中经常用到的函数">3D应用程序中经常用到的函数</h1>
<ul>
<li>保存应用程序数据</li>
<li>绘制应用程序数据</li>
<li>管理应用程序数据</li>
<li>相机</li>
<li>选择</li>
<li>坐标</li>
<li>查询</li>
<li>驱动器设置</li>
</ul>
<h1 id="shell官网描述">shell官网描述</h1>
<p>3D applications typically represent 3D objects with an “indexed face set” or “polygon-point mesh”. In Visualize, such primitives are called ‘shells’. A shell defines the boundary surface of an object in 3D using a set of planar polygons. Polygons can be multi-sided and can include holes. A shell is defined as an array of vertices (3D points) and an array of indices into the vertex array that define each polygonal face.</p>
<p>HOOPS Visualize supports a wide range of advanced functionality relating to shells, including the ability to select, highlight, and modify individual sub-entities (faces, edges, and vertices). Attributes such as normals, colors, and texture coordinates can also be set at the sub-entity level to enable a variety of complex shading and display.</p>
<p>Shell   一系列连通的Face / Wire的集合。线、面的集合，能位于实体外，也能在内部形成空洞。一个体含一个悬挂面，一个体内嵌许多和外表面相连的面都称为shell。</p>
<h2 id="shell-attributes属性">shell attributes属性</h2>
<p>1.Vertex markers
2.Silhouette（外表面）/perimeter/hard/adjacent edges
3.Cut edges/faces
4.Attributes on subparts
5.Smooth shading
6.Advanced rendering</p>
<h1 id="selection官网描述">selection官网描述</h1>
<p>The Visualize libraries provide multiple operations for selection and several advanced highlighting techniques.</p>
<p>Selection</p>
<p>Control over what is targeted for selection is configurable:</p>
<p>Segments in the scene graph can be marked as available for selection
The selection level can be specified – entity, geometry, segment, or segment tree. Selection of individual vertices, edges and faces can be configured
The number of selected items to search for is configurable
The selection proximity can be used to select the nearest item on screen within a screen-based tolerance
Selections can be made of all items inside and outside a drag box, inside arbitrary screen regions defined by polylines or polygons, by a volume of 3D space, and by an arbitrary triangle mesh in 3D for clash/collision detection.</p>
<h1 id="坐标系coordinate-systems">坐标系（Coordinate Systems）</h1>
<p>对象（Object）-&gt;世界（World）-&gt;(-&gt;视点ViewPoint)-&gt;外窗口（Outer Window）-&gt;像素（Pixel）</p>
<h1 id="参考资料">参考资料</h1>
<p><a href="https://wenku.baidu.com/view/a19bf8ec4afe04a1b071ded2.html?re=view" target="_blank" rel="external">HOOPS基础培训课程1</a>
<a href="https://wenku.baidu.com/view/a0154f28915f804d2b16c1d2.html?re=view" target="_blank" rel="external">HOOPS基础培训课程2</a>
<a href="https://wenku.baidu.com/view/84fdc0c789eb172ded63b7d2.html?re=view" target="_blank" rel="external">HOOPS基础培训课程3</a>
<a href="https://wenku.baidu.com/view/796caa5377232f60ddcca102.html?re=view" target="_blank" rel="external">HOOPS_MFC应用程序向导</a></p>
<p>---插播一条消息
微博的消息（不晓得真假，要是辟谣了我就删掉→_→）
【微软惊呆：Win 10源代码泄漏！】外媒Theregister获得消息称，Win10源代码目前在网上被大量泄漏，这些源代码大小超过32TB。据悉，这些代码在今年三月左右在微软内部系统当中流出，包含Win10硬件驱动程序源码及USB和Wi-Fi协议栈等，获得源代码的黑客将可以查找系统中的漏洞用来破坏全球Windows系统.. ​</p>
<p>震惊！Windows系统走向开源…国产自主研发加速</p>
<p><strong>32T的代码量………………</strong></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/互联网/">互联网</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HOOPS-3D/">HOOPS 3D</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
	


  
  
</article>









  
    <article id="post-MFC-多线程-进度条-复制文件（夹）" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/06/15/MFC-多线程-进度条-复制文件（夹）/" class="article-date">
      <time datetime="2017-06-15T10:00:17.000Z" itemprop="datePublished">2017-06-15</time>
</a>

 
    <a href="/2017/06/15/MFC-多线程-进度条-复制文件（夹）/#comments" title="查看评论">
        <i class="fa fa-comments-o" aria-hidden="true"></i>
        <span class="count-comment"></span>
        
        
            <span class="disqus-comment-count" data-disqus-identifier="2017/06/15/MFC-多线程-进度条-复制文件（夹）/"></span>
        
    </a>

    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/15/MFC-多线程-进度条-复制文件（夹）/">MFC+多线程+进度条+复制文件（夹）</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>&lt;div align=&quot;left&quot;&gt;
&lt;img src=&quot;https://ss3.bdstatic.com/70cFv8Sh_Q1YnxGkpoWK1HF6hhy/it/u=1049830277,1612840852&amp;fm=26&amp;gp=0.jpg&quot; width=&quot;300&quot; height=&quot;180&quot; style=&quot;float:right;&quot;/&gt;</p>
<p>MFC，多线程+进度条+复制文件（夹）小程序。</p>
<p>&lt;/div&gt;</p>
<p>&lt;!--more--&gt;</p>
<p>多线程：</p>
<ol>
<li>做一个MFC对话框程序。</li>
<li>点击开始按钮，程序启动一个工作线程，复制指定的文件夹到目标位置。</li>
<li>同时在更新进度条，反映当前的复制进度（按文件数量计算进度）。</li>
<li>点击停止按钮时终止，但需要保证当前正在复制的文件得以复制完成。</li>
<li>工作线程访问主线程需要使用消息机制，不能直接访问。</li>
<li>主界面不能锁死，停止按钮需要随时可以响应点击。</li>
</ol>
<p>整体思路：
在开始按钮里的响应函数中创建一个线程，在线程里复制，通过消息机制更新进度条，在消息机制的函数中和复制过程关联显示进度。</p>
<p>需要解决的问题：
1.怎么创建线程
2.怎么更新进度条
3.怎么将编辑框中输入的路径被copyfile函数读取到
4.怎么获取文件个数（遍历）
5.怎么把进度条和复制文件进度关联
（通过文件个数 进度条范围设置为0-文件数量长度	步长为1 完成一次复制加一次）
6.点击取消怎么保证当前正在复制的文件得以复制完成</p>
<p>获取个数：
递归遍历整个文件夹，然后递归复制文件到目的文件夹。
在递归遍历整个文件夹的时候，就可以拿到整个文件夹的大小以及文件数量。</p>
<p>传递进度数据，用postmessage到该进度条的窗口，在进度条窗口获取该消息 设置SetPos，updatedata该控件。
一个对话框里有个进度条控件，当线程接收到数据（文件的总大小和收到的大小）postmessage给对话框，对话框的PreTranslateMessage(MSG* pMsg)截取该消息设置进度条控件（范围和增量，setpos）。</p>
<p>关键代码：</p>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//复制函数</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">CopyDirectory</span><span class="params">(CString source, CString target, CCopyFoldersDlg * pDlg)</span>    </span></div><div class="line">&#123;</div><div class="line"> 	 </div><div class="line">	CreateDirectory(target,<span class="literal">NULL</span>);   </div><div class="line">  </div><div class="line">    CFileFind finder;    </div><div class="line">    CString path;    </div><div class="line">    path.Format(<span class="number">_</span>T(<span class="string">"%s\\*.*"</span>),source);    </div><div class="line">  </div><div class="line">    BOOL bWorking = finder.FindFile(path);    </div><div class="line">    <span class="keyword">while</span> (bWorking)  </div><div class="line">    &#123;   </div><div class="line">        bWorking = finder.FindNextFile();   </div><div class="line">           </div><div class="line">        <span class="keyword">if</span> (finder.IsDirectory() &amp;&amp; !finder.IsDots())  </div><div class="line">        &#123;   </div><div class="line">            CopyDirectory(finder.GetFilePath(), target+<span class="number">_</span>T(<span class="string">"\\"</span>)+finder.GetFileName(), pDlg);  <span class="comment">//递归 </span></div><div class="line">        &#125;    </div><div class="line">        <span class="keyword">else</span>  </div><div class="line">        &#123;      </div><div class="line"></div><div class="line">			WaitForSingleObject(pDlg-&gt;hEvent,INFINITE);</div><div class="line"></div><div class="line">            CopyFile(finder.GetFilePath(), target+<span class="number">_</span>T(<span class="string">"\\"</span>)+finder.GetFileName(), FALSE);   </div><div class="line">            count++;  </div><div class="line">            pDlg-&gt;PostMessage(WM_USER_PROCESS, count);  </div><div class="line">          </div><div class="line">  </div><div class="line">             Sleep(<span class="number">50</span>);   </div><div class="line">        &#125;   </div><div class="line">    &#125;    </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">VOID <span class="title">GetInfo</span><span class="params">(CString csPath, <span class="keyword">long</span>&amp; FoldersNum, <span class="keyword">long</span>&amp; FilesNum)</span>  </span></div><div class="line">&#123;     </div><div class="line">    SetCurrentDirectory(csPath);  </div><div class="line">    CFileFind finder;  </div><div class="line">    BOOL bWorking = finder.FindFile(<span class="number">_</span>T(<span class="string">"*.*"</span>));  </div><div class="line">    <span class="keyword">while</span>(bWorking)  </div><div class="line">    &#123;  </div><div class="line">        bWorking = finder.FindNextFile();  </div><div class="line">  </div><div class="line">        <span class="keyword">if</span>(finder.IsDots())   </div><div class="line">        &#123;  </div><div class="line">            <span class="keyword">continue</span>;  </div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(finder.IsDirectory())  </div><div class="line">        &#123;  </div><div class="line">            ++FoldersNum;  </div><div class="line">            GetInfo(finder.GetFilePath(), FoldersNum, FilesNum);  </div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">else</span>  </div><div class="line">        &#123;  </div><div class="line">            ++FilesNum;  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">      </div><div class="line">&#125;  </div><div class="line"></div><div class="line"><span class="comment">//复制线程</span></div><div class="line">DWORD WINAPI CCopyFoldersDlg::CopyFolders(LPVOID pParam)</div><div class="line">&#123;  </div><div class="line">	CCopyFoldersDlg* pDlg = (CCopyFoldersDlg*)pParam;  </div><div class="line"></div><div class="line">	 <span class="keyword">if</span> (!pDlg) </div><div class="line">	 &#123;</div><div class="line">		 <span class="keyword">return</span> <span class="number">0</span>;  </div><div class="line">	 &#125;</div><div class="line">	 ResetEvent(pDlg-&gt;hExit);  </div><div class="line"></div><div class="line">	<span class="keyword">long</span> FoldersNum  = <span class="number">0</span>;                 </div><div class="line">    <span class="keyword">long</span> FilesNum = <span class="number">0</span>;                  </div><div class="line">    GetInfo(pDlg-&gt;m_SrcPath,FoldersNum, FilesNum);  </div><div class="line">	pDlg-&gt;m_Progress.SetRange(<span class="number">0</span>, FilesNum);  </div><div class="line">    pDlg-&gt;m_Progress.SetStep(<span class="number">1</span>); </div><div class="line">	CopyDirectory(pDlg-&gt;m_SrcPath, pDlg-&gt;m_DesPath, pDlg);   </div><div class="line"></div><div class="line">	SetEvent(pDlg-&gt;hExit);  </div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">LRESULT CCopyFoldersDlg::Do_process(WPARAM wParam, LPARAM lParam)   </div><div class="line">&#123;   </div><div class="line">   wParam += <span class="number">1</span>;  </div><div class="line">   m_Progress.SetPos(wParam);    </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </div><div class="line">&#125;         </div><div class="line">  </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">void</span> CCopyFoldersDlg::OnStart() </div><div class="line">&#123;</div><div class="line">	UpdateData(<span class="literal">true</span>);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> ((m_SrcPath.IsEmpty() &amp;&amp; m_DesPath.IsEmpty()))</div><div class="line">	&#123;</div><div class="line">		MessageBox(<span class="string">"路径不能为空！"</span>);</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">else</span></div><div class="line">	&#123;</div><div class="line">		<span class="comment">//创建线程</span></div><div class="line">		hThread = CreateThread(<span class="literal">NULL</span>, <span class="number">0</span>, CopyFolders, <span class="keyword">this</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</div><div class="line">		hEvent = CreateEvent(<span class="literal">NULL</span>, TRUE, TRUE, <span class="literal">NULL</span>);</div><div class="line">		CloseHandle(hThread);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">void</span> CCopyFoldersDlg::OnStop() </div><div class="line">&#123;</div><div class="line">	m_iStatus++;  </div><div class="line">         </div><div class="line">    <span class="keyword">if</span> (m_iStatus % <span class="number">2</span> == <span class="number">0</span>)  </div><div class="line">    &#123;    </div><div class="line">         SetEvent(hEvent);</div><div class="line">    &#125;   </div><div class="line">    <span class="keyword">else</span>  </div><div class="line">    &#123;  </div><div class="line">        ResetEvent(hEvent);</div><div class="line">    &#125;  </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> CCopyFoldersDlg::OnTimer(UINT_PTR nIDEvent)  </div><div class="line">&#123;  </div><div class="line">    CDialog::OnTimer(nIDEvent);  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>界面：
<img src="http://img.blog.csdn.net/20170615182222589?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="界面"></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/互联网/">互联网</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MFC-多线程/">MFC 多线程</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
	


  
  
</article>









  
    <article id="post-MFC网页分析程序" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/06/14/MFC网页分析程序/" class="article-date">
      <time datetime="2017-06-14T14:45:38.000Z" itemprop="datePublished">2017-06-14</time>
</a>

 
    <a href="/2017/06/14/MFC网页分析程序/#comments" title="查看评论">
        <i class="fa fa-comments-o" aria-hidden="true"></i>
        <span class="count-comment"></span>
        
        
            <span class="disqus-comment-count" data-disqus-identifier="2017/06/14/MFC网页分析程序/"></span>
        
    </a>

    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/14/MFC网页分析程序/">MFC网页分析程序</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>&lt;div align=&quot;left&quot;&gt;
&lt;img src=&quot;https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1497464380109&amp;di=1e9f39d0b13b850e8ec21fd0e1f0f262&amp;imgtype=0&amp;src=http%3A%2F%2Fimg.weixinyidu.com%2F151130%2F39b5d6c2.jpg&quot; width=&quot;300&quot; height=&quot;180&quot; style=&quot;float:right;&quot;/&gt;</p>
<p>开发一个网页分析程序，可以抓取特定网页的内容，加以分析之后将结果保存之数据库。</p>
<p>&lt;/div&gt;</p>
<p>&lt;!--more--&gt;</p>
<p>插播一段闲话：</p>
<pre><code>毕设告一段落，真的要毕业啦。
毕设期间，感觉自己学到了不少Android开发的基本东西，但我都不敢写文章发上来。因为在paperfree查重时显示，我抄袭了一篇文章：
来源：互联网资源	标题：**************（具体文章名就匿了） - 胡博靖的技术博客

还有比这更惨的事情吗？说我抄袭了自己的文章[哭泣]

最终知网查重率1.3%，毕设顺利完成，挺开心的，虽然编程过程遇到了很多的难题，好在大都解决了。导师人也很好，给人感觉是才华横溢的学者型，交材料时我们聊了聊各自毕业的场景，他祝贺我们毕业时，感觉真的就到了离开学校的时候，时光飞逝啊。
</code></pre>
<p>-----------------------------------------------------------------闲话分割线---------------------------------------------------------------------</p>
<p>网页分析程序具体要求描述如下：
1.使用http技术获取一个博客的首页http://blog.csdn.net/jiangsheng
2.分析这个网页的内容，从中找到博客中每一篇文章的链接。
3.通过这些链接，获取文章的正文网页，从内容中提取文章的标题和文章的内容。
4.将文章的标题与内容分别保存至数据库。
5.布局要求：提供一个列表框和一个多行文本框。列表框中显示从数据库中获取的文章标题列表；当点击列表框中的某一篇文章时，在文本框中显示该文章的内容。</p>
<p>首先实现获取网页源码的功能：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> CGetWebDlg::OnGetweb() </div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add your control notification handler code here</span></div><div class="line">	CInternetSession session;</div><div class="line">	CHttpFile *file = <span class="literal">NULL</span>; </div><div class="line">	CString strURL = <span class="string">"http://blog.csdn.net/jiangsheng"</span>;</div><div class="line">    CString strHtml = <span class="number">_</span>T(<span class="string">""</span>); <span class="comment">//存放网页数据</span></div><div class="line"> <span class="keyword">try</span></div><div class="line"> &#123; </div><div class="line">  </div><div class="line">	file =(CHttpFile*)session.OpenURL(strURL);</div><div class="line"> &#125; </div><div class="line"><span class="keyword">catch</span>(CInternetException *m_pException)</div><div class="line"> &#123; </div><div class="line">	file = <span class="literal">NULL</span>;</div><div class="line">	m_pException-&gt;m_dwError;</div><div class="line">	m_pException-&gt;Delete();</div><div class="line">	session.Close();</div><div class="line">	MessageBox(<span class="string">"网络连接错误"</span>,<span class="string">"提示"</span>);</div><div class="line">	<span class="keyword">return</span>;</div><div class="line"> &#125;</div><div class="line">	CString strLine;</div><div class="line">	<span class="keyword">char</span> sRecived[<span class="number">1024</span>];</div><div class="line">	<span class="keyword">if</span> (file != <span class="literal">NULL</span>) </div><div class="line">	&#123;</div><div class="line">		<span class="keyword">while</span>(file-&gt;ReadString((LPTSTR)sRecived,<span class="number">1024</span>)!=<span class="literal">NULL</span>) </div><div class="line">		&#123;</div><div class="line">			strHtml += sRecived; </div><div class="line">		&#125;</div><div class="line"> &#125;</div><div class="line">	<span class="keyword">else</span></div><div class="line">	&#123; </div><div class="line">		AfxMessageBox(<span class="number">_</span>T(<span class="string">"失败！"</span>));</div><div class="line">	&#125;</div><div class="line">        session.Close();</div><div class="line">		file-&gt;Close();</div><div class="line">		<span class="keyword">delete</span> file; </div><div class="line">		file = <span class="literal">NULL</span>;</div><div class="line"></div><div class="line">		ConvertUtf8ToGBK(strHtml);<span class="comment">//源码转换</span></div><div class="line">		(<span class="keyword">this</span>-&gt;GetDlgItem(IDC_EDITCONTENT))-&gt;SetWindowText(strHtml);</div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>注意网页编码问题，因此需要格式转换，编写一个函数：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span>  <span class="title">ConvertUtf8ToGBK</span><span class="params">(CString &amp;strUtf8)</span></span></div><div class="line">&#123;</div><div class="line">          </div><div class="line">    <span class="keyword">int</span> len=MultiByteToWideChar(CP_UTF8, <span class="number">0</span>, (LPCTSTR)strUtf8, <span class="number">-1</span>, <span class="literal">NULL</span>,<span class="number">0</span>);</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> * wszGBK = <span class="keyword">new</span> <span class="keyword">unsigned</span> <span class="keyword">short</span>[len+<span class="number">1</span>];</div><div class="line">	<span class="built_in">memset</span>(wszGBK, <span class="number">0</span>, len * <span class="number">2</span> + <span class="number">2</span>);</div><div class="line">	MultiByteToWideChar(CP_UTF8, <span class="number">0</span>, (LPCTSTR)strUtf8, <span class="number">-1</span>, (LPWSTR)wszGBK, len);</div><div class="line"> </div><div class="line">	len = WideCharToMultiByte(CP_ACP, <span class="number">0</span>, (LPCWSTR)wszGBK, <span class="number">-1</span>, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>); </div><div class="line">	<span class="keyword">char</span> *szGBK=<span class="keyword">new</span> <span class="keyword">char</span>[len + <span class="number">1</span>];</div><div class="line">	<span class="built_in">memset</span>(szGBK, <span class="number">0</span>, len + <span class="number">1</span>);</div><div class="line">	WideCharToMultiByte (CP_ACP, <span class="number">0</span>, (LPCWSTR)wszGBK, <span class="number">-1</span>, szGBK, len, <span class="literal">NULL</span>,<span class="literal">NULL</span>);</div><div class="line"> </div><div class="line">	strUtf8 = szGBK;</div><div class="line">	 <span class="keyword">delete</span>[] szGBK;</div><div class="line">	 <span class="keyword">delete</span>[] wszGBK;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://img.blog.csdn.net/20170614232311302?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="显示源码"></p>
<p>有些类似网页爬虫的感觉。
为了接下来的操作，我去学正则表达式了……</p>
<p>P.S.虽然蒋晟CSDN不更新了，但最近看他在知乎上怼别人的唇枪舌战……可带劲了哈哈哈</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/互联网/">互联网</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MFC-爬虫/">MFC 爬虫</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
	


  
  
</article>









  
    <article id="post-靖靖的脑洞大开（一）" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/03/12/靖靖的脑洞大开（一）/" class="article-date">
      <time datetime="2016-03-12T06:23:00.000Z" itemprop="datePublished">2016-03-12</time>
</a>

 
    <a href="/2016/03/12/靖靖的脑洞大开（一）/#comments" title="查看评论">
        <i class="fa fa-comments-o" aria-hidden="true"></i>
        <span class="count-comment"></span>
        
        
            <span class="disqus-comment-count" data-disqus-identifier="2016/03/12/靖靖的脑洞大开（一）/"></span>
        
    </a>

    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/12/靖靖的脑洞大开（一）/">靖靖的脑洞大开 | Jinger&#39;s Special Ideas</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>&lt;div align=&quot;left&quot;&gt;
&lt;img src=&quot;http://7xray0.com1.z0.glb.clouddn.com/16-6-14/19192858.jpg&quot; width=&quot;300&quot; height=&quot;180&quot; alt=&quot;配图&quot; style=&quot;float:right;&quot;/&gt;</p>
<p>&lt;/div&gt;
本文属于胡博靖的创意（偶尔天马行空的脑洞）。
稀奇古怪的idea有时就像柯南每次推理正确时被闪电般电流击中一样……
愿创造力永不枯竭……</p>
<h1 id="201767更新-关于量子传输">2017.6.7更新 关于量子传输</h1>
<p>前一段时间周末两天在学校过了一把监考瘾……考生的年纪都比我大，可是还是得叫我老师→_→（莫名占了便宜哈哈哈）
监考4小时，腿酸1整天。</p>
<p>监考这件事儿，多么浪费人力财力，得找人来监考，发卷子，整理卷子……
站着闲得慌，我就在想，能不能都给一体化解决了，不要人来监考。</p>
<p>&lt;!--more--&gt;</p>
<p>脑洞：
运用<a href="http://baike.baidu.com/link?url=qx-PpbOFOjPMSYyMBh8ggHAwrCMBGTgaWXI9ZVGCgdfIpwTy5g3FPAegJ3EKTzocBgl-00pYRPmNR6YfflZN4I9CziuEnvLgQKVNwfKvFDkh1JFOvRns5D0jCeQ2hRuP#2" target="_blank" rel="external">量子传输技术</a>  、 <a href="http://baike.baidu.com/link?url=P0RmCSc2uDs5uhKCAffsqjBX4l92qBBASLGrvsd4JsNAv4f9maKL2XWmEtkM_-fNvfHkFhS6-VCK4YMSChCd0PaG1DQg2mEdCTWsDn03KIE7irD2G3G81I2jCM7Hr38g" target="_blank" rel="external">量子传送技术</a> ，将卷子传送到每个考场。同时，每个考生的桌子有升降板，考试时自动升起成为隔板，还可以隔音。防止前后左右抄袭。桌面材料是那种无法用笔写字的光滑材料，内附电子屏显示考试要点，可以刷新和清屏。至于考生随身携带纸条等，在门上装的安检装置可检测。若考生遇到问题，可按桌上按钮与后台管理老师用语音或文字反馈问题。最后答题卡再传送回考务中心。</p>
<p>嗯，只有一个问题，就是费钱，哦，还有量子传输技术目前还在实验阶段。</p>
<hr>
<h1 id="2017513更新-关于电脑病毒">2017.5.13更新  关于电脑病毒</h1>
<p>防范ONION勒索软件（永恒之蓝）病毒攻击
毕设关键期，对大四毕业狗满满的恶意！</p>
<p>再论备份的重要性
论开启自动更新的重要性</p>
<p>【紧急通知！】请连接校园网的Windows用户注意了！近期，国内多所院校出现了ONION勒索软件感染情况，一旦感染，会对同学们的资料与数据造成严重损失，只有支付高额赎金才能解密恢复文件。请同学们将系统445端口关闭，并用免疫程序检查一下自己的电脑是否被进攻。</p>
<p>然后又去知乎逛了逛，果然推送一篇文章：<a href="https://zhuanlan.zhihu.com/p/26878511?group_id=846548441655046144" target="_blank" rel="external">关于防范 ONION 勒索软件（永恒之蓝）病毒攻击的紧急通知及应对办法</a>
关端口方法和补丁也在文中了。不过win10自动更新嘿嘿嘿</p>
<p>六点半看到这个新闻就爬起来了。心里默念，幸亏每日做毕设都U盘备份，机智如我。
看着新闻里那张勒索弹窗图片，仿佛感受到毕设被锁的戳心之痛……</p>
<p>不过最近慎点教育网，总是有些不放心。</p>
<p>事件评论：<a href="https://www.zhihu.com/question/59765277/answer/168681832" target="_blank" rel="external">如何看待 5 月12 号爆发在各高校电脑勒索比特币的病毒？</a></p>
<p>关于信息安全，突然就想起自己在信息安全课上做的一个关于RSA密钥的加密解密的玩意儿，当时听信息安全各种高大上，以至于我选择了教这门课的老师当导师……后来RSA的第一次亲密接触竟是在hexo的SSH连接上……人生处处是巧合</p>
<p>有次移动通信课上，老师说未来是云的天下，课下我找老师讨论说，我觉得云并不安全，比如我，宁愿花钱买硬盘备份，也不愿意将重要文件放到云端。老师只是说，以后技术发展，云可以做到相对安全。现在想来，如果数据量庞大到不可想象的数量级呢？买硬盘怕是不能解决问题了。可能这种时候还是得靠云技术。
扯远了。</p>
<p>不过说实话，十年来，电脑安全好多了，十年前XP天天下各种防护工具还是拦不住各种病毒，后来换win7，到win8，到win8.1，到如今win10，就只用系统自带的杀软了，反而几乎不中毒了。</p>
<p>【脑洞】既然程序可以写病毒，也可以用程序反病毒。人工智能上啊！让程序自己学习病毒，然后以其人之道还治其人之身。</p>
<hr>
<h1 id="2016613更新-关于电">2016.6.13更新 关于电</h1>
<p>严格说是我室友的想法。
她说，要是电像wifi一样不用线传输多好……（一个被各种电线搅的烦躁的girl的抱怨）
→_→→_→→_→→_→→_→→_→“用一种气体包裹着电，这样就不会电死啦……”
我百度了一下，发现真的可以耶……</p>
<h2 id="电能无线传输技术">电能无线传输技术</h2>
<p>原理：利用电磁场，把电能像信号一样发射到用电设备上去，有点类似WiFi。电器不需再用电线，只需一个电能的发射装置和一个接收装置。
看来，无线时代正在向我们走来。</p>
<hr>
<h1 id="2016315更新关于人工智能">2016.3.15更新	关于人工智能</h1>
<p>今天看到一篇评论，写的不错，发上来。其中有几句话说的很好：
<strong>技术群体战胜了天赋极高的自然个体。</strong>
<strong>就算真的有“征服”发生，那也是新人类征服了旧人类，而不是人类的末日。</strong>
该文还提到了“虚拟现实”的概念，让我瞬间想到了柯南剧场版：贝克街的亡灵。带着头盔，仿佛身处他处。
<strong>人工智能是让人类生活的劳作性内容越来越少，而虚拟现实是让人类生存生活的创造性意义大规模扩充。</strong>
<img src="/images/2.jpg" alt="整面">
<img src="/images/1.jpg" alt="部分"></p>
<hr>
<h2 id="ai向">AI向</h2>
<p>最近阿尔法狗赢李世石的新闻响遍全世界。（阿尔法狗是一种什么狗→_→）
人工智能，这个神秘又让人畏惧的高科技哟…</p>
<h2 id="人工智能">人工智能</h2>
<p>人工智能（Artificial Intelligence），英文缩写为AI。它是研究、开发用于模拟、延伸和扩展人的智能的理论、方法、技术及应用系统的一门新的技术科学。 人工智能是计算机科学的一个分支，它企图了解智能的实质，并生产出一种新的能以人类智能相似的方式做出反应的智能机器，该领域的研究包括机器人、语言识别、图像识别、自然语言处理和专家系统等。人工智能从诞生以来，理论和技术日益成熟，应用领域也不断扩大，可以设想，未来人工智能带来的科技产品，将会是人类智慧的“容器”。</p>
<p>看它涉及的范围之广：实际应用
机器视觉，指纹识别，人脸识别，视网膜识别，虹膜识别，掌纹识别，专家系统，自动规划，智能搜索，定理证明，博弈，自动程序设计，智能控制，机器人学，语言和图像理解，遗传编程等。</p>
<p>人工智能就其本质而言，是对人的思维的信息过程的模拟。</p>
<p>对于人的思维模拟可以从两条道路进行，一是结构模拟，仿照人脑的结构机制，制造出“类人脑”的机器；二是功能模拟，暂时撇开人脑的内部结构，而从其功能过程进行模拟。现代电子计算机的产生便是对人脑思维功能的模拟，是对人脑思维的信息过程的模拟。</p>
<p><strong>以上转自百度百科……</strong></p>
<p>和室友辩论，阿尔法狗是否能赢所有人。我觉得可以，如果算法足够精确，存储足够大到可以容纳全部走法。（这个数量级是10^172次方……目前也许是远远达不到这个指标的。不知道从理论上讲，存储可以达到这么多吗？）</p>
<p><strong>脑洞</strong>：我相信人类开发AI的初始目的一定是<strong>服务人类</strong>的。但是，人类不得不警惕，拥有人类智慧的机器人（或者其他形态的机器），在各个方面都优于人类机体时，是否有<strong>灭亡人类</strong>的可能性。有人和我辩论，认为机器永远不可能比人类有智慧。对此我持保留态度。也许现在的机器的核心是人类输入的程序算法，但当病毒入侵或机器足够智能化到可以自我优化代码时，甚至结合仿生学或者神经学相关，使机器能<strong>自我学习</strong>，具备类似于人类情感的机能，将是人类最大的敌人。（机器内心OS：我比你强比你壮，为什么还要服务于人……）况且总有些野心科学家……将这种技术用于战争→_→其结果还是世界大战，人类遭殃。
<strong>所以AI发展也应该有个底线，就和克隆人一样，任何人不能触碰。</strong></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/杂谈/">杂谈</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/idea/">idea</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/创意/">创意</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/思维/">思维</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
	


  
  
</article>









  
    <article id="post-多说关闭引发的麻烦" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/04/05/多说关闭引发的麻烦/" class="article-date">
      <time datetime="2017-04-05T08:44:21.000Z" itemprop="datePublished">2017-04-05</time>
</a>

 
    <a href="/2017/04/05/多说关闭引发的麻烦/#comments" title="查看评论">
        <i class="fa fa-comments-o" aria-hidden="true"></i>
        <span class="count-comment"></span>
        
        
            <span class="disqus-comment-count" data-disqus-identifier="2017/04/05/多说关闭引发的麻烦/"></span>
        
    </a>

    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/05/多说关闭引发的麻烦/">多说关闭引发的麻烦</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>&lt;div align=&quot;left&quot;&gt;
&lt;img src=&quot;https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1491392241106&amp;di=d26487a68371b445aa7b604ab2883ce1&amp;imgtype=0&amp;src=http%3A%2F%2Fimage103.360doc.com%2FDownloadImg%2F2017%2F02%2F1715%2F91672979_2.png&quot; width=&quot;300&quot; height=&quot;180&quot; style=&quot;float:right;&quot;/&gt;</p>
<blockquote>
<p>2017.5.27 已更换为Disqus</p>
</blockquote>
<p>由于Disqus被墙，可能需要科学上网后才能看到评论。
若墙内的朋友们需要评论，可以直接点击QQ图标（PC端在左边栏，移动端在页面上方），和我进行在线对话。</p>
<blockquote>
<p>2017.5.30 已导入历史评论</p>
</blockquote>
<p>虽然比不上多说，比网易云跟帖还是好很多了。
目前发现有一篇文章的评论导入失败，Disqus的显示如下：
Missing or invalid message 或 Unable to find parent post
我再看看怎么解决，是否需要手工导入。
参考：<a href="http://urouge.github.io/migrate-to-disqus/" target="_blank" rel="external">多说评论迁移至Disqus</a>
&lt;/div&gt;
&lt;!--more--&gt;</p>
<hr>
<p>多说八百年不发邮件通知我有评论，在我换为网易云跟帖后，竟然邮件通知我有评论了！</p>
<p>多说关闭带来的评论区何去何从让我颇为困扰。
现在能用的大概只有这些：畅言（需备案）、网易云跟帖（github.io不支持）、友言（也有倒闭趋势）、来必力（韩国）。</p>
<p>没有一个像多说这样好用的！</p>
<p>虽然多说也有很多问题，但它至少解决了核心问题：
1.评论显示正确的网友名称。
来看看我换上网易云跟帖后的效果：
<img src="http://img.blog.csdn.net/20170405161942419?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="网易云跟帖"></p>
<p>都是有态度网友…… 我压根分不清谁是谁！</p>
<p>2.点击头像可以回访人家的独立博客。
这一点真的很重要，这往往是我们小众的独立博客人交朋友的主要途径啊！</p>
<p>3.可以自定义。
头像旋转、评论框自定义，真的可以很好看。这些跟帖做不到。</p>
<p>4.盖楼模式多样。
而跟帖只能一种，我不太喜欢，重复率太高，我还是喜欢多说的嵌套。</p>
<p>多说名字没起好啊！多说无益必自毙→_→
先换回多说吧，再等一个月看看。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/杂谈/">杂谈</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/多说/">多说</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
	


  
  
</article>









  
    <article id="post-Socket点对点聊天-文件传输" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/05/07/Socket点对点聊天-文件传输/" class="article-date">
      <time datetime="2017-05-07T14:58:30.000Z" itemprop="datePublished">2017-05-07</time>
</a>

 
    <a href="/2017/05/07/Socket点对点聊天-文件传输/#comments" title="查看评论">
        <i class="fa fa-comments-o" aria-hidden="true"></i>
        <span class="count-comment"></span>
        
        
            <span class="disqus-comment-count" data-disqus-identifier="2017/05/07/Socket点对点聊天-文件传输/"></span>
        
    </a>

    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/07/Socket点对点聊天-文件传输/">Socket点对点聊天+文件传输</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>&lt;div align=&quot;left&quot;&gt;
&lt;img src=&quot;https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1494249495796&amp;di=6e913a58ff8ec3713e96983683e150b8&amp;imgtype=0&amp;src=http%3A%2F%2Fimg.my.csdn.net%2Fuploads%2F201304%2F08%2F1365431054_1015.png&quot; width=&quot;300&quot; height=&quot;180&quot; style=&quot;float:right;&quot;/&gt;</p>
<p>Socket编程。</p>
<p>&lt;/div&gt;</p>
<p>&lt;!--more--&gt;
socket:
设计一个点对点聊天小程序。</p>
<ol>
<li>使用原生socket api实现，<strong>即不使用MFC中的socket类</strong>，也不使用其他高级socket框架</li>
<li>需要先设计一套协议</li>
<li>有GUI界面</li>
<li>可互相传递文字和文件</li>
<li>即时反应对方的在线还是离线</li>
</ol>
<h1 id="初级版">初级版</h1>
<p>1.在应用程序类重载的InitInstance函数中调用AfxSocketInit()函数，加载套接字。</p>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(!AfxSocketInit())</div><div class="line">&#123;</div><div class="line">    AfxMessageBox(<span class="string">"加载套接字库失败！"</span>);</div><div class="line">    <span class="keyword">return</span> FALSE;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>2.在你的对话框类中添加如下函数InitSocket()，初始化套接字</p>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">BOOL CChatDlg::InitSocket()</div><div class="line">&#123;</div><div class="line">    m_socket=socket(AF_INET,SOCK_DGRAM,<span class="number">0</span>);</div><div class="line">    <span class="keyword">if</span>(INVALID_SOCKET==m_socket)</div><div class="line">    &#123;</div><div class="line">        MessageBox(<span class="string">"套接字创建失败！"</span>);</div><div class="line">        <span class="keyword">return</span> FALSE;</div><div class="line">    &#125;</div><div class="line">    SOCKADDR_IN addrSock;</div><div class="line">    addrSock.sin_family=AF_INET;</div><div class="line">    addrSock.sin_port=htons(<span class="number">5000</span>);</div><div class="line">    addrSock.sin_addr.S_un.S_addr=htonl(INADDR_ANY);</div><div class="line"> </div><div class="line">    <span class="keyword">int</span> retval;</div><div class="line">    retval=bind(m_socket,(SOCKADDR*)&amp;addrSock,<span class="keyword">sizeof</span>(SOCKADDR));</div><div class="line">    <span class="keyword">if</span>(SOCKET_ERROR==retval)</div><div class="line">    &#123;</div><div class="line">        closesocket(m_socket);</div><div class="line">        MessageBox(<span class="string">"绑定失败!"</span>);</div><div class="line">        <span class="keyword">return</span> FALSE;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> TRUE;</div><div class="line"> </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>3.在对话框类的OnInitDialog()函数中调用上述InitSocket()函数，初始化套接字，同时创建一个线程接收数据：</p>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">RECVPARAM *pRecvParam=<span class="keyword">new</span> RECVPARAM;</div><div class="line">pRecvParam-&gt;sock=m_socket;</div><div class="line">pRecvParam-&gt;hwnd=m_hWnd;</div><div class="line">HANDLE hThread=CreateThread(<span class="literal">NULL</span>,<span class="number">0</span>,RecvProc,(LPVOID)pRecvParam,<span class="number">0</span>,<span class="literal">NULL</span>);</div><div class="line">CloseHandle(hThread);</div></pre></td></tr></table></figure></p>
<p>其中</p>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> RECVPARAM</div><div class="line">&#123;</div><div class="line">    SOCKET sock;</div><div class="line">    HWND hwnd;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>是自定义结构体</p>
<p>4.接收线程函数RecvProc:</p>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">DWORD WINAPI CChatDlg::RecvProc(LPVOID lpParameter)</div><div class="line">&#123;</div><div class="line">    SOCKET sock=((RECVPARAM*)lpParameter)-&gt;sock;</div><div class="line">    HWND hwnd=((RECVPARAM*)lpParameter)-&gt;hwnd;</div><div class="line">    <span class="keyword">delete</span> lpParameter;   </div><div class="line">    SOCKADDR_IN addrFrom;</div><div class="line">    <span class="keyword">int</span> len=<span class="keyword">sizeof</span>(SOCKADDR); </div><div class="line">    <span class="keyword">char</span> recvBuf[<span class="number">200</span>];</div><div class="line">    <span class="keyword">int</span> retval;</div><div class="line">    <span class="keyword">while</span>(TRUE)</div><div class="line">    &#123;</div><div class="line">        retval=recvfrom(sock,recvBuf,<span class="number">200</span>,<span class="number">0</span>,(SOCKADDR*)&amp;addrFrom,&amp;len);</div><div class="line">        <span class="keyword">if</span>(SOCKET_ERROR==retval)</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>recvBuf中就保存了你要的数据。
<img src="http://img.blog.csdn.net/20170508183259821?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="初级版"></p>
<h1 id="中级版">中级版</h1>
<h2 id="界面">界面</h2>
<p><img src="http://img.blog.csdn.net/20170508181716901?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="原始界面"></p>
<p>聊天：
<img src="http://img.blog.csdn.net/20170508181451922?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="TCP"></p>
<p>传文件：
服务器
<img src="http://img.blog.csdn.net/20170508181526914?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="传文件"></p>
<p>客户端
<img src="http://img.blog.csdn.net/20170508181625735?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="传文件2"></p>
<p>显示文件传输进度：
<img src="http://img.blog.csdn.net/20170508181907845?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="传输过程"></p>
<p>传输成功，可以正常打开文件。
<img src="http://img.blog.csdn.net/20170508181937814?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="传输成功"></p>
<p>下线：
<img src="http://img.blog.csdn.net/20170508182031143?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="下线"></p>
<p>关于：
<img src="http://img.blog.csdn.net/20170508182628147?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="关于"></p>
<p>源程序：</p>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div><div class="line">504</div><div class="line">505</div><div class="line">506</div><div class="line">507</div><div class="line">508</div><div class="line">509</div><div class="line">510</div><div class="line">511</div><div class="line">512</div><div class="line">513</div><div class="line">514</div><div class="line">515</div><div class="line">516</div><div class="line">517</div><div class="line">518</div><div class="line">519</div><div class="line">520</div><div class="line">521</div><div class="line">522</div><div class="line">523</div><div class="line">524</div><div class="line">525</div><div class="line">526</div><div class="line">527</div><div class="line">528</div><div class="line">529</div><div class="line">530</div><div class="line">531</div><div class="line">532</div><div class="line">533</div><div class="line">534</div><div class="line">535</div><div class="line">536</div><div class="line">537</div><div class="line">538</div><div class="line">539</div><div class="line">540</div><div class="line">541</div><div class="line">542</div><div class="line">543</div><div class="line">544</div><div class="line">545</div><div class="line">546</div><div class="line">547</div><div class="line">548</div><div class="line">549</div><div class="line">550</div><div class="line">551</div><div class="line">552</div><div class="line">553</div><div class="line">554</div><div class="line">555</div><div class="line">556</div><div class="line">557</div><div class="line">558</div><div class="line">559</div><div class="line">560</div><div class="line">561</div><div class="line">562</div><div class="line">563</div><div class="line">564</div><div class="line">565</div><div class="line">566</div><div class="line">567</div><div class="line">568</div><div class="line">569</div><div class="line">570</div><div class="line">571</div><div class="line">572</div><div class="line">573</div><div class="line">574</div><div class="line">575</div><div class="line">576</div><div class="line">577</div><div class="line">578</div><div class="line">579</div><div class="line">580</div><div class="line">581</div><div class="line">582</div><div class="line">583</div><div class="line">584</div><div class="line">585</div><div class="line">586</div><div class="line">587</div><div class="line">588</div><div class="line">589</div><div class="line">590</div><div class="line">591</div><div class="line">592</div><div class="line">593</div><div class="line">594</div><div class="line">595</div><div class="line">596</div><div class="line">597</div><div class="line">598</div><div class="line">599</div><div class="line">600</div><div class="line">601</div><div class="line">602</div><div class="line">603</div><div class="line">604</div><div class="line">605</div><div class="line">606</div><div class="line">607</div><div class="line">608</div><div class="line">609</div><div class="line">610</div><div class="line">611</div><div class="line">612</div><div class="line">613</div><div class="line">614</div><div class="line">615</div><div class="line">616</div><div class="line">617</div><div class="line">618</div><div class="line">619</div><div class="line">620</div><div class="line">621</div><div class="line">622</div><div class="line">623</div><div class="line">624</div><div class="line">625</div><div class="line">626</div><div class="line">627</div><div class="line">628</div><div class="line">629</div><div class="line">630</div><div class="line">631</div><div class="line">632</div><div class="line">633</div><div class="line">634</div><div class="line">635</div><div class="line">636</div><div class="line">637</div><div class="line">638</div><div class="line">639</div><div class="line">640</div><div class="line">641</div><div class="line">642</div><div class="line">643</div><div class="line">644</div><div class="line">645</div><div class="line">646</div><div class="line">647</div><div class="line">648</div><div class="line">649</div><div class="line">650</div><div class="line">651</div><div class="line">652</div><div class="line">653</div><div class="line">654</div><div class="line">655</div><div class="line">656</div><div class="line">657</div><div class="line">658</div><div class="line">659</div><div class="line">660</div><div class="line">661</div><div class="line">662</div><div class="line">663</div><div class="line">664</div><div class="line">665</div><div class="line">666</div><div class="line">667</div><div class="line">668</div><div class="line">669</div><div class="line">670</div><div class="line">671</div><div class="line">672</div><div class="line">673</div><div class="line">674</div><div class="line">675</div><div class="line">676</div><div class="line">677</div><div class="line">678</div><div class="line">679</div><div class="line">680</div><div class="line">681</div><div class="line">682</div><div class="line">683</div><div class="line">684</div><div class="line">685</div><div class="line">686</div><div class="line">687</div><div class="line">688</div><div class="line">689</div><div class="line">690</div><div class="line">691</div><div class="line">692</div><div class="line">693</div><div class="line">694</div><div class="line">695</div><div class="line">696</div><div class="line">697</div><div class="line">698</div><div class="line">699</div><div class="line">700</div><div class="line">701</div><div class="line">702</div><div class="line">703</div><div class="line">704</div><div class="line">705</div><div class="line">706</div><div class="line">707</div><div class="line">708</div><div class="line">709</div><div class="line">710</div><div class="line">711</div><div class="line">712</div><div class="line">713</div><div class="line">714</div><div class="line">715</div><div class="line">716</div><div class="line">717</div><div class="line">718</div><div class="line">719</div><div class="line">720</div><div class="line">721</div><div class="line">722</div><div class="line">723</div><div class="line">724</div><div class="line">725</div><div class="line">726</div><div class="line">727</div><div class="line">728</div><div class="line">729</div><div class="line">730</div><div class="line">731</div><div class="line">732</div><div class="line">733</div><div class="line">734</div><div class="line">735</div><div class="line">736</div><div class="line">737</div><div class="line">738</div><div class="line">739</div><div class="line">740</div><div class="line">741</div><div class="line">742</div><div class="line">743</div><div class="line">744</div><div class="line">745</div><div class="line">746</div><div class="line">747</div><div class="line">748</div><div class="line">749</div><div class="line">750</div><div class="line">751</div><div class="line">752</div><div class="line">753</div><div class="line">754</div><div class="line">755</div><div class="line">756</div><div class="line">757</div><div class="line">758</div><div class="line">759</div><div class="line">760</div><div class="line">761</div><div class="line">762</div><div class="line">763</div><div class="line">764</div><div class="line">765</div><div class="line">766</div><div class="line">767</div><div class="line">768</div><div class="line">769</div><div class="line">770</div><div class="line">771</div><div class="line">772</div><div class="line">773</div><div class="line">774</div><div class="line">775</div><div class="line">776</div><div class="line">777</div><div class="line">778</div><div class="line">779</div><div class="line">780</div><div class="line">781</div><div class="line">782</div><div class="line">783</div><div class="line">784</div><div class="line">785</div><div class="line">786</div><div class="line">787</div><div class="line">788</div><div class="line">789</div><div class="line">790</div><div class="line">791</div><div class="line">792</div><div class="line">793</div><div class="line">794</div><div class="line">795</div><div class="line">796</div><div class="line">797</div><div class="line">798</div><div class="line">799</div><div class="line">800</div><div class="line">801</div><div class="line">802</div><div class="line">803</div><div class="line">804</div><div class="line">805</div><div class="line">806</div><div class="line">807</div><div class="line">808</div><div class="line">809</div><div class="line">810</div><div class="line">811</div><div class="line">812</div><div class="line">813</div><div class="line">814</div><div class="line">815</div><div class="line">816</div><div class="line">817</div><div class="line">818</div><div class="line">819</div><div class="line">820</div><div class="line">821</div><div class="line">822</div><div class="line">823</div><div class="line">824</div><div class="line">825</div><div class="line">826</div><div class="line">827</div><div class="line">828</div><div class="line">829</div><div class="line">830</div><div class="line">831</div><div class="line">832</div><div class="line">833</div><div class="line">834</div><div class="line">835</div><div class="line">836</div><div class="line">837</div><div class="line">838</div><div class="line">839</div><div class="line">840</div><div class="line">841</div><div class="line">842</div><div class="line">843</div><div class="line">844</div><div class="line">845</div><div class="line">846</div><div class="line">847</div><div class="line">848</div><div class="line">849</div><div class="line">850</div><div class="line">851</div><div class="line">852</div><div class="line">853</div><div class="line">854</div><div class="line">855</div><div class="line">856</div><div class="line">857</div><div class="line">858</div><div class="line">859</div><div class="line">860</div><div class="line">861</div><div class="line">862</div><div class="line">863</div><div class="line">864</div><div class="line">865</div><div class="line">866</div><div class="line">867</div><div class="line">868</div><div class="line">869</div><div class="line">870</div><div class="line">871</div><div class="line">872</div><div class="line">873</div><div class="line">874</div><div class="line">875</div><div class="line">876</div><div class="line">877</div><div class="line">878</div><div class="line">879</div><div class="line">880</div><div class="line">881</div><div class="line">882</div><div class="line">883</div><div class="line">884</div><div class="line">885</div><div class="line">886</div><div class="line">887</div><div class="line">888</div><div class="line">889</div><div class="line">890</div><div class="line">891</div><div class="line">892</div><div class="line">893</div><div class="line">894</div><div class="line">895</div><div class="line">896</div><div class="line">897</div><div class="line">898</div><div class="line">899</div><div class="line">900</div><div class="line">901</div><div class="line">902</div><div class="line">903</div><div class="line">904</div><div class="line">905</div><div class="line">906</div><div class="line">907</div><div class="line">908</div><div class="line">909</div><div class="line">910</div><div class="line">911</div><div class="line">912</div><div class="line">913</div><div class="line">914</div><div class="line">915</div><div class="line">916</div><div class="line">917</div><div class="line">918</div><div class="line">919</div><div class="line">920</div><div class="line">921</div><div class="line">922</div><div class="line">923</div><div class="line">924</div><div class="line">925</div><div class="line">926</div><div class="line">927</div><div class="line">928</div><div class="line">929</div><div class="line">930</div><div class="line">931</div><div class="line">932</div><div class="line">933</div><div class="line">934</div><div class="line">935</div><div class="line">936</div><div class="line">937</div><div class="line">938</div><div class="line">939</div><div class="line">940</div><div class="line">941</div><div class="line">942</div><div class="line">943</div><div class="line">944</div><div class="line">945</div><div class="line">946</div><div class="line">947</div><div class="line">948</div><div class="line">949</div><div class="line">950</div><div class="line">951</div><div class="line">952</div><div class="line">953</div><div class="line">954</div><div class="line">955</div><div class="line">956</div><div class="line">957</div><div class="line">958</div><div class="line">959</div><div class="line">960</div><div class="line">961</div><div class="line">962</div><div class="line">963</div><div class="line">964</div><div class="line">965</div><div class="line">966</div><div class="line">967</div><div class="line">968</div><div class="line">969</div><div class="line">970</div><div class="line">971</div><div class="line">972</div><div class="line">973</div><div class="line">974</div><div class="line">975</div><div class="line">976</div><div class="line">977</div><div class="line">978</div><div class="line">979</div><div class="line">980</div><div class="line">981</div><div class="line">982</div><div class="line">983</div><div class="line">984</div><div class="line">985</div><div class="line">986</div><div class="line">987</div><div class="line">988</div><div class="line">989</div><div class="line">990</div><div class="line">991</div><div class="line">992</div><div class="line">993</div><div class="line">994</div><div class="line">995</div><div class="line">996</div><div class="line">997</div><div class="line">998</div><div class="line">999</div><div class="line">1000</div><div class="line">1001</div><div class="line">1002</div><div class="line">1003</div><div class="line">1004</div><div class="line">1005</div><div class="line">1006</div><div class="line">1007</div><div class="line">1008</div><div class="line">1009</div><div class="line">1010</div><div class="line">1011</div><div class="line">1012</div><div class="line">1013</div><div class="line">1014</div><div class="line">1015</div><div class="line">1016</div><div class="line">1017</div><div class="line">1018</div><div class="line">1019</div><div class="line">1020</div><div class="line">1021</div><div class="line">1022</div><div class="line">1023</div><div class="line">1024</div><div class="line">1025</div><div class="line">1026</div><div class="line">1027</div><div class="line">1028</div><div class="line">1029</div><div class="line">1030</div><div class="line">1031</div><div class="line">1032</div><div class="line">1033</div><div class="line">1034</div><div class="line">1035</div><div class="line">1036</div><div class="line">1037</div><div class="line">1038</div><div class="line">1039</div><div class="line">1040</div><div class="line">1041</div><div class="line">1042</div><div class="line">1043</div><div class="line">1044</div><div class="line">1045</div><div class="line">1046</div><div class="line">1047</div><div class="line">1048</div><div class="line">1049</div><div class="line">1050</div><div class="line">1051</div><div class="line">1052</div><div class="line">1053</div><div class="line">1054</div><div class="line">1055</div><div class="line">1056</div><div class="line">1057</div><div class="line">1058</div><div class="line">1059</div><div class="line">1060</div><div class="line">1061</div><div class="line">1062</div><div class="line">1063</div><div class="line">1064</div><div class="line">1065</div><div class="line">1066</div><div class="line">1067</div><div class="line">1068</div><div class="line">1069</div><div class="line">1070</div><div class="line">1071</div><div class="line">1072</div><div class="line">1073</div><div class="line">1074</div><div class="line">1075</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// traDlg.cpp : implementation file</span></div><div class="line"><span class="comment">//</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdafx.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"tra.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"traDlg.h"</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _DEBUG</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> new DEBUG_NEW</span></div><div class="line"><span class="meta">#<span class="meta-keyword">undef</span> THIS_FILE</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">char</span> THIS_FILE[] = <span class="number">__F</span>ILE__;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dlgs.h&gt;</span></span></div><div class="line"><span class="comment">/////////////////////////////////////////////////////////////////////////////</span></div><div class="line"><span class="comment">// CAboutDlg dialog used for App About</span></div><div class="line"></div><div class="line"><span class="keyword">class</span> CAboutDlg : <span class="keyword">public</span> CDialog</div><div class="line">&#123;</div><div class="line"><span class="keyword">public</span>:</div><div class="line">	CAboutDlg();</div><div class="line">	</div><div class="line">	<span class="comment">// Dialog Data</span></div><div class="line">	<span class="comment">//&#123;&#123;AFX_DATA(CAboutDlg)</span></div><div class="line">	<span class="keyword">enum</span> &#123; IDD = IDD_ABOUTBOX &#125;;</div><div class="line">	<span class="comment">//&#125;&#125;AFX_DATA</span></div><div class="line">	</div><div class="line">	<span class="comment">// ClassWizard generated virtual function overrides</span></div><div class="line">	<span class="comment">//&#123;&#123;AFX_VIRTUAL(CAboutDlg)</span></div><div class="line"><span class="keyword">protected</span>:</div><div class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DoDataExchange</span><span class="params">(CDataExchange* pDX)</span></span>;    <span class="comment">// DDX/DDV support</span></div><div class="line">	<span class="comment">//&#125;&#125;AFX_VIRTUAL</span></div><div class="line">	</div><div class="line">	<span class="comment">// Implementation</span></div><div class="line"><span class="keyword">protected</span>:</div><div class="line">	<span class="comment">//&#123;&#123;AFX_MSG(CAboutDlg)</span></div><div class="line">	<span class="comment">//&#125;&#125;AFX_MSG</span></div><div class="line">	DECLARE_MESSAGE_MAP()</div><div class="line">&#125;;</div><div class="line"></div><div class="line">CAboutDlg::CAboutDlg() : CDialog(CAboutDlg::IDD)</div><div class="line">&#123;</div><div class="line">	<span class="comment">//&#123;&#123;AFX_DATA_INIT(CAboutDlg)</span></div><div class="line">	<span class="comment">//&#125;&#125;AFX_DATA_INIT</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> CAboutDlg::DoDataExchange(CDataExchange* pDX)</div><div class="line">&#123;</div><div class="line">	CDialog::DoDataExchange(pDX);</div><div class="line">	<span class="comment">//&#123;&#123;AFX_DATA_MAP(CAboutDlg)</span></div><div class="line">	<span class="comment">//&#125;&#125;AFX_DATA_MAP</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">BEGIN_MESSAGE_MAP(CAboutDlg, CDialog)</div><div class="line"><span class="comment">//&#123;&#123;AFX_MSG_MAP(CAboutDlg)</span></div><div class="line"><span class="comment">// No message handlers</span></div><div class="line"><span class="comment">//&#125;&#125;AFX_MSG_MAP</span></div><div class="line">END_MESSAGE_MAP()</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/////////////////////////////////////////////////////////////////////////////</span></div><div class="line"><span class="comment">// CtraDlg dialog</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> PORT		34567</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> FLAG		2</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SIZEFILE	1024</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> SOCK_TCP	= <span class="number">0</span>;	<span class="comment">//TCP模式</span></div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> SOCK_UDP  = <span class="number">1</span>;	<span class="comment">//UDP模式</span></div><div class="line"></div><div class="line">CWinThread	*pThreadSendFile;	<span class="comment">//发送文件线程--&gt;_SendFileThread</span></div><div class="line">CWinThread	*pThreadSendMsg;		<span class="comment">//发送消息线程</span></div><div class="line">CWinThread	*pThreadLisen;		<span class="comment">//监听线程--&gt;_ListenTcpThread</span></div><div class="line">CWinThread	*pReceiveThread;		<span class="comment">//接受线程--&gt;_ReceiveThread</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////</span></div><div class="line"></div><div class="line"></div><div class="line">CtraDlg::CtraDlg(CWnd* pParent <span class="comment">/*=NULL*/</span>)</div><div class="line">: CDialog(CtraDlg::IDD, pParent)</div><div class="line">&#123;</div><div class="line">	<span class="comment">//&#123;&#123;AFX_DATA_INIT(CtraDlg)</span></div><div class="line">	m_MsgSend = <span class="number">_</span>T(<span class="string">""</span>);</div><div class="line">	<span class="comment">//&#125;&#125;AFX_DATA_INIT</span></div><div class="line">	<span class="comment">// Note that LoadIcon does not require a subsequent DestroyIcon in Win32</span></div><div class="line">	m_hIcon = AfxGetApp()-&gt;LoadIcon(IDR_MAINFRAME);</div><div class="line">	m_nSockType = <span class="number">0</span>;<span class="comment">//TCP</span></div><div class="line">	m_WorkType = <span class="number">2</span>;<span class="comment">//两者</span></div><div class="line">	m_client = <span class="number">0</span>;</div><div class="line">	m_server = <span class="number">0</span>;</div><div class="line">	FileWork = <span class="literal">false</span>;</div><div class="line">	FileStop = <span class="literal">false</span>;</div><div class="line">	StopServer = <span class="literal">false</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> CtraDlg::DoDataExchange(CDataExchange* pDX)</div><div class="line">&#123;</div><div class="line">	CDialog::DoDataExchange(pDX);</div><div class="line">	<span class="comment">//&#123;&#123;AFX_DATA_MAP(CtraDlg)</span></div><div class="line">	DDX_Control(pDX, IDC_PROGRESS_SEND_FILE, m_Progress);</div><div class="line">	DDX_Control(pDX, IDC_LIST_BOX_ADDMSG, m_AddMsgLIst);</div><div class="line">	DDX_Control(pDX, IDC_IPADDRESS, m_You_IP);</div><div class="line">	DDX_Text(pDX, IDC_EDIT_SENDMSG, m_MsgSend);</div><div class="line">	<span class="comment">//&#125;&#125;AFX_DATA_MAP</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">BEGIN_MESSAGE_MAP(CtraDlg, CDialog)</div><div class="line"><span class="comment">//&#123;&#123;AFX_MSG_MAP(CtraDlg)</span></div><div class="line">ON_WM_SYSCOMMAND()</div><div class="line">ON_WM_PAINT()</div><div class="line">ON_WM_QUERYDRAGICON()</div><div class="line">ON_BN_CLICKED(IDC_BUTTON_CONNECT, OnButtonConnect)</div><div class="line">ON_BN_CLICKED(IDC_BUTTON_DISCONNECT, OnButtonDisconnect)</div><div class="line">ON_BN_CLICKED(IDC_BUTTON_SEND_MSG, OnButtonSendMsg)</div><div class="line">ON_BN_CLICKED(IDC_BUTTON_SEND_FILE, OnButtonSendFile)</div><div class="line">ON_BN_CLICKED(IDC_BUTTON_CLEAR, OnButtonClear)</div><div class="line">ON_BN_CLICKED(IDC_RADIO_TCP, OnRadioTcp)</div><div class="line">ON_BN_CLICKED(IDC_RADIO_UDP, OnRadioUdp)</div><div class="line">ON_BN_CLICKED(IDC_RADIO_SERVER, OnRadioServer)</div><div class="line">ON_BN_CLICKED(IDC_RADIO_CLIENT, OnRadioClient)</div><div class="line">ON_BN_CLICKED(IDC_RADIO_BOTH, OnRadioBoth)</div><div class="line">ON_BN_CLICKED(IDC_BUTTON_STOP_FILE, OnButtonStopFile)</div><div class="line">ON_MESSAGE(WM_KSEND,OnKSend)</div><div class="line"><span class="comment">//ON_BN_CLICKED(IDC_BUTTON_CAPUTER, OnButtonCaputer)</span></div><div class="line"><span class="comment">//&#125;&#125;AFX_MSG_MAP</span></div><div class="line">END_MESSAGE_MAP()</div><div class="line"></div><div class="line"><span class="comment">/////////////////////////////////////////////////////////////////////////////</span></div><div class="line"><span class="comment">// CtraDlg message handlers</span></div><div class="line"></div><div class="line">BOOL CtraDlg::OnInitDialog()</div><div class="line">&#123;</div><div class="line">	CDialog::OnInitDialog();</div><div class="line">	</div><div class="line">	<span class="comment">// Add "About..." menu item to system menu.</span></div><div class="line">	</div><div class="line">	<span class="comment">// IDM_ABOUTBOX must be in the system command range.</span></div><div class="line">	ASSERT((IDM_ABOUTBOX &amp; <span class="number">0xFFF0</span>) == IDM_ABOUTBOX);</div><div class="line">	ASSERT(IDM_ABOUTBOX &lt; <span class="number">0xF000</span>);</div><div class="line">	</div><div class="line">	CMenu* pSysMenu = GetSystemMenu(FALSE);</div><div class="line">	<span class="keyword">if</span> (pSysMenu != <span class="literal">NULL</span>)</div><div class="line">	&#123;</div><div class="line">		CString strAboutMenu;</div><div class="line">		strAboutMenu.LoadString(IDS_ABOUTBOX);</div><div class="line">		<span class="keyword">if</span> (!strAboutMenu.IsEmpty())</div><div class="line">		&#123;</div><div class="line">			pSysMenu-&gt;AppendMenu(MF_SEPARATOR);</div><div class="line">			pSysMenu-&gt;AppendMenu(MF_STRING, IDM_ABOUTBOX, strAboutMenu);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="comment">// Set the icon for this dialog.  The framework does this automatically</span></div><div class="line">	<span class="comment">//  when the application's main window is not a dialog</span></div><div class="line">	SetIcon(m_hIcon, TRUE);			<span class="comment">// Set big icon</span></div><div class="line">	SetIcon(m_hIcon, FALSE);		<span class="comment">// Set small icon</span></div><div class="line">	</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add extra initialization here</span></div><div class="line">	<span class="comment">/////////////////////////////////////////////////////////</span></div><div class="line">	CString strLocalName;</div><div class="line">	GetLocalHostName(strLocalName);</div><div class="line">	CString strLocalIP;</div><div class="line">	GetIpAddress(strLocalName,strLocalIP);</div><div class="line">	m_You_IP.SetWindowText(<span class="string">"127.0.0.1"</span>);	<span class="comment">//设置默认IP</span></div><div class="line">	<span class="comment">/////////////////////////////////////////////////////////</span></div><div class="line">	((CButton*)GetDlgItem(IDC_RADIO_BOTH))-&gt;SetCheck(BST_CHECKED);<span class="comment">//默认为服务器、客户端一体</span></div><div class="line">	SetWindowText(<span class="string">"博靖牌聊天+文件传输小工具"</span>);</div><div class="line"></div><div class="line">	GetDlgItem(IDC_BUTTON_CONNECT)-&gt;SetWindowText(<span class="string">"启动"</span>);</div><div class="line">	GetDlgItem(IDC_BUTTON_DISCONNECT)-&gt;SetWindowText(<span class="string">"关闭"</span>);</div><div class="line">	</div><div class="line">	<span class="comment">//GetDlgItem(IDC_BUTTON_CAPUTER)-&gt;EnableWindow(false);//默认为不可用</span></div><div class="line">	((CButton*)GetDlgItem(IDC_RADIO_TCP))-&gt;SetCheck(BST_CHECKED);<span class="comment">//默认为TCP</span></div><div class="line">	GetDlgItem(IDC_BUTTON_SEND_MSG)-&gt;EnableWindow(<span class="literal">false</span>);<span class="comment">//发送消息不可用</span></div><div class="line">	GetDlgItem(IDC_BUTTON_SEND_FILE)-&gt;EnableWindow(<span class="literal">false</span>);<span class="comment">//发送文件不可用</span></div><div class="line">	GetDlgItem(IDC_BUTTON_CLEAR)-&gt;EnableWindow(<span class="literal">false</span>);<span class="comment">//清除不可用</span></div><div class="line">	GetDlgItem(IDC_BUTTON_DISCONNECT)-&gt;EnableWindow(<span class="literal">false</span>);<span class="comment">//断开连接不可用</span></div><div class="line">	GetDlgItem(IDC_PROGRESS_SEND_FILE)-&gt;ShowWindow(SW_HIDE);</div><div class="line">	<span class="keyword">return</span> TRUE;  <span class="comment">// return TRUE  unless you set the focus to a control</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> CtraDlg::OnSysCommand(UINT nID, LPARAM lParam)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">if</span> ((nID &amp; <span class="number">0xFFF0</span>) == IDM_ABOUTBOX)</div><div class="line">	&#123;</div><div class="line">		CAboutDlg dlgAbout;</div><div class="line">		dlgAbout.DoModal();</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span></div><div class="line">	&#123;</div><div class="line">		CDialog::OnSysCommand(nID, lParam);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// If you add a minimize button to your dialog, you will need the code below</span></div><div class="line"><span class="comment">//  to draw the icon.  For MFC applications using the document/view model,</span></div><div class="line"><span class="comment">//  this is automatically done for you by the framework.</span></div><div class="line"></div><div class="line"><span class="keyword">void</span> CtraDlg::OnPaint() </div><div class="line">&#123;</div><div class="line">	<span class="keyword">if</span> (IsIconic())</div><div class="line">	&#123;</div><div class="line">		<span class="function">CPaintDC <span class="title">dc</span><span class="params">(<span class="keyword">this</span>)</span></span>; <span class="comment">// device context for painting</span></div><div class="line">		</div><div class="line">		SendMessage(WM_ICONERASEBKGND, (WPARAM) dc.GetSafeHdc(), <span class="number">0</span>);</div><div class="line">		</div><div class="line">		<span class="comment">// Center icon in client rectangle</span></div><div class="line">		<span class="keyword">int</span> cxIcon = GetSystemMetrics(SM_CXICON);</div><div class="line">		<span class="keyword">int</span> cyIcon = GetSystemMetrics(SM_CYICON);</div><div class="line">		CRect rect;</div><div class="line">		GetClientRect(&amp;rect);</div><div class="line">		<span class="keyword">int</span> x = (rect.Width() - cxIcon + <span class="number">1</span>) / <span class="number">2</span>;</div><div class="line">		<span class="keyword">int</span> y = (rect.Height() - cyIcon + <span class="number">1</span>) / <span class="number">2</span>;</div><div class="line">		</div><div class="line">		<span class="comment">// Draw the icon</span></div><div class="line">		dc.DrawIcon(x, y, m_hIcon);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span></div><div class="line">	&#123;</div><div class="line">		CDialog::OnPaint();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// The system calls this to obtain the cursor to display while the user drags</span></div><div class="line"><span class="comment">//  the minimized window.</span></div><div class="line">HCURSOR CtraDlg::OnQueryDragIcon()</div><div class="line">&#123;</div><div class="line">	<span class="keyword">return</span> (HCURSOR) m_hIcon;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**************************************线程************************************************/</span></div><div class="line"></div><div class="line"><span class="comment">/******************************服务器线程开始***********************************************/</span></div><div class="line"><span class="comment">//TCP监听线程</span></div><div class="line">UINT <span class="number">_L</span>istenTcpThread(LPVOID lparam)</div><div class="line">&#123;</div><div class="line">	CtraDlg *pDlg=(CtraDlg *)lparam;</div><div class="line">	<span class="keyword">if</span> (pDlg-&gt;StopServer==<span class="literal">true</span>)	</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">	&#125;</div><div class="line">	CSocket sockSrvr;</div><div class="line">	pDlg-&gt;m_Potr = PORT+pDlg-&gt;m_server;<span class="comment">//保存当前使用端口，用于关闭</span></div><div class="line">	<span class="keyword">int</span> createSucceed=sockSrvr.Create(pDlg-&gt;m_Potr);</div><div class="line">	<span class="keyword">if</span> (createSucceed == <span class="number">0</span>)</div><div class="line">	&#123;</div><div class="line">		AfxMessageBox(<span class="string">"ListenTcpThread Create错误!"</span>+pDlg-&gt;GetError(GetLastError()));</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">int</span> listenSucceed=sockSrvr.Listen();	<span class="comment">//开始监听</span></div><div class="line">	<span class="keyword">if</span>(listenSucceed==<span class="number">0</span>)</div><div class="line">	&#123;</div><div class="line">		AfxMessageBox(<span class="string">"ListenTcpThread Listen错误!"</span>+pDlg-&gt;GetError(GetLastError()));</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	CSocket recSo;</div><div class="line">	SOCKADDR_IN client;</div><div class="line">	<span class="keyword">int</span> iAddrSize=<span class="keyword">sizeof</span>(client);</div><div class="line">	</div><div class="line">	<span class="keyword">int</span> acceptSucceed=sockSrvr.Accept(recSo,(SOCKADDR *)&amp;client,&amp;iAddrSize);	<span class="comment">//接受连接并取得对方IP</span></div><div class="line">	<span class="keyword">if</span> (acceptSucceed==<span class="number">0</span>)</div><div class="line">	&#123;</div><div class="line">		AfxMessageBox(<span class="string">"ListenTcpThread Accept错误!"</span>+pDlg-&gt;GetError(GetLastError()));</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">	&#125;</div><div class="line">	sockSrvr.Close();</div><div class="line">	<span class="keyword">char</span> flag[FLAG] = &#123;<span class="number">0</span>&#125;;		</div><div class="line">	<span class="keyword">if</span> (recSo.Receive(flag,FLAG) != <span class="number">2</span>) </div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>;	</div><div class="line">	&#125;</div><div class="line">	pDlg-&gt;m_type=flag[<span class="number">0</span>];</div><div class="line">	<span class="keyword">if</span> (pDlg-&gt;m_type==<span class="string">'D'</span>) </div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line">	pThreadLisen=::AfxBeginThread(<span class="number">_L</span>istenTcpThread,pDlg);</div><div class="line">	pDlg-&gt;ReceiveFileMsg(recSo,client);</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line">UINT <span class="number">_U</span>DPThread(LPVOID lparam)	<span class="comment">//UDP接受信息线程开始</span></div><div class="line">&#123;</div><div class="line">	</div><div class="line">	CtraDlg *pDlg=(CtraDlg *)lparam;</div><div class="line">	<span class="keyword">if</span> (pDlg-&gt;StopServer == <span class="literal">true</span>)	</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	CSocket sockSrvrUdp;</div><div class="line">	sockSrvrUdp.Create(PORT+pDlg-&gt;m_client,SOCK_DGRAM);</div><div class="line">	<span class="keyword">char</span> buff[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</div><div class="line">	<span class="keyword">int</span> ret=<span class="number">0</span>;</div><div class="line">	CString ipStr;</div><div class="line">	CString msg;</div><div class="line">	UINT port;</div><div class="line">	<span class="keyword">for</span>(;;)</div><div class="line">	&#123;</div><div class="line">		</div><div class="line">		ret=sockSrvrUdp.ReceiveFrom(buff,<span class="number">100</span>,ipStr,port);<span class="comment">//IP和port均为返回值</span></div><div class="line">		</div><div class="line">		<span class="keyword">if</span> (buff[<span class="number">0</span>]==<span class="string">'D'</span>) </div><div class="line">		&#123;</div><div class="line">			<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (ret==SOCKET_ERROR) </div><div class="line">		&#123;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">		msg.Format(buff);</div><div class="line">		pDlg-&gt;AddMsgList(ipStr,msg);</div><div class="line">	&#125;</div><div class="line">	sockSrvrUdp.Close();</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">//服务器线程结束</span></div><div class="line"><span class="comment">/*********************************************客户端线程开始*****************************************************/</span></div><div class="line"><span class="comment">//发送文件线程</span></div><div class="line">UINT <span class="number">_</span>SendFileThread(LPVOID lparam)</div><div class="line">&#123;</div><div class="line">	</div><div class="line">	CtraDlg *pDlg = (CtraDlg *)lparam;</div><div class="line">	<span class="keyword">if</span> (pDlg-&gt;StopServer == <span class="literal">true</span>)	</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">	&#125;</div><div class="line">	CSocket sockClient;</div><div class="line">	sockClient.Create();</div><div class="line">	CString ip;</div><div class="line">	pDlg-&gt;m_You_IP.GetWindowText(ip);</div><div class="line">	sockClient.Connect(ip, PORT+pDlg-&gt;m_client); </div><div class="line">	<span class="comment">//首先发送标记F为文件,2</span></div><div class="line">	<span class="keyword">int</span> end = <span class="number">0</span>;</div><div class="line">	end = sockClient.Send(<span class="string">"F"</span>, FLAG);</div><div class="line">	</div><div class="line">	<span class="comment">//发送标志是否成功</span></div><div class="line">	<span class="keyword">if</span> (end == SOCKET_ERROR)										</div><div class="line">	&#123;</div><div class="line">		AfxMessageBox(<span class="string">"_SendFileThread Send错误!"</span>+pDlg-&gt;GetError(GetLastError()));</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (end != <span class="number">2</span>) </div><div class="line">	&#123;</div><div class="line">		AfxMessageBox(<span class="string">"文件头错误！"</span>);</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">///////////////////////////////////////////////////////////////////</span></div><div class="line">	CFile myFile;</div><div class="line">	FILEINFO myFileInfo;</div><div class="line">	<span class="keyword">if</span> (!myFile.Open(pDlg-&gt;m_fileName, CFile::modeRead | CFile::typeBinary))</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">	&#125;</div><div class="line">	myFileInfo.fileLength=myFile.GetLength();		<span class="comment">//得到文件大小</span></div><div class="line">	<span class="built_in">strcpy</span>(myFileInfo.fileName,myFile.GetFileName());<span class="comment">//得到文件名称</span></div><div class="line">	</div><div class="line">	sockClient.Send(&amp;myFileInfo,<span class="keyword">sizeof</span>(myFileInfo));	<span class="comment">//发送文件信息</span></div><div class="line">	</div><div class="line">	pDlg-&gt;m_Progress.SetRange32(<span class="number">0</span>, myFileInfo.fileLength);</div><div class="line">	</div><div class="line">	myFile.Seek(<span class="number">0</span>, CFile::begin);</div><div class="line">	<span class="keyword">char</span> m_buf[SIZEFILE] = &#123;<span class="number">0</span>&#125;;</div><div class="line">	CString strError;</div><div class="line">	<span class="keyword">int</span> num = <span class="number">0</span>;</div><div class="line">	end = <span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> temp = <span class="number">0</span>;</div><div class="line">	pDlg-&gt;GetDlgItem(IDC_BUTTON_STOP_FILE)-&gt;EnableWindow(<span class="literal">true</span>);</div><div class="line">	</div><div class="line">	<span class="keyword">for</span> (;;)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">if</span> (pDlg-&gt;FileWork == <span class="literal">false</span>)</div><div class="line">		&#123;</div><div class="line">			pDlg-&gt;FileWork = <span class="literal">true</span>;</div><div class="line">			pDlg-&gt;GetDlgItem(IDCANCEL)-&gt;EnableWindow(<span class="literal">false</span>);</div><div class="line">			pDlg-&gt;GetDlgItem(IDC_BUTTON_DISCONNECT)-&gt;EnableWindow(<span class="literal">false</span>);</div><div class="line">		&#125;</div><div class="line">		num = myFile.Read(m_buf, SIZEFILE);</div><div class="line">		<span class="keyword">if</span> (num == <span class="number">0</span>) </div><div class="line">		&#123;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">		end = sockClient.Send(m_buf, num); </div><div class="line">		temp += end;</div><div class="line">		pDlg-&gt;m_Progress.SetPos(temp);</div><div class="line">		<span class="keyword">if</span> (pDlg-&gt;FileStop == <span class="literal">true</span>) </div><div class="line">		&#123;</div><div class="line">			pDlg-&gt;FileStop = <span class="literal">false</span>;</div><div class="line">			pDlg-&gt;FileWork = <span class="literal">false</span>;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		<span class="keyword">if</span> (end == SOCKET_ERROR)</div><div class="line">		&#123;</div><div class="line">			AfxMessageBox(<span class="string">"_SendFileThread Send错误!"</span>+pDlg-&gt;GetError(GetLastError()));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">			</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	pDlg-&gt;m_Progress.SetPos(<span class="number">0</span>);</div><div class="line">	CString strLocalName;</div><div class="line">	pDlg-&gt;GetLocalHostName(strLocalName);</div><div class="line">	CString strLocalIP;</div><div class="line">	pDlg-&gt;GetIpAddress(strLocalName,strLocalIP);</div><div class="line">	<span class="keyword">if</span>(temp == myFileInfo.fileLength)</div><div class="line">	&#123;</div><div class="line">		pDlg-&gt;AddMsgList(strLocalName, <span class="string">"文件发送成功！"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span></div><div class="line">	&#123;</div><div class="line">		pDlg-&gt;AddMsgList(strLocalName, <span class="string">"文件发送失败！"</span>);</div><div class="line">	&#125;</div><div class="line">	myFile.Close();</div><div class="line">	sockClient.Close();</div><div class="line">	pDlg-&gt;FileWork = <span class="literal">false</span>;</div><div class="line">	pDlg-&gt;GetDlgItem(IDC_PROGRESS_SEND_FILE)-&gt;ShowWindow(SW_HIDE);</div><div class="line">	pDlg-&gt;GetDlgItem(IDC_BUTTON_STOP_FILE)-&gt;EnableWindow(<span class="literal">false</span>);</div><div class="line"></div><div class="line">	pDlg-&gt;GetDlgItem(IDCANCEL)-&gt;EnableWindow(<span class="literal">true</span>);</div><div class="line">	pDlg-&gt;GetDlgItem(IDC_BUTTON_DISCONNECT)-&gt;EnableWindow(<span class="literal">true</span>);</div><div class="line">	</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">UINT <span class="number">_</span>SendMsgThread(LPVOID lparam)	<span class="comment">//TCP发送信息线程</span></div><div class="line">&#123;</div><div class="line">	</div><div class="line">	CtraDlg *pDlg=(CtraDlg *)lparam;</div><div class="line">	<span class="keyword">if</span> (pDlg-&gt;StopServer == <span class="literal">true</span>)	</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">	&#125;</div><div class="line">	CSocket sockClient;</div><div class="line">	sockClient.Create();</div><div class="line">	CString ip,strError;</div><div class="line">	pDlg-&gt;m_You_IP.GetWindowText(ip);</div><div class="line">	<span class="keyword">int</span> conn = sockClient.Connect(ip, PORT+pDlg-&gt;m_client);</div><div class="line">	<span class="keyword">if</span> (conn == <span class="number">0</span>)</div><div class="line">	&#123;</div><div class="line">		AfxMessageBox(<span class="string">"_SendMsgThread Connect错误!"</span>+pDlg-&gt;GetError(GetLastError()));</div><div class="line">		sockClient.ShutDown(<span class="number">2</span>);</div><div class="line">		sockClient.Close();</div><div class="line">		AfxEndThread(<span class="number">1L</span>);</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">		</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//首先发送标记M为信息,2</span></div><div class="line">	<span class="keyword">int</span> end = <span class="number">0</span>;</div><div class="line">	end = sockClient.Send(<span class="string">"M"</span>,FLAG); </div><div class="line">	<span class="keyword">if</span>(end == SOCKET_ERROR)</div><div class="line">	&#123;</div><div class="line">		AfxMessageBox(<span class="string">"_SendMsgThread Send错误!"</span>+pDlg-&gt;GetError(GetLastError()));</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(end != <span class="number">2</span>)</div><div class="line">	&#123;</div><div class="line">		AfxMessageBox(<span class="string">"消息头错误！"</span>);</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">	&#125;</div><div class="line">	CString strMsg = pDlg-&gt;m_MsgSend;</div><div class="line">	end = sockClient.Send(strMsg,strMsg.GetLength()); </div><div class="line">	<span class="keyword">if</span> (end == SOCKET_ERROR)</div><div class="line">	&#123;</div><div class="line">		AfxMessageBox(<span class="string">"_SendMsgThread Send错误!"</span>+pDlg-&gt;GetError(GetLastError()));</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">	&#125;</div><div class="line">	CString strLocalName;</div><div class="line">	pDlg-&gt;GetLocalHostName(strLocalName);</div><div class="line">	CString strLocalIP;</div><div class="line">	pDlg-&gt;GetIpAddress(strLocalName,strLocalIP);</div><div class="line">	pDlg-&gt;AddMsgList(strLocalName,strMsg);</div><div class="line">	<span class="keyword">int</span> i=<span class="number">0</span>;</div><div class="line">	sockClient.Close();</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">///////////////////////////////////////////////////////////////////</span></div><div class="line">UINT <span class="number">_</span>SendMsgUdpThread(LPVOID lparam)	<span class="comment">//UDP发送信息</span></div><div class="line">&#123;</div><div class="line">	</div><div class="line">	CtraDlg *pDlg = (CtraDlg *)lparam;</div><div class="line">	<span class="keyword">if</span> (pDlg-&gt;StopServer == <span class="literal">true</span>)	</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">	&#125;</div><div class="line">	CSocket sockClientUdp;</div><div class="line">	pDlg-&gt;m_type = PORT+pDlg-&gt;m_client+<span class="number">10</span>;</div><div class="line">	sockClientUdp.Create(pDlg-&gt;m_type, SOCK_DGRAM);</div><div class="line">	CString strMsg = pDlg-&gt;m_MsgSend;</div><div class="line">	<span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line">	CString ipStr;</div><div class="line">	pDlg-&gt;m_You_IP.GetWindowText(ipStr);</div><div class="line">	UINT port = PORT+pDlg-&gt;m_server;</div><div class="line">	ret=sockClientUdp.SendTo(strMsg, strMsg.GetLength(), port, ipStr);</div><div class="line">	<span class="keyword">if</span> (ret == SOCKET_ERROR) </div><div class="line">	&#123;</div><div class="line">		DWORD error = GetLastError();</div><div class="line">		</div><div class="line">	&#125;</div><div class="line">	CString strLocalName;</div><div class="line">	pDlg-&gt;GetLocalHostName(strLocalName);</div><div class="line">	CString strLocalIP;</div><div class="line">	pDlg-&gt;GetIpAddress(strLocalName, strLocalIP);</div><div class="line">	pDlg-&gt;AddMsgList(strLocalName, strMsg);</div><div class="line">	sockClientUdp.Close();</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">	</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/************************************客户端线程结束**********************************/</span></div><div class="line"></div><div class="line"><span class="comment">/*************************************函数****************************************/</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> CtraDlg::ReceiveFileMsg(CSocket &amp;recSo,SOCKADDR_IN &amp;client)<span class="comment">//接受函数</span></div><div class="line">&#123;</div><div class="line">		<span class="keyword">if</span> (m_type == <span class="string">'F'</span>)			<span class="comment">//文件</span></div><div class="line">	&#123;</div><div class="line">		SaveYouFile(recSo, client);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (m_type == <span class="string">'M'</span>)	<span class="comment">//信息</span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">char</span> buff[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</div><div class="line">		CString msg;</div><div class="line">		<span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line">		<span class="keyword">for</span> (;;)</div><div class="line">		&#123;</div><div class="line">			ret = recSo.Receive(buff,<span class="number">100</span>);</div><div class="line">			<span class="keyword">if</span> (ret == <span class="number">0</span>)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">			msg += buff;</div><div class="line">		&#125;</div><div class="line">		CString strOut,strIn;</div><div class="line">		m_You_IP.GetWindowText(strIn);</div><div class="line">		GetNamebyAddress(strIn,strOut);</div><div class="line">		CString youName;</div><div class="line">	<span class="comment">//	youName.Format(inet_ntoa(client.sin_addr));</span></div><div class="line">	<span class="comment">//	CString str = youName+"&lt;-"+strOut;</span></div><div class="line">		CString str = strOut;</div><div class="line">		AddMsgList(str, msg);</div><div class="line">	&#125;</div><div class="line">	recSo.Close();	</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">int</span> CtraDlg::SaveYouFile(CSocket &amp;recSo, SOCKADDR_IN &amp;client)<span class="comment">//接受文件</span></div><div class="line">&#123;</div><div class="line">	CString fname;</div><div class="line">	<span class="function">CFileDialog <span class="title">dlg</span><span class="params">(<span class="literal">false</span>)</span></span>;	<span class="comment">//另存文件</span></div><div class="line">	FILEINFO myFileInfo;</div><div class="line">	recSo.Receive(&amp;myFileInfo, <span class="keyword">sizeof</span>(FILEINFO));</div><div class="line">	<span class="keyword">int</span> fileLength=myFileInfo.fileLength;</div><div class="line">	CString strfileIp,strfileName,strfileLength;</div><div class="line">	strfileIp.Format(inet_ntoa(client.sin_addr));</div><div class="line">	strfileName.Format(myFileInfo.fileName);</div><div class="line">	strfileLength.Format(<span class="string">"%f"</span>, myFileInfo.fileLength/<span class="number">1024.0</span>);</div><div class="line">	CString title = <span class="string">"文件"</span>+strfileName + <span class="string">" 大小"</span> + strfileLength + <span class="string">"KB "</span> + <span class="string">"来自"</span> + strfileIp + <span class="string">" 是否接受？"</span>;</div><div class="line">	dlg.m_ofn.lpstrTitle = title;<span class="comment">//标题条</span></div><div class="line">	<span class="keyword">char</span> fileme[<span class="number">500</span>] = &#123;<span class="number">0</span>&#125;;<span class="comment">//必须足够大小</span></div><div class="line">	<span class="built_in">strcpy</span>(fileme, strfileName);</div><div class="line">	dlg.m_ofn.lpstrFile = fileme;	<span class="comment">//文件名称</span></div><div class="line">	<span class="keyword">if</span> (dlg.DoModal() == IDOK)</div><div class="line">	&#123;</div><div class="line">		fname = dlg.GetPathName();	<span class="comment">//得到文件名名称、路径</span></div><div class="line">		GetDlgItem(IDC_PROGRESS_SEND_FILE)-&gt;ShowWindow(SW_SHOW);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span></div><div class="line">	&#123;</div><div class="line">		GetDlgItem(IDC_PROGRESS_SEND_FILE)-&gt;ShowWindow(SW_HIDE);</div><div class="line">		GetDlgItem(IDC_BUTTON_STOP_FILE)-&gt;EnableWindow(<span class="literal">false</span>);</div><div class="line">		</div><div class="line">		GetDlgItem(IDC_BUTTON_DISCONNECT)-&gt;EnableWindow(<span class="literal">true</span>);</div><div class="line">		GetDlgItem(IDCANCEL)-&gt;EnableWindow(<span class="literal">true</span>);</div><div class="line">		</div><div class="line">		recSo.Close();	</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>;	</div><div class="line">		</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">char</span> buf[SIZEFILE] = &#123;<span class="number">0</span>&#125;;</div><div class="line">	<span class="function">CFile <span class="title">f</span><span class="params">(fname, CFile::modeCreate|CFile::modeWrite)</span></span>;	<span class="comment">//存文件</span></div><div class="line">	</div><div class="line">	m_Progress.SetRange32(<span class="number">0</span>,fileLength);</div><div class="line">	</div><div class="line">	<span class="keyword">int</span> n = <span class="number">0</span>;	<span class="comment">//接受的字节数 0表示结束</span></div><div class="line">	<span class="keyword">int</span> temp = <span class="number">0</span>;</div><div class="line">	GetDlgItem(IDC_BUTTON_STOP_FILE)-&gt;EnableWindow(<span class="literal">true</span>);</div><div class="line">	</div><div class="line">	GetDlgItem(IDCANCEL)-&gt;EnableWindow(<span class="literal">false</span>);</div><div class="line">	GetDlgItem(IDC_BUTTON_DISCONNECT)-&gt;EnableWindow(<span class="literal">false</span>);</div><div class="line">	</div><div class="line">	</div><div class="line">	<span class="keyword">for</span> (;;)</div><div class="line">	&#123;</div><div class="line">		n = recSo.Receive(buf,SIZEFILE);	<span class="comment">//接受</span></div><div class="line">		<span class="keyword">if</span> (n == <span class="number">0</span>)		<span class="comment">//0表示结束</span></div><div class="line">		&#123;</div><div class="line">			<span class="keyword">break</span>;<span class="comment">//接受完毕</span></div><div class="line">		&#125;	</div><div class="line">		f.Write(buf,n);</div><div class="line">		temp += n;</div><div class="line">		m_Progress.SetPos(temp);</div><div class="line">		<span class="keyword">if</span> (FileWork == <span class="literal">false</span>) </div><div class="line">		&#123;</div><div class="line">			FileWork = <span class="literal">true</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (FileStop == <span class="literal">true</span>) </div><div class="line">		&#123;</div><div class="line">			FileStop = <span class="literal">false</span>;</div><div class="line">			FileWork = <span class="literal">false</span>;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">	&#125;</div><div class="line">	f.Close();</div><div class="line">	m_Progress.SetPos(<span class="number">0</span>);</div><div class="line">	<span class="keyword">if</span> (temp == fileLength)</div><div class="line">	&#123;</div><div class="line">		AddMsgList(inet_ntoa(client.sin_addr),<span class="string">"文件接收成功！"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span></div><div class="line">	&#123;</div><div class="line">		AddMsgList(inet_ntoa(client.sin_addr),<span class="string">"文件接收失败！"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	FileWork = <span class="literal">false</span>;</div><div class="line">	GetDlgItem(IDC_PROGRESS_SEND_FILE)-&gt;ShowWindow(SW_HIDE);</div><div class="line">	GetDlgItem(IDC_BUTTON_STOP_FILE)-&gt;EnableWindow(<span class="literal">false</span>);</div><div class="line">	</div><div class="line">	GetDlgItem(IDCANCEL)-&gt;EnableWindow(<span class="literal">true</span>);</div><div class="line">	GetDlgItem(IDC_BUTTON_DISCONNECT)-&gt;EnableWindow(<span class="literal">true</span>);</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/*********************************************按钮*****************************************/</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">void</span> CtraDlg::OnButtonConnect() <span class="comment">//开始连接</span></div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add your control notification handler code here</span></div><div class="line">	CString str;</div><div class="line">	m_You_IP.GetWindowText(str);</div><div class="line">	CString strOut,strIn;</div><div class="line">	m_You_IP.GetWindowText(strIn);</div><div class="line">	<span class="keyword">if</span>(GetNamebyAddress(strIn,strOut) == <span class="number">-1</span>)</div><div class="line">	&#123;</div><div class="line">		GetDlgItem(IDC_BUTTON_CONNECT)-&gt;EnableWindow(<span class="literal">true</span>);<span class="comment">//连接不可用</span></div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//m_MsgSend = "你好" + strOut + "!";</span></div><div class="line">	m_MsgSend =<span class="string">" "</span>;</div><div class="line">	UpdateData(<span class="literal">false</span>);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (m_nSockType == SOCK_TCP)</div><div class="line">	&#123;</div><div class="line">		</div><div class="line">		pThreadLisen=::AfxBeginThread(<span class="number">_L</span>istenTcpThread,<span class="keyword">this</span>);	<span class="comment">//开始TCP线程</span></div><div class="line">		GetDlgItem(IDC_BUTTON_SEND_MSG)-&gt;EnableWindow(<span class="literal">true</span>);<span class="comment">//发送消息可用</span></div><div class="line">		GetDlgItem(IDC_BUTTON_SEND_FILE)-&gt;EnableWindow(<span class="literal">true</span>);<span class="comment">//文件可用</span></div><div class="line">		</div><div class="line">		<span class="comment">//显示上线</span></div><div class="line">		CString strLocalName;</div><div class="line">		GetLocalHostName(strLocalName);</div><div class="line">		AddMsgList(strLocalName, <span class="string">"上线！"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span></div><div class="line">	&#123;</div><div class="line">		pThreadLisen=::AfxBeginThread(<span class="number">_U</span>DPThread,<span class="keyword">this</span>);	<span class="comment">//开始UDP线程</span></div><div class="line">		GetDlgItem(IDC_BUTTON_SEND_MSG)-&gt;EnableWindow(<span class="literal">true</span>);<span class="comment">//发送可用</span></div><div class="line">		GetDlgItem(IDC_BUTTON_SEND_FILE)-&gt;EnableWindow(<span class="literal">false</span>);<span class="comment">//文件不可用</span></div><div class="line"></div><div class="line">		<span class="comment">//显示上线</span></div><div class="line">		CString strLocalName;</div><div class="line">		GetLocalHostName(strLocalName);</div><div class="line">		AddMsgList(strLocalName, <span class="string">"上线！"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	GetDlgItem(IDC_RADIO_TCP)-&gt;EnableWindow(<span class="literal">false</span>);<span class="comment">//单选不可用</span></div><div class="line">	GetDlgItem(IDC_RADIO_UDP)-&gt;EnableWindow(<span class="literal">false</span>);<span class="comment">//单选不可用</span></div><div class="line">	GetDlgItem(IDC_BUTTON_DISCONNECT)-&gt;EnableWindow(<span class="literal">true</span>);<span class="comment">//断开可用</span></div><div class="line">	GetDlgItem(IDC_BUTTON_CONNECT)-&gt;EnableWindow(<span class="literal">false</span>);<span class="comment">//连接不可用</span></div><div class="line">	GetDlgItem(IDC_RADIO_SERVER)-&gt;EnableWindow(<span class="literal">false</span>);</div><div class="line">	GetDlgItem(IDC_RADIO_CLIENT)-&gt;EnableWindow(<span class="literal">false</span>);</div><div class="line">	GetDlgItem(IDC_RADIO_BOTH)-&gt;EnableWindow(<span class="literal">false</span>);</div><div class="line">	GetDlgItem(IDC_IPADDRESS)-&gt;EnableWindow(<span class="literal">false</span>);</div><div class="line"></div><div class="line">	</div><div class="line">	</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> CtraDlg::OnButtonDisconnect() <span class="comment">//关闭</span></div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add your control notification handler code here</span></div><div class="line">	GetDlgItem(IDC_BUTTON_CONNECT)-&gt;EnableWindow(<span class="literal">true</span>);</div><div class="line">	GetDlgItem(IDC_RADIO_TCP)-&gt;EnableWindow(<span class="literal">true</span>);</div><div class="line">	((CButton*)GetDlgItem(IDC_RADIO_UDP))-&gt;EnableWindow(<span class="literal">true</span>);</div><div class="line">	GetDlgItem(IDC_BUTTON_DISCONNECT)-&gt;EnableWindow(<span class="literal">false</span>);</div><div class="line">	GetDlgItem(IDC_BUTTON_SEND_MSG)-&gt;EnableWindow(<span class="literal">false</span>);</div><div class="line">	GetDlgItem(IDC_BUTTON_SEND_FILE)-&gt;EnableWindow(<span class="literal">false</span>);</div><div class="line">	m_AddMsgLIst.ResetContent();</div><div class="line">	GetDlgItem(IDC_BUTTON_CLEAR)-&gt;EnableWindow(<span class="literal">false</span>);</div><div class="line">	((CButton*)GetDlgItem(IDC_RADIO_SERVER))-&gt;EnableWindow(<span class="literal">true</span>);</div><div class="line">	((CButton*)GetDlgItem(IDC_RADIO_CLIENT))-&gt;EnableWindow(<span class="literal">true</span>);</div><div class="line">	((CButton*)GetDlgItem(IDC_RADIO_BOTH))-&gt;EnableWindow(<span class="literal">true</span>);</div><div class="line">	GetDlgItem(IDC_IPADDRESS)-&gt;EnableWindow(<span class="literal">true</span>);</div><div class="line">	m_AddMsgLIst.SendMessage(LB_SETHORIZONTALEXTENT,<span class="number">0</span>,<span class="number">0</span>);</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**********************************************发送结束***********************************************/</span></div><div class="line">	<span class="keyword">if</span>(m_nSockType == SOCK_TCP)</div><div class="line">	&#123;</div><div class="line">		DWORD   dwStatus;</div><div class="line">		<span class="keyword">if</span> (pThreadLisen != <span class="literal">NULL</span>)</div><div class="line">		&#123;</div><div class="line">			<span class="keyword">if</span>(::GetExitCodeThread(pThreadLisen-&gt;m_hThread, &amp;dwStatus)==<span class="number">0</span>)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">int</span> errror = GetLastError();</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (dwStatus == STILL_ACTIVE)</div><div class="line">			&#123;</div><div class="line">				CSocket sockClient;</div><div class="line">				sockClient.Create();</div><div class="line">				CString ip,strError;</div><div class="line">				ip=<span class="string">"127.0.0.1"</span>;</div><div class="line">				<span class="keyword">int</span> conn = sockClient.Connect(ip, m_Potr);</div><div class="line">				<span class="keyword">if</span> (conn == <span class="number">0</span>)	</div><div class="line">				&#123;</div><div class="line">					AfxMessageBox(<span class="string">"关闭错误!"</span>+GetError(GetLastError()));</div><div class="line">					sockClient.ShutDown(<span class="number">2</span>);</div><div class="line">					sockClient.Close();</div><div class="line">					<span class="keyword">return</span>;</div><div class="line">					</div><div class="line">				&#125;</div><div class="line">				sockClient.Send(<span class="string">"D"</span>,FLAG); <span class="comment">//结束</span></div><div class="line">				</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span></div><div class="line">			&#123;</div><div class="line">				<span class="keyword">delete</span> pThreadLisen;</div><div class="line">				pThreadLisen = <span class="literal">NULL</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span></div><div class="line">	&#123;</div><div class="line">		CSocket sockClientUdp;</div><div class="line">		<span class="keyword">int</span> succeedCreate = sockClientUdp.Create(m_type, SOCK_DGRAM);</div><div class="line">		CString strMsg = <span class="string">"D"</span>;</div><div class="line">		<span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line">		CString ipStr;</div><div class="line">		m_You_IP.GetWindowText(ipStr);</div><div class="line">		UINT port = PORT+m_server;</div><div class="line">		ret = sockClientUdp.SendTo(strMsg, <span class="number">1</span>, port, ipStr);</div><div class="line">		</div><div class="line">	&#125;</div><div class="line">		<span class="comment">//显示下线</span></div><div class="line">		CString strLocalName;</div><div class="line">		GetLocalHostName(strLocalName);</div><div class="line">		AddMsgList(strLocalName, <span class="string">"下线！"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> CtraDlg::OnButtonSendMsg() <span class="comment">//发送消息</span></div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add your control notification handler code here</span></div><div class="line">	UpdateData(<span class="literal">true</span>);</div><div class="line">	<span class="keyword">if</span> (m_MsgSend.GetLength() == <span class="number">0</span>) </div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (m_nSockType == SOCK_TCP)</div><div class="line">	&#123;</div><div class="line">		::AfxBeginThread(<span class="number">_</span>SendMsgThread, <span class="keyword">this</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span></div><div class="line">	&#123;	</div><div class="line">		::AfxBeginThread(<span class="number">_</span>SendMsgUdpThread, <span class="keyword">this</span>);</div><div class="line">	&#125;</div><div class="line">	SetDlgItemText(IDC_EDIT_SENDMSG, <span class="string">""</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">void</span> CtraDlg::OnButtonSendFile() <span class="comment">//发送文件</span></div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add your control notification handler code here</span></div><div class="line">	<span class="function">CFileDialog <span class="title">dlg</span><span class="params">(<span class="literal">true</span>)</span></span>;</div><div class="line">	CString ip;</div><div class="line">	m_You_IP.GetWindowText(ip);</div><div class="line">	CString title = <span class="string">"文件发往"</span> + ip + <span class="string">"请选择"</span>;</div><div class="line">	dlg.m_ofn.lpstrTitle = title;<span class="comment">//标题条</span></div><div class="line">	<span class="keyword">if</span> (dlg.DoModal() == IDOK)</div><div class="line">	&#123;</div><div class="line">		m_fileName = dlg.GetPathName();</div><div class="line">		GetDlgItem(IDC_PROGRESS_SEND_FILE)-&gt;ShowWindow(SW_SHOW);</div><div class="line">		pThreadSendFile=::AfxBeginThread(<span class="number">_</span>SendFileThread, <span class="keyword">this</span>);	<span class="comment">//开始传送文件线程</span></div><div class="line">	&#125;</div><div class="line">	</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> CtraDlg::AddMsgList(CString IP,CString str) <span class="comment">//添加信息于LISTBOX 控件中</span></div><div class="line">&#123;</div><div class="line">	SYSTEMTIME tm;</div><div class="line">	GetLocalTime(&amp;tm);</div><div class="line">	CString time;</div><div class="line">	time.Format(<span class="number">_</span>T(<span class="string">" %d:%02.2d "</span>), tm.wHour, tm.wMinute);</div><div class="line">	m_AddMsgLIst.AddString(IP+<span class="string">"("</span>+time+<span class="string">")"</span>+str);</div><div class="line">	<span class="keyword">int</span> numList = m_AddMsgLIst.GetCount()<span class="number">-1</span>;</div><div class="line">	GetDlgItem(IDC_BUTTON_CLEAR)-&gt;EnableWindow(<span class="literal">true</span>);</div><div class="line">	m_AddMsgLIst.SetTopIndex(numList);</div><div class="line">	m_AddMsgLIst.SetCurSel(numList);</div><div class="line">	<span class="comment">//水平滚动</span></div><div class="line">	<span class="keyword">int</span> max_width = <span class="number">0</span>;</div><div class="line">	CSize sz;</div><div class="line">	<span class="function">CClientDC <span class="title">dc</span><span class="params">(<span class="keyword">this</span>)</span></span>;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt;m_AddMsgLIst.GetCount(); i++)</div><div class="line">	&#123;</div><div class="line">		m_AddMsgLIst.GetText(i,str);</div><div class="line">		sz = dc.GetTextExtent(str);</div><div class="line">		<span class="keyword">if</span> (max_width &lt; sz.cx)</div><div class="line">		&#123;</div><div class="line">			max_width = sz.cx;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	m_AddMsgLIst.SendMessage(LB_SETHORIZONTALEXTENT,max_width,<span class="number">0</span>);</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> CtraDlg::OnButtonClear() <span class="comment">//清除聊天内容</span></div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add your control notification handler code here</span></div><div class="line">	m_AddMsgLIst.ResetContent();</div><div class="line">	GetDlgItem(IDC_BUTTON_CLEAR)-&gt;EnableWindow(<span class="literal">false</span>);</div><div class="line">	m_AddMsgLIst.SendMessage(LB_SETHORIZONTALEXTENT,<span class="number">0</span>,<span class="number">0</span>);</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> CtraDlg::OnRadioTcp()		<span class="comment">//选择TCP模式</span></div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add your control notification handler code here</span></div><div class="line">	m_nSockType = SOCK_TCP;</div><div class="line">	CString text;</div><div class="line">	<span class="keyword">if</span> (m_WorkType== <span class="number">0</span>) </div><div class="line">	&#123;</div><div class="line">		text = <span class="string">"服务器"</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (m_WorkType == <span class="number">1</span>) </div><div class="line">	&#123;</div><div class="line">		text = <span class="string">"客户端"</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span> </div><div class="line">	&#123;</div><div class="line">		text = <span class="string">"小工具"</span>;</div><div class="line">	&#125;</div><div class="line">	SetWindowText(text + <span class="string">"TCP方式"</span>);</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> CtraDlg::OnRadioUdp()		<span class="comment">//选择UDP模式</span></div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add your control notification handler code here</span></div><div class="line">	m_nSockType = SOCK_UDP;</div><div class="line">	CString text;</div><div class="line">	<span class="keyword">if</span> (m_WorkType == <span class="number">0</span>) </div><div class="line">	&#123;</div><div class="line">		text = <span class="string">"服务器"</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (m_WorkType == <span class="number">1</span>) </div><div class="line">	&#123;</div><div class="line">		text = <span class="string">"客户端"</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span> </div><div class="line">	&#123;</div><div class="line">		text = <span class="string">"小工具"</span>;</div><div class="line">	&#125;</div><div class="line">	SetWindowText(text + <span class="string">"UDP方式"</span>);</div><div class="line"></div><div class="line">	</div><div class="line">&#125;</div><div class="line"></div><div class="line">CString CtraDlg::GetError(DWORD error)	<span class="comment">//返回错误信息</span></div><div class="line">&#123;</div><div class="line">	CString strError;</div><div class="line">	<span class="keyword">switch</span>(error)</div><div class="line">	&#123;</div><div class="line">	<span class="keyword">case</span> WSANOTINITIALISED:</div><div class="line">		strError = <span class="string">"初始化错误"</span>;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> WSAENOTCONN:</div><div class="line">		strError = <span class="string">"对方没有启动"</span>;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> WSAEWOULDBLOCK :</div><div class="line">		strError = <span class="string">"对方已经关闭"</span>;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> WSAECONNREFUSED:</div><div class="line">		strError = <span class="string">"连接的尝试被拒绝"</span>;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> WSAENOTSOCK:</div><div class="line">		strError = <span class="string">"在一个非套接字上尝试了一个操作"</span>;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> WSAEADDRINUSE:</div><div class="line">		strError = <span class="string">"特定的地址已在使用中"</span>;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> WSAECONNRESET:</div><div class="line">		strError = <span class="string">"与主机的连接被关闭"</span>;</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		strError = <span class="string">"一般错误"</span>;	</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> strError;</div><div class="line">	</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">int</span> CtraDlg::GetLocalHostName(CString &amp;sHostName)	<span class="comment">//获得本地计算机名称</span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">char</span> szHostName[<span class="number">256</span>];</div><div class="line">	<span class="keyword">int</span> nRetCode;</div><div class="line">	nRetCode = gethostname(szHostName,<span class="keyword">sizeof</span>(szHostName));</div><div class="line">	<span class="keyword">if</span>(nRetCode!=<span class="number">0</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="comment">//产生错误</span></div><div class="line">		sHostName = <span class="number">_</span>T(<span class="string">"获取不到主机名！"</span>);</div><div class="line">		<span class="keyword">return</span> GetLastError();</div><div class="line">	&#125;</div><div class="line">	sHostName = szHostName;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">int</span> CtraDlg::GetIpAddress(<span class="keyword">const</span> CString &amp;sHostName, CString &amp;sIpAddress)<span class="comment">//获得本地IP</span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">struct</span> hostent FAR * lpHostEnt=gethostbyname(sHostName);</div><div class="line">	<span class="keyword">if</span>(lpHostEnt==<span class="literal">NULL</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="comment">//产生错误</span></div><div class="line">		sIpAddress = <span class="number">_</span>T(<span class="string">""</span>);</div><div class="line">		<span class="keyword">return</span> GetLastError();</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//获取IP</span></div><div class="line">	LPSTR lpAddr = lpHostEnt-&gt;h_addr_list[<span class="number">0</span>];</div><div class="line">	<span class="keyword">if</span>(lpAddr)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">struct</span> in_addr inAddr;</div><div class="line">		memmove(&amp;inAddr, lpAddr, <span class="number">4</span>);</div><div class="line">		<span class="comment">//转换为标准格式</span></div><div class="line">		sIpAddress = inet_ntoa(inAddr);</div><div class="line">		<span class="keyword">if</span> (sIpAddress.IsEmpty())</div><div class="line">		&#123;</div><div class="line">			sIpAddress = <span class="number">_</span>T(<span class="string">"获取不到IP！"</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">int</span> CtraDlg::GetNamebyAddress(<span class="keyword">const</span> CString &amp;IpAddress,CString &amp;sYouName)<span class="comment">//获得对方计算机名称</span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> addr;</div><div class="line">	addr = inet_addr(IpAddress);</div><div class="line">	<span class="keyword">struct</span> hostent FAR * lpHostEnt = gethostbyaddr((<span class="keyword">char</span> *)&amp;addr, <span class="number">4</span>, AF_INET);</div><div class="line">	<span class="keyword">if</span> (lpHostEnt == <span class="literal">NULL</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="comment">//产生错误</span></div><div class="line">		sYouName = <span class="number">_</span>T(<span class="string">""</span>);</div><div class="line"></div><div class="line">		AfxMessageBox(<span class="string">"无法连接！"</span>);<span class="comment">//应该取得其错误</span></div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">	&#125;</div><div class="line">	CString name = lpHostEnt-&gt;h_name;</div><div class="line">	sYouName = name;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> CtraDlg::OnRadioServer() </div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add your control notification handler code here</span></div><div class="line">	CString text;</div><div class="line">	<span class="keyword">if</span> (m_nSockType == SOCK_TCP) </div><div class="line">	&#123;</div><div class="line">		text = <span class="string">"TCP方式"</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span> </div><div class="line">	&#123;</div><div class="line">		text = <span class="string">"UDP方式"</span>;</div><div class="line">	&#125;</div><div class="line">	m_server = <span class="number">1</span>;</div><div class="line">	m_client = <span class="number">2</span>;</div><div class="line">	m_WorkType = <span class="number">0</span>;</div><div class="line">	SetWindowText(<span class="string">"服务器 "</span> + text);</div><div class="line">	GetDlgItem(IDC_BUTTON_CONNECT)-&gt;SetWindowText(<span class="string">"启动服务"</span>);</div><div class="line">	GetDlgItem(IDC_BUTTON_DISCONNECT)-&gt;SetWindowText(<span class="string">"关闭服务"</span>);</div><div class="line">	</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> CtraDlg::OnRadioClient() </div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add your control notification handler code here</span></div><div class="line">	CString text;</div><div class="line">	<span class="keyword">if</span> (m_nSockType == SOCK_TCP) </div><div class="line">	&#123;</div><div class="line">		text = <span class="string">"TCP方式"</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span> </div><div class="line">	&#123;</div><div class="line">		text = <span class="string">"UDP方式"</span>;</div><div class="line">	&#125;</div><div class="line">	m_server = <span class="number">2</span>;</div><div class="line">	m_client = <span class="number">1</span>;</div><div class="line">	m_WorkType = <span class="number">1</span>;</div><div class="line">	SetWindowText(<span class="string">"客户端 "</span> + text);</div><div class="line">	GetDlgItem(IDC_BUTTON_CONNECT)-&gt;SetWindowText(<span class="string">"连接"</span>);</div><div class="line">	GetDlgItem(IDC_BUTTON_DISCONNECT)-&gt;SetWindowText(<span class="string">"断开连接"</span>);</div><div class="line">	</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> CtraDlg::OnRadioBoth() </div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add your control notification handler code here</span></div><div class="line">	CString text;</div><div class="line">	<span class="keyword">if</span> (m_nSockType == SOCK_TCP) </div><div class="line">	&#123;</div><div class="line">		text = <span class="string">"TCP方式"</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span> </div><div class="line">	&#123;</div><div class="line">		text = <span class="string">"UDP方式"</span>;</div><div class="line">	&#125;</div><div class="line">	m_server = m_client = <span class="number">0</span>;</div><div class="line">	m_WorkType = <span class="number">2</span>;</div><div class="line">	SetWindowText(text);</div><div class="line">	GetDlgItem(IDC_BUTTON_CONNECT)-&gt;SetWindowText(<span class="string">"启动"</span>);</div><div class="line">	GetDlgItem(IDC_BUTTON_DISCONNECT)-&gt;SetWindowText(<span class="string">"关闭"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> CtraDlg::OnButtonStopFile() </div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add your control notification handler code here</span></div><div class="line">	FileStop = <span class="literal">true</span>;</div><div class="line">	FileWork = <span class="literal">false</span>;</div><div class="line">	GetDlgItem(IDCANCEL)-&gt;EnableWindow(<span class="literal">true</span>);</div><div class="line">	GetDlgItem(IDC_BUTTON_DISCONNECT)-&gt;EnableWindow(<span class="literal">true</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">LRESULT CtraDlg::OnKSend(WPARAM wParam,LPARAM lParam)</div><div class="line">&#123;</div><div class="line">	OnButtonSendMsg();</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">BOOL CtraDlg::PreTranslateMessage(MSG* pMsg) </div><div class="line">&#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add your specialized code here and/or call the base class</span></div><div class="line">	<span class="keyword">if</span> (pMsg-&gt;message == WM_KEYDOWN &amp;&amp; pMsg-&gt;wParam == VK_RETURN)</div><div class="line">	&#123;	</div><div class="line">		<span class="keyword">if</span> (GetFocus()-&gt;GetDlgCtrlID()==IDC_EDIT_SENDMSG || GetFocus()-&gt;GetDlgCtrlID()==IDC_BUTTON_SEND_MSG)</div><div class="line">		&#123;</div><div class="line">			AfxGetMainWnd()-&gt;SendMessage(WM_KSEND);</div><div class="line">			<span class="keyword">return</span> TRUE;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> CDialog::PreTranslateMessage(pMsg);</div><div class="line"></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// traDlg.h : header file</span></div><div class="line"><span class="comment">//</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(AFX_traDLG_H__F42FE5AC_E2CC_44AB_9D0A_748191BC989F__INCLUDED_)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> AFX_traDLG_H__F42FE5AC_E2CC_44AB_9D0A_748191BC989F__INCLUDED_</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> _MSC_VER &gt; 1000</span></div><div class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// _MSC_VER &gt; 1000</span></span></div><div class="line"></div><div class="line"><span class="comment">//#include "ColorListBox.h"</span></div><div class="line"><span class="comment">/////////////////////////////////////////////////////////////////////////////</span></div><div class="line"><span class="comment">// CtraDlg dialog</span></div><div class="line"></div><div class="line"><span class="keyword">class</span> CtraDlg : <span class="keyword">public</span> CDialog</div><div class="line">&#123;</div><div class="line"><span class="comment">// Construction</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">	CtraDlg(CWnd* pParent = <span class="literal">NULL</span>);	<span class="comment">// standard constructor</span></div><div class="line"></div><div class="line"><span class="comment">// Dialog Data</span></div><div class="line">	<span class="comment">//&#123;&#123;AFX_DATA(CtraDlg)</span></div><div class="line">	<span class="keyword">enum</span> &#123; IDD = IDD_tra_DIALOG &#125;;</div><div class="line">	CProgressCtrl	m_Progress;</div><div class="line">	CListBox	m_AddMsgLIst;</div><div class="line">	CIPAddressCtrl	m_You_IP;</div><div class="line">	CString	m_MsgSend;</div><div class="line">	<span class="comment">//&#125;&#125;AFX_DATA</span></div><div class="line"></div><div class="line">	<span class="comment">// ClassWizard generated virtual function overrides</span></div><div class="line">	<span class="comment">//&#123;&#123;AFX_VIRTUAL(CtraDlg)</span></div><div class="line">	<span class="keyword">public</span>:</div><div class="line">	<span class="function"><span class="keyword">virtual</span> BOOL <span class="title">PreTranslateMessage</span><span class="params">(MSG* pMsg)</span></span>;</div><div class="line">	<span class="keyword">protected</span>:</div><div class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DoDataExchange</span><span class="params">(CDataExchange* pDX)</span></span>;	<span class="comment">// DDX/DDV support</span></div><div class="line">	<span class="comment">//&#125;&#125;AFX_VIRTUAL</span></div><div class="line"></div><div class="line"><span class="comment">// Implementation</span></div><div class="line"><span class="keyword">protected</span>:</div><div class="line">	HICON m_hIcon;</div><div class="line"></div><div class="line">	<span class="comment">// Generated message map functions</span></div><div class="line">	<span class="comment">//&#123;&#123;AFX_MSG(CtraDlg)</span></div><div class="line">	<span class="function"><span class="keyword">virtual</span> BOOL <span class="title">OnInitDialog</span><span class="params">()</span></span>;</div><div class="line">	<span class="function">afx_msg <span class="keyword">void</span> <span class="title">OnSysCommand</span><span class="params">(UINT nID, LPARAM lParam)</span></span>;</div><div class="line">	<span class="function">afx_msg <span class="keyword">void</span> <span class="title">OnPaint</span><span class="params">()</span></span>;</div><div class="line">	<span class="function">afx_msg HCURSOR <span class="title">OnQueryDragIcon</span><span class="params">()</span></span>;</div><div class="line">	<span class="function">afx_msg <span class="keyword">void</span> <span class="title">OnButtonConnect</span><span class="params">()</span></span>;</div><div class="line">	<span class="function">afx_msg <span class="keyword">void</span> <span class="title">OnButtonDisconnect</span><span class="params">()</span></span>;</div><div class="line">	<span class="function">afx_msg <span class="keyword">void</span> <span class="title">OnButtonSendMsg</span><span class="params">()</span></span>;</div><div class="line">	<span class="function">afx_msg <span class="keyword">void</span> <span class="title">OnButtonSendFile</span><span class="params">()</span></span>;</div><div class="line">	<span class="function">afx_msg <span class="keyword">void</span> <span class="title">OnButtonClear</span><span class="params">()</span></span>;</div><div class="line">	<span class="function">afx_msg <span class="keyword">void</span> <span class="title">OnRadioTcp</span><span class="params">()</span></span>;</div><div class="line">	<span class="function">afx_msg <span class="keyword">void</span> <span class="title">OnRadioUdp</span><span class="params">()</span></span>;</div><div class="line">	<span class="function">afx_msg <span class="keyword">void</span> <span class="title">OnRadioServer</span><span class="params">()</span></span>;</div><div class="line">	<span class="function">afx_msg <span class="keyword">void</span> <span class="title">OnRadioClient</span><span class="params">()</span></span>;</div><div class="line">	<span class="function">afx_msg <span class="keyword">void</span> <span class="title">OnRadioBoth</span><span class="params">()</span></span>;</div><div class="line">	<span class="function">afx_msg <span class="keyword">void</span> <span class="title">OnButtonStopFile</span><span class="params">()</span></span>;</div><div class="line">	<span class="function">afx_msg LRESULT <span class="title">OnKSend</span><span class="params">(WPARAM wParam,LPARAM lParam)</span></span>;<span class="comment">//发送消息</span></div><div class="line">	<span class="comment">//afx_msg void OnButtonCaputer();</span></div><div class="line">	<span class="comment">//&#125;&#125;AFX_MSG</span></div><div class="line">	DECLARE_MESSAGE_MAP()</div><div class="line"></div><div class="line"><span class="keyword">public</span>:</div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">SaveYouFile</span><span class="params">(CSocket &amp;recSo,SOCKADDR_IN &amp;client)</span></span>;</div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">ReceiveFileMsg</span><span class="params">(CSocket &amp; socket,SOCKADDR_IN &amp;client)</span></span>;</div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">GetIpAddress</span><span class="params">(<span class="keyword">const</span> CString &amp; sHostName,CString &amp; sIpAddress)</span></span>;</div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">GetLocalHostName</span><span class="params">(CString &amp;sHostName)</span></span>;</div><div class="line">	<span class="function">CString <span class="title">GetError</span><span class="params">(DWORD error)</span></span>;</div><div class="line">	<span class="keyword">int</span>	m_nSockType;	<span class="comment">//连接类型</span></div><div class="line">	<span class="keyword">int</span> m_WorkType;		<span class="comment">//工作方式 server0,client1,both2</span></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">AddMsgList</span><span class="params">(CString IP, CString str)</span></span>; <span class="comment">//LISTBOX控件添加信息</span></div><div class="line">	<span class="keyword">int</span> m_client, m_server;</div><div class="line">	CString m_fileName;</div><div class="line">	<span class="keyword">bool</span> FileWork, FileStop, StopServer;</div><div class="line">	<span class="keyword">char</span> m_type;<span class="comment">//接受类型/F-文件，C-抓平，D-关闭,M-消息</span></div><div class="line">	<span class="keyword">int</span> m_Potr;<span class="comment">//当前使用端口</span></div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">GetNamebyAddress</span><span class="params">(<span class="keyword">const</span> CString &amp;IpAddress,CString &amp;sYouName)</span></span>;<span class="comment">//获得对方计算机名称</span></div><div class="line"></div><div class="line">&#125;;</div><div class="line"><span class="keyword">struct</span> FILEINFO</div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> fileLength;</div><div class="line">	<span class="keyword">char</span> fileName[<span class="number">100</span>];</div><div class="line"></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">//&#123;&#123;AFX_INSERT_LOCATION&#125;&#125;</span></div><div class="line"><span class="comment">// Microsoft Visual C++ will insert additional declarations immediately before the previous line.</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// !defined(AFX_traDLG_H__F42FE5AC_E2CC_44AB_9D0A_748191BC989F__INCLUDED_)</span></span></div></pre></td></tr></table></figure></p>
<hr>
<h1 id="参考资料">参考资料</h1>
<p>网上的资料，查到的大部分都是用的MFC的socket类做的……</p>
<p>高级版→→→→
1.<a href="https://wenku.baidu.com/view/69afd693dd88d0d233d46a49.html" target="_blank" rel="external">基于MFC仿QQ聊天程序设计完整实例教程</a>
2.<a href="http://blog.csdn.net/akof1314/article/details/5983443" target="_blank" rel="external">CRichEditCtrlEx支持静态表情聊天类的使用</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/互联网/">互联网</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/">C++</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MFC/">MFC</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/socket/">socket</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
	


  
  
</article>









  
    <article id="post-ContentProvider记录" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/05/05/ContentProvider记录/" class="article-date">
      <time datetime="2017-05-05T14:00:42.000Z" itemprop="datePublished">2017-05-05</time>
</a>

 
    <a href="/2017/05/05/ContentProvider记录/#comments" title="查看评论">
        <i class="fa fa-comments-o" aria-hidden="true"></i>
        <span class="count-comment"></span>
        
        
            <span class="disqus-comment-count" data-disqus-identifier="2017/05/05/ContentProvider记录/"></span>
        
    </a>

    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/05/ContentProvider记录/">四大组件之ContentProvider记录</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>&lt;div align=&quot;left&quot;&gt;
&lt;img src=&quot;https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1493829797406&amp;di=c1112aa632e463c9a69b23a84b37c681&amp;imgtype=0&amp;src=http%3A%2F%2Fs15.sinaimg.cn%2Fmiddle%2F448dd084gaa5d8b13a09e%26690&quot; width=&quot;300&quot; height=&quot;180&quot; style=&quot;float:right;&quot;/&gt;</p>
<p>ContentProvider记录。</p>
<p>&lt;/div&gt;</p>
<p>&lt;!--more--&gt;</p>
<p>数据存储方式：</p>
<ul>
<li>Shared Preferences</li>
<li>文件存储</li>
<li>SQLite</li>
<li>其他还有网络存储等</li>
</ul>
<p>上述不可完成的任务：都只是在单独的一个应用程序之中达到一个数据的共享</p>
<p><img src="http://img.blog.csdn.net/20170505230346413?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="ContentProvider">
<img src="http://img.blog.csdn.net/20170505230425672?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="Uri">
<img src="http://img.blog.csdn.net/20170505230442148?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHVib2ppbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="UriMatcher类"></p>
<h1 id="contentprovider">ContentProvider</h1>
<ol>
<li>使用 ContentResolver 操作 ContentProvider 中的数据：
当外部应用需要对 ContentProvider 中的数据进行增删改查的时候，可以使用 ContentResolver 类来完成。</li>
<li>使用 Activity 提供的 getContentResolver() 方法获取 ContentResolver 对象。</li>
<li>ContentResolver 类提供了与 ContentProvider 类相同签名的四个方法：</li>
</ol>
<ul>
<li>public Uri insert(Uri uri,ContentValues values)
该方法用于往ContentProvider里面添加数据</li>
<li>public int delete(Uri uri,String selection,String[] selectionArgs)
该方法从ContentProvider中删除数据</li>
<li>public int update(Uri uri,ContentValues values,String selection,String[] selectionArgs)
该方法用于更新ContentProvider里面的数据</li>
<li>public Cursor query(Uri uri,String[] projection,String selection,String[] selectionArgs,String sortOrder)
该方法用于从ContentProvider中获取数据</li>
</ul>
<h1 id="使用系统提供的contentprovider">使用系统提供的ContentProvider</h1>
<h2 id="查询联系人">查询联系人</h2>
<p>MyContentProvider.java</p>
<p><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">package com<span class="selector-class">.abc</span><span class="selector-class">.contentproviderdemo1</span>;</div><div class="line"></div><div class="line">import android<span class="selector-class">.content</span><span class="selector-class">.ContentProvider</span>;</div><div class="line">import android<span class="selector-class">.content</span><span class="selector-class">.ContentValues</span>;</div><div class="line">import android<span class="selector-class">.database</span><span class="selector-class">.Cursor</span>;</div><div class="line">import android<span class="selector-class">.net</span><span class="selector-class">.Uri</span>;</div><div class="line"></div><div class="line"><span class="selector-tag">public</span> <span class="selector-tag">class</span> <span class="selector-tag">MyContentProvider</span> <span class="selector-tag">extends</span> <span class="selector-tag">ContentProvider</span> &#123;</div><div class="line"></div><div class="line">	<span class="variable">@Override</span> <span class="comment">// 在ContentProvider创建后被调用</span></div><div class="line">	public boolean onCreate() &#123;</div><div class="line">		<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">		return false;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="variable">@Override</span> <span class="comment">// 根据uri查询出selection指定的条件所匹配的全部记录，并且可以指定查询哪些列 以什么方式（order）排序</span></div><div class="line">	public Cursor query(Uri uri, String[] projection, String selection, String[] selectionArgs, String sortOrder) &#123;</div><div class="line">		<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">		return null;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="variable">@Override</span> <span class="comment">// 返回当前uri的MIME类型，如果该URI对应的数据可能包括多条记录</span></div><div class="line">	<span class="comment">// 如果该URI对应的数据只有一条记录 该MIME类型字符串 就是以vnd.android.cursor.item/开头</span></div><div class="line">	public String getType(Uri uri) &#123;</div><div class="line">		<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">		return null;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="variable">@Override</span> <span class="comment">// 根据uri插入Values对应的数据</span></div><div class="line">	public Uri insert(Uri uri, ContentValues values) &#123;</div><div class="line">		<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">		return null;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="variable">@Override</span> <span class="comment">// 根据Uri删除selection指定的条件所匹配的全部记录</span></div><div class="line">	public int delete(Uri uri, String selection, String[] selectionArgs) &#123;</div><div class="line">		<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">		return 0;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="variable">@Override</span> <span class="comment">// 根据uri修改selection指定的条件所匹配的全部记录</span></div><div class="line">	public int update(Uri uri, ContentValues values, String selection, String[] selectionArgs) &#123;</div><div class="line">		<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">		return 0;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>MainActivity.java</p>
<p><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.abc.contentproviderdemo1;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.app.<span class="type">Activity</span>;</div><div class="line"><span class="keyword">import</span> android.content.<span class="type">ContentResolver</span>;</div><div class="line"><span class="keyword">import</span> android.database.<span class="type">Cursor</span>;</div><div class="line"><span class="keyword">import</span> android.os.<span class="type">Bundle</span>;</div><div class="line"><span class="keyword">import</span> android.provider.<span class="type">ContactsContract</span>.<span class="type">CommonDataKinds</span>.<span class="type">Email</span>;</div><div class="line"><span class="keyword">import</span> android.provider.<span class="type">ContactsContract</span>.<span class="type">CommonDataKinds</span>.<span class="type">Phone</span>;</div><div class="line"><span class="keyword">import</span> android.provider.<span class="type">ContactsContract</span>.<span class="type">Contacts</span>;</div><div class="line"><span class="keyword">import</span> android.util.<span class="type">Log</span>;</div><div class="line"></div><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="keyword">protected</span> void onCreate(<span class="type">Bundle</span> savedInstanceState) &#123;</div><div class="line">		<span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">		setContentView(<span class="type">R</span>.layout.activity_main);</div><div class="line"></div><div class="line">		<span class="type">ContentResolver</span> cr = getContentResolver();</div><div class="line">		<span class="type">Cursor</span> c = cr.query(<span class="type">Contacts</span>.<span class="type">CONTENT_URI</span>, <span class="keyword">new</span> <span class="type">String</span>[] &#123; <span class="type">Contacts</span>._ID, <span class="type">Contacts</span>.<span class="type">DISPLAY_NAME</span> &#125;, <span class="literal">null</span>, <span class="literal">null</span>,</div><div class="line">				<span class="literal">null</span>);</div><div class="line">		<span class="keyword">if</span> (c != <span class="literal">null</span>) &#123;</div><div class="line">			<span class="keyword">while</span> (c.moveToNext()) &#123;</div><div class="line">				int id = c.getInt(c.getColumnIndex(<span class="string">"_id"</span>));</div><div class="line">				<span class="type">Log</span>.i(<span class="string">"info"</span>, <span class="string">"_id"</span> + id);</div><div class="line">				<span class="type">Log</span>.i(<span class="string">"info"</span>, <span class="string">"name:"</span> + c.getString(c.getColumnIndex(<span class="string">"display_name"</span>)));</div><div class="line">				<span class="type">Cursor</span> c1 = cr.query(<span class="type">Phone</span>.<span class="type">CONTENT_URI</span>, <span class="keyword">new</span> <span class="type">String</span>[] &#123; <span class="type">Phone</span>.<span class="type">NUMBER</span>, <span class="type">Phone</span>.<span class="type">TYPE</span> &#125;,</div><div class="line">						<span class="type">Phone</span>.<span class="type">CONTACT_ID</span> + <span class="string">"="</span> + id, <span class="literal">null</span>, <span class="literal">null</span>);</div><div class="line">				<span class="comment">// 根据联系人ID查询出联系人的电话号码</span></div><div class="line">				<span class="keyword">if</span> (c1 != <span class="literal">null</span>) &#123;</div><div class="line">					<span class="keyword">while</span> (c1.moveToNext()) &#123;</div><div class="line">						int <span class="class"><span class="keyword">type</span> </span>= c1.getInt(c1.getColumnIndex(<span class="type">Phone</span>.<span class="type">TYPE</span>));</div><div class="line">						<span class="keyword">if</span> (<span class="class"><span class="keyword">type</span> <span class="title">==</span> <span class="title">Phone</span>.<span class="title">TYPE_HOME</span>) </span>&#123;</div><div class="line">							<span class="type">Log</span>.i(<span class="string">"info"</span>, <span class="string">"家庭电话："</span> + c1.getString(c1.getColumnIndex(<span class="type">Phone</span>.<span class="type">NUMBER</span>)));</div><div class="line">						&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="class"><span class="keyword">type</span> <span class="title">==</span> <span class="title">Phone</span>.<span class="title">TYPE_MOBILE</span>) </span>&#123;</div><div class="line">							<span class="type">Log</span>.i(<span class="string">"info"</span>, <span class="string">"手机"</span> + c1.getString(c1.getColumnIndex(<span class="type">Phone</span>.<span class="type">NUMBER</span>)));</div><div class="line">						&#125;</div><div class="line">					&#125;</div><div class="line">					c1.close();</div><div class="line">				&#125;</div><div class="line">				<span class="comment">// 根据联系人的ID去查询出联系人的邮箱地址</span></div><div class="line">				<span class="type">Cursor</span> c2 = cr.query(<span class="type">Email</span>.<span class="type">CONTENT_URI</span>, <span class="keyword">new</span> <span class="type">String</span>[] &#123; <span class="type">Email</span>.<span class="type">DATA</span>, <span class="type">Email</span>.<span class="type">TYPE</span> &#125;,</div><div class="line">						<span class="type">Email</span>.<span class="type">CONTACT_ID</span> + <span class="string">"="</span> + id, <span class="literal">null</span>, <span class="literal">null</span>);</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (c2 != <span class="literal">null</span>) &#123;</div><div class="line">					<span class="keyword">while</span> (c2.moveToNext()) &#123;</div><div class="line">						int <span class="class"><span class="keyword">type</span> </span>= c2.getInt(c2.getColumnIndex(<span class="type">Email</span>.<span class="type">TYPE</span>));</div><div class="line">						<span class="keyword">if</span> (<span class="class"><span class="keyword">type</span> <span class="title">==</span> <span class="title">Email</span>.<span class="title">TYPE_WORK</span>) </span>&#123;</div><div class="line">							<span class="type">Log</span>.i(<span class="string">"info"</span>, <span class="string">"工作邮箱："</span> + c2.getString(c2.getColumnIndex(<span class="type">Email</span>.<span class="type">DATA</span>)));</div><div class="line">						&#125;</div><div class="line">					&#125;</div><div class="line">					c2.close();</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			c.close();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>AndroidManifest.xml注册</p>
<p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;uses-permission android:<span class="built_in">name</span>=<span class="string">"android.permission.READ_CONTACTS"</span>/&gt;</div></pre></td></tr></table></figure></p>
<h2 id="增加联系人">增加联系人</h2>
<p>MainActivity.java</p>
<p><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">package com<span class="selector-class">.abc</span><span class="selector-class">.contentproviderdemo2</span>;</div><div class="line"></div><div class="line">import android<span class="selector-class">.app</span><span class="selector-class">.Activity</span>;</div><div class="line">import android<span class="selector-class">.content</span><span class="selector-class">.ContentResolver</span>;</div><div class="line">import android<span class="selector-class">.content</span><span class="selector-class">.ContentUris</span>;</div><div class="line">import android<span class="selector-class">.content</span><span class="selector-class">.ContentValues</span>;</div><div class="line">import android<span class="selector-class">.net</span><span class="selector-class">.Uri</span>;</div><div class="line">import android<span class="selector-class">.os</span><span class="selector-class">.Bundle</span>;</div><div class="line">import android<span class="selector-class">.provider</span><span class="selector-class">.ContactsContract</span><span class="selector-class">.CommonDataKinds</span><span class="selector-class">.Phone</span>;</div><div class="line">import android<span class="selector-class">.provider</span><span class="selector-class">.ContactsContract</span><span class="selector-class">.CommonDataKinds</span><span class="selector-class">.StructuredName</span>;</div><div class="line">import android<span class="selector-class">.provider</span><span class="selector-class">.ContactsContract</span><span class="selector-class">.Data</span>;</div><div class="line">import android<span class="selector-class">.provider</span><span class="selector-class">.ContactsContract</span><span class="selector-class">.RawContacts</span>;</div><div class="line"></div><div class="line"><span class="selector-tag">public</span> <span class="selector-tag">class</span> <span class="selector-tag">MainActivity</span> <span class="selector-tag">extends</span> <span class="selector-tag">Activity</span> &#123;</div><div class="line"></div><div class="line">	<span class="variable">@Override</span></div><div class="line">	protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">		super<span class="selector-class">.onCreate</span>(savedInstanceState);</div><div class="line">		setContentView(R<span class="selector-class">.layout</span><span class="selector-class">.activity_main</span>);</div><div class="line">		ContentResolver cr = getContentResolver();</div><div class="line">		<span class="comment">// 向联系人中插入一行数据</span></div><div class="line">		ContentValues values = new ContentValues();</div><div class="line">		Uri uri = cr<span class="selector-class">.insert</span>(RawContacts.CONTENT_URI, values);</div><div class="line">		Long raw_contact_id = ContentUris<span class="selector-class">.parseId</span>(uri);</div><div class="line">		values<span class="selector-class">.clear</span>();</div><div class="line">		values<span class="selector-class">.put</span>(StructuredName.RAW_CONTACT_ID, raw_contact_id);</div><div class="line">		values<span class="selector-class">.put</span>(StructuredName.DISPLAY_NAME, <span class="string">"胡博靖"</span>);</div><div class="line">		values<span class="selector-class">.put</span>(StructuredName.MIMETYPE, StructuredName.CONTENT_ITEM_TYPE);</div><div class="line">		uri = cr<span class="selector-class">.insert</span>(Data.CONTENT_URI, values);</div><div class="line">		<span class="comment">// 插入电话信息</span></div><div class="line">		values<span class="selector-class">.clear</span>();</div><div class="line">		values<span class="selector-class">.put</span>(Phone.RAW_CONTACT_ID, raw_contact_id);</div><div class="line">		values<span class="selector-class">.put</span>(Phone.NUMBER, <span class="string">"12345678910"</span>);</div><div class="line">		values<span class="selector-class">.put</span>(Phone.MIMETYPE, Phone.CONTENT_ITEM_TYPE);</div><div class="line">		uri = cr<span class="selector-class">.insert</span>(Data.CONTENT_URI, values);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在AndroidManifest.xml中注册</p>
<p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;uses-permission android:<span class="built_in">name</span>=<span class="string">"android.permission.WRITE_CONTACTS"</span>/&gt;</div></pre></td></tr></table></figure></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/互联网/">互联网</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
	


  
  
</article>









  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2015-2017 胡博靖
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span> | </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit" title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>


    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 19;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>


    

    
        <script id="dsq-count-scr" src="//hubojing.disqus.com/count.js" async></script>
        <script>
            if ($(".left-col").is(":visible")) {
                var $disqusCount = $(".disqus-comment-count");
                $disqusCount.bind("DOMNodeInserted", function(e) {
                    var num = $(this).text().replace(/[^0-9]/ig,"");
                    if (num > 0) {
                        $(this).siblings(".count-comment").text(num);
                    }
                    $(this).remove();
                })
            } else {
                $(".disqus-comment-count").remove();
            }
        </script>
     




<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

    <script>
        var originTitle = document.title;
        var titleTime;
        document.addEventListener("visibilitychange", function() {
            if (document.hidden) {
                document.title = "(つェ⊂) 我藏好了哦~ " + originTitle;
                clearTimeout(titleTime);
            }
            else {
                document.title = "(*´∇｀*) 被你发现啦~ " + originTitle;
                titleTime = setTimeout(function() {
                    document.title = originTitle;
                }, 2000);
            }
        })
    </script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>